<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™œë™ ìˆ˜ê¸° ë“±ë¡ - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* ê¸°ì¡´ ê¸°ëŠ¥ë“¤ê³¼ ì¼ê´€ëœ í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
            width: 100%;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" patternUnits="userSpaceOnUse" width="100" height="100"><circle cx="50" cy="50" r="1" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header-content {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .user-info {
            flex: 1;
        }

        .user-info h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .user-info p {
            font-size: 1.1rem;
            opacity: 0.95;
            max-width: 600px;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-shrink: 0;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s ease;
            line-height: 1.4;
            white-space: nowrap;
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        /* ë°˜ì‘í˜• í—¤ë” */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 0 1rem;
            }

            .user-info h1 {
                font-size: 2rem;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.9rem;
            }

            .header-content {
                padding: 0 0.5rem;
            }
        }

        /* í…ìŠ¤íŠ¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .textarea-container {
            position: relative;
        }

        .char-counter {
            position: absolute;
            right: 12px;
            bottom: 12px;
            font-size: 0.875rem;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.9);
        }

        .char-counter.valid {
            color: #059669;
            border: 1px solid #059669;
        }

        .char-counter.invalid {
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        /* ì‚¬ì§„ ì—…ë¡œë“œ ì˜ì—­ */
        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .photo-upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .photo-upload-area.dragover {
            border-color: #3b82f6;
            background: #dbeafe;
        }

        /* ì‚¬ì§„ ì¸ë„¤ì¼ ê·¸ë¦¬ë“œ */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .photo-delete-btn:hover {
            background: rgba(220, 38, 38, 1);
            transform: scale(1.1);
        }

        /* íŒŒíŠ¸ í—¤ë” */
        .part-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .part-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .part-header p {
            color: #6b7280;
            font-size: 0.95rem;
        }

        /* ìƒíƒœ ë°°ì§€ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.submitted {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-badge.approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        /* ì¶”ê°€ ë¯¸ë””ì–´ URL ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
        .save-url-btn {
            padding: 10px 20px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .save-url-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .save-url-btn:active {
            transform: translateY(0);
        }

        .save-url-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .optional-tag {
            font-size: 0.8em;
            color: #6b7280;
            font-weight: normal;
            margin-left: 5px;
        }

        .url-status {
            margin-top: 8px;
            font-size: 0.9em;
            min-height: 20px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-content">
            <div class="user-info">
                <h1 id="pageTitle">í™œë™ ìˆ˜ê¸° ë“±ë¡</h1>
                <p id="pageSubtitle">ë¬¸í™”ì¸í„´ í™œë™ì„ ë§ˆë¬´ë¦¬í•˜ë©° ì†Œì¤‘í•œ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”</p>
            </div>
            <div class="header-actions">
                <button id="backBtn" class="btn secondary">
                    <i data-lucide="arrow-left"></i>
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>
    </header>

    <!-- ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
    <div class="bg-white border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-700">ì‘ì„± ì§„í–‰ë¥ :</span>
                    <div class="flex-1 h-2 w-64 bg-gray-200 rounded-full">
                        <div id="progressBar" class="h-2 bg-green-600 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <span id="progressText" class="text-sm font-semibold text-gray-900">0%</span>
                </div>
                <div id="statusBadge" class="status-badge draft">
                    <i data-lucide="file-edit"></i>
                    <span>ì‘ì„±ì¤‘</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Messages -->
    <div id="alert-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-6"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
        
        <!-- íŒŒíŠ¸ 1: ê¸°ë³¸ì •ë³´ -->
        <section class="bg-white rounded-lg shadow-sm border">
            <div class="part-header">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div>
                        <h2>ê¸°ë³¸ì •ë³´</h2>
                        <p>ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¨ ê¸°ë³¸ ì •ë³´ë¥¼ í™•ì¸í•˜ê³  ì£¼ìš” í™œë™ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-6">
                <!-- ìë™ ë¶ˆëŸ¬ì˜¤ëŠ” ì •ë³´ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì„±ëª…</label>
                        <input type="text" id="studentName" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì†Œì†ëŒ€í•™</label>
                        <input type="text" id="university" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì „ê³µ</label>
                        <input type="text" id="major" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">íŒŒê²¬ ì„¸ì¢…í•™ë‹¹</label>
                        <input type="text" id="institute" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">í™œë™ ë¶„ì•¼</label>
                        <input type="text" id="activityField" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ìµœì¢… í™œë™ ë¶„ì•¼ <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="finalActivityField" maxlength="200"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                               placeholder="ê²°ê³¼ë³´ê³ ì„œ ì‘ì„± ì‹œ ê¸°ì¬í•œ ìµœì¢… í™œë™ ë¶„ì•¼ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”.">
                    </div>                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">í™œë™ ê¸°ê°„</label>
                        <input type="text" id="activityPeriod" readonly 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
                    </div>
                </div>

                <!-- í•™ìƒì´ ì§ì ‘ ì‘ì„±í•˜ëŠ” í•­ëª© -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ì£¼ìš” í™œë™ ë‚´ìš© <span class="text-red-500">*</span>
                    </label>
                    <p class="text-sm text-gray-500 mb-3">
                        ë¬¸í™”ì¸í„´ìœ¼ë¡œì„œ ìˆ˜í–‰í•œ ì£¼ìš” í™œë™ë“¤ì„ ê°„ëµíˆ ìš”ì•½í•´ì£¼ì„¸ìš”
                    </p>
                    <div class="textarea-container">
                        <textarea id="mainActivities" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                  placeholder="ì˜ˆ: í•œêµ­ì–´ ë¬¸í™” ìˆ˜ì—… ì§„í–‰, í•œêµ­ ì „í†µë¬¸í™” ì²´í—˜ í”„ë¡œê·¸ë¨ ê¸°íš ë° ìš´ì˜, í•™ë‹¹ í–‰ì‚¬ ì§€ì› ë“±"></textarea>
                        <div class="char-counter invalid">
                            <span id="mainActivitiesCounter">0</span>ì
                        </div>
                    </div>
                </div>

                <!-- ì„ì‹œì €ì¥ ë²„íŠ¼ -->
                <div class="flex justify-end">
                    <button id="saveDraftBtn1" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>ì„ì‹œì €ì¥
                    </button>
                </div>
            </div>
        </section>
        <!-- íŒŒíŠ¸ 2: í˜„ì§€ ì •ì°© ì •ë³´ -->
        <section class="bg-white rounded-lg shadow-sm border">
            <div class="part-header">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="map-pin" class="w-5 h-5 text-purple-600"></i>
                    </div>
                    <div>
                        <h2>í˜„ì§€ ì •ì°© ì •ë³´</h2>
                        <p>í›„ë°° ë¬¸í™”ì¸í„´ë“¤ì´ í˜„ì§€ ìƒí™œì„ ì¤€ë¹„í•˜ëŠ”ë° ë„ì›€ì´ ë  ì •ë³´ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-8">
                
                <!-- 1. ë¹„ìë°œê¸‰ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        1. ë¹„ìë°œê¸‰ <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="visaInfo" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="ë°œê¸‰ë°›ì€ ë¹„ì ì¢…ë¥˜ ë° ë¹„ì ë°œê¸‰ ê³¼ì •ì—ì„œ ì•Œì•„ì•¼í•  ì •ë³´(ë°œê¸‰ ì ˆì°¨, í•„ìš” ì„œë¥˜, ì†Œìš” ê¸°ê°„, ì£¼ì˜ì‚¬í•­ ë“±)ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="visaInfoCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 2. ê±°ì£¼ì§€ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        2. ê±°ì£¼ì§€ <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="accommodationInfo" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="ê±°ì£¼í•˜ì‹  ê³³ì˜ íŠ¹ì§• ë° ìˆ™ì†Œë¥¼ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ êµ¬í–ˆëŠ”ì§€ ê´€ë ¨í•œ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. &#10;- ìˆ™ì†Œ í˜•íƒœ(ê¸°ìˆ™ì‚¬/ì›ë£¸ ë“±), ì°¾ì€ ë°©ë²•, ë¹„ìš©, ìœ„ì¹˜, ì‹œì„¤, ì¥ë‹¨ì  ë“±"></textarea>
                        <div class="char-counter invalid">
                            <span id="accommodationInfoCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 3. êµí†µ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        3. êµí†µ <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="transportationInfo" rows="5"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="í•™ë‹¹ ì¶œí‡´ê·¼ê³¼ ê´€ë ¨í•˜ì—¬ ì£¼ë¡œ ì´ìš©í•œ êµí†µìˆ˜ë‹¨ ë“±ì— ëŒ€í•´ ì ì–´ì£¼ì„¸ìš”. &#10;- ì£¼ìš” êµí†µìˆ˜ë‹¨, êµí†µë¹„, ì†Œìš” ì‹œê°„, êµí†µ ê´€ë ¨ íŒ ë“±"></textarea>
                        <div class="char-counter">
                            <span id="transportationInfoCounter">0</span>ì
                        </div>
                    </div>
                </div>

                <!-- 4. ì¶œêµ­ ì „ ì¤€ë¹„ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        4. ì¶œêµ­ ì „ ì¤€ë¹„ <span class="text-red-500">*</span>
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        
                    </p>
                    <div class="textarea-container">
                        <textarea id="preparationInfo" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="í˜„ì§€ ìƒí™œê³¼ ê´€ë ¨í•´, ì¶œêµ­ ì „ì— ë¯¸ë¦¬ ì¤€ë¹„í•˜ë©´ ì¢‹ì„ ë‚´ìš©ì— ëŒ€í•´ ì ì–´ì£¼ì„¸ìš”. &#10;- ì¤€ë¹„ë¬¼, ì‚¬ì „ í•™ìŠµ, ì˜ˆë°©ì ‘ì¢…, í˜„ì§€ í†µì‹ , í™˜ì „ ë“±"></textarea>
                        <div class="char-counter invalid">
                            <span id="preparationInfoCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 5. í˜„ì§€ ìƒí™œ ê´€ë ¨ ì°¸ê³  ì‚¬í•­ -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        5. í˜„ì§€ ìƒí™œ ê´€ë ¨ ì°¸ê³  ì‚¬í•­ <span class="text-red-500">*</span>
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                        
                    </p>
                    <div class="textarea-container">
                        <textarea id="livingTips" rows="6"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                                  placeholder="í˜„ì§€ì—ì„œ ìƒí™œí•  ë•Œ ë„ì›€ì´ ë  ë§Œí•œ ì •ë³´, ë˜ëŠ” ìœ ì˜í•´ì•¼í•  ì‚¬í•­(í˜„ì§€ ë¬¸í™”, ê´€ìŠµ, ì•ˆì „, ë‚ ì”¨, ìƒí™œ íŒ ë“±)ì´ ìˆë‹¤ë©´ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter">
                            <span id="livingTipsCounter">0</span>ì
                        </div>
                    </div>
                </div>

                <!-- ëŒ€í‘œ ì‚¬ì§„ ë“±ë¡ -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            ê´€ë ¨ ì‚¬ì§„ ë“±ë¡
                        </label>
                        <span id="settlementPhotoCount" class="text-sm text-gray-500">0 / 5</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        â€» ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤. í•´ë‹¹ ì‚¬ì§„ ë“±ë¡ì€ í•„ìˆ˜ ì‚¬í•­ì€ ì•„ë‹™ë‹ˆë‹¤.
                    </p>
                    
                    <div id="settlementPhotoUploadArea" class="photo-upload-area">
                        <i data-lucide="image-plus" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                        <p class="text-sm font-medium text-gray-700 mb-1">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="text-xs text-gray-500">JPG, PNG íŒŒì¼ (ê° ìµœëŒ€ 15MB)</p>
                    </div>
                    <input type="file" id="settlementPhotoInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="hidden">
                    
                    <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ -->
                    <div id="settlementPhotoGrid" class="photo-grid"></div>
                </div>

                <!-- ì„ì‹œì €ì¥ ë²„íŠ¼ -->
                <div class="flex justify-end">
                    <button id="saveDraftBtn2" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>ì„ì‹œì €ì¥
                    </button>
                </div>
            </div>
        </section>
        <!-- íŒŒíŠ¸ 3: ìˆ˜ì—… ì •ë³´ -->
        <section class="bg-white rounded-lg shadow-sm border">
            <div class="part-header">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="book-open" class="w-5 h-5 text-orange-600"></i>
                    </div>
                    <div>
                        <h2>ìˆ˜ì—… ì •ë³´</h2>
                        <p>ì§„í–‰í•œ ë¬¸í™”ìˆ˜ì—…ì— ëŒ€í•œ ê²½í—˜ê³¼ ë…¸í•˜ìš°ë¥¼ ê³µìœ í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-8">
                
                <!-- 1. íŒŒê²¬ ì„¸ì¢…í•™ë‹¹ì—ì„œ ì–´ë–¤ ìˆ˜ì—…ì„ ì§„í–‰í•˜ì…¨ë‚˜ìš”? -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        1. íŒŒê²¬ ì„¸ì¢…í•™ë‹¹ì—ì„œ ì–´ë–¤ ìˆ˜ì—…ì„ ì§„í–‰í•˜ì…¨ë‚˜ìš”? <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="classDescription" rows="7"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"
                                  placeholder="ë‹´ë‹¹ ìˆ˜ì—… ì£¼ì œ, ëŒ€ìƒ í•™ìŠµì, ìˆ˜ì—… ë¹ˆë„, ì¤€ë¹„ ê³¼ì •, í•™ë‹¹ê³¼ì˜ ì»¤ë¦¬í˜ëŸ¼ ì¡°ìœ¨ ê³¼ì •, ìˆ˜ì—… ê²°ê³¼ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="classDescriptionCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 2. í™œë™ ê¸°ê°„ ì¤‘ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆ˜ì—…ì´ ìˆì—ˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”? -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        2. í™œë™ ê¸°ê°„ ì¤‘ ê°€ì¥ ê¸°ì–µì— ë‚¨ëŠ” ìˆ˜ì—…ì´ ìˆì—ˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”? <span class="text-red-500">*</span>
                    </label>

                    <div class="textarea-container">
                        <textarea id="memorableClass" rows="7"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"
                                  placeholder="ìˆ˜ì—… ì£¼ì œ, ì¸ìƒ ê¹Šì—ˆë˜ ì´ìœ , í•™ìƒë“¤ì˜ ë°˜ì‘, íŠ¹ë³„í•œ ì—í”¼ì†Œë“œ, ëŠë‚€ ë³´ëŒ ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="memorableClassCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 3. ìˆ˜ì—…ì„ ì¤€ë¹„ ë˜ëŠ” ì§„í–‰í•˜ë©´ì„œ ê²ªì€ ì–´ë ¤ì› ë˜ ì , ê·¸ê²ƒì„ ê·¹ë³µí•œ ë°©ë²•ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”? -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        3. ìˆ˜ì—…ì„ ì¤€ë¹„ ë˜ëŠ” ì§„í–‰í•˜ë©´ì„œ ê²ªì€ ì–´ë ¤ì› ë˜ ì , ê·¸ê²ƒì„ ê·¹ë³µí•œ ë°©ë²•ì€ ë¬´ì—‡ì´ì—ˆë‚˜ìš”? <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="challengesSolutions" rows="7"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent resize-none"
                                  placeholder="ìˆ˜ì—…ì„ ì¤€ë¹„í•˜ê±°ë‚˜ ì§„í–‰í•˜ë©´ì„œ ì–´ë ¤ì› ë˜ ì ì´ ìˆì—ˆë‹¤ë©´ êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì‹œê³ , ê·¸ ì–´ë ¤ì›€ì„ í•´ê²°í•˜ê¸° ìœ„í•´ ì‹œë„í•œ ë°©ë²•ê³¼ ê·¹ë³µ ê³¼ì • ë“±ì„ ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="challengesSolutionsCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- ëŒ€í‘œ ì‚¬ì§„ ë“±ë¡ -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            ê´€ë ¨ ì‚¬ì§„ ë“±ë¡
                        </label>
                        <span id="classPhotoCount" class="text-sm text-gray-500">0 / 5</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        â€» ë³¸ì¸ì˜ í™œë™ì„ ì˜ ë³´ì—¬ì¤„ ìˆ˜ ìˆëŠ” ëŒ€í‘œ ì‚¬ì§„ì„ ìµœì†Œ 3ê°œ ì´ìƒ í•„ìˆ˜ë¡œ ë“±ë¡í•˜ì—¬ ì£¼ì„¸ìš”. ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                    
                    <div id="classPhotoUploadArea" class="photo-upload-area">
                        <i data-lucide="image-plus" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                        <p class="text-sm font-medium text-gray-700 mb-1">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="text-xs text-gray-500">JPG, PNG íŒŒì¼ (ê° ìµœëŒ€ 15MB)</p>
                    </div>
                    <input type="file" id="classPhotoInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="hidden">
                    
                    <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ -->
                    <div id="classPhotoGrid" class="photo-grid"></div>
                </div>

                <!-- ì„ì‹œì €ì¥ ë²„íŠ¼ -->
                <div class="flex justify-end">
                    <button id="saveDraftBtn3" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>ì„ì‹œì €ì¥
                    </button>
                </div>
            </div>
        </section>
        <!-- íŒŒíŠ¸ 4: í™œë™ ì†Œê° -->
        <section class="bg-white rounded-lg shadow-sm border">
            <div class="part-header">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-pink-100 rounded-lg flex items-center justify-center">
                        <i data-lucide="heart" class="w-5 h-5 text-pink-600"></i>
                    </div>
                    <div>
                        <h2>í™œë™ ì†Œê°</h2>
                        <p>ë¬¸í™”ì¸í„´ í™œë™ì„ ë§ˆë¬´ë¦¬í•˜ë©° ëŠë‚€ ì ê³¼ í›„ë°°ë“¤ì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë§ì„ ê³µìœ í•´ì£¼ì„¸ìš”</p>
                    </div>
                </div>
            </div>
            <div class="p-6 space-y-8">
                
                <!-- 1. ë¬¸í™”ì¸í„´ í™œë™ì„ ë§ˆì¹˜ë©°, ê·¸ ì†Œê°ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´? -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        1. ë¬¸í™”ì¸í„´ í™œë™ì„ ë§ˆì¹˜ë©°, ê·¸ ì†Œê°ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•œë‹¤ë©´? ê·¸ë ‡ê²Œ í‘œí˜„í•œ ì´ìœ ëŠ” ë¬´ì—‡ì¸ê°€ìš”? <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="oneSentenceSummary" rows="8"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                                  placeholder="ë¬¸í™”ì¸í„´ í™œë™ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•˜ì—¬ ì£¼ì‹œê³  (ì˜ˆ: ë‚˜ì—ê²Œ ë¬¸í™”ì¸í„´ì€ _________ë‹¤), ê·¸ë ‡ê²Œ í‘œí˜„í•œ ì‚¬ìœ ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. &#10;&#10;ì „ì²´ ì¸í„´ í™œë™ì„ ë§ˆë¬´ë¦¬í•˜ë©° ëŠë‚€ì , ê°€ì¥ ë³´ëŒ ìˆì—ˆë˜ ìˆœê°„, ë³¸ì¸ì˜ ë³€í™”ë‚˜ ì„±ì¥ ë“±ì„ ììœ ë¡­ê²Œ ì¨ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="oneSentenceSummaryCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- 2. ë¯¸ë˜ì˜ ë¬¸í™”ì¸í„´ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ ì¡°ì–¸ì´ ìˆë‹¤ë©´? -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        2. ë¯¸ë˜ì˜ ë¬¸í™”ì¸í„´ì—ê²Œ í•´ì£¼ê³  ì‹¶ì€ ì¡°ì–¸ì´ ìˆë‹¤ë©´ ë¬´ì—‡ì¸ê°€ìš”? <span class="text-red-500">*</span>
                    </label>
                    
                    <div class="textarea-container">
                        <textarea id="adviceForFuture" rows="8"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-transparent resize-none"
                                  placeholder="ì•ì„œ ì‘ì„±í•œ í˜„ì§€ ì •ì°© ì •ë³´, ìˆ˜ì—… ì •ë³´ ë“±ì„ ì¢…í•©í•˜ì—¬ ë¬¸í™”ì¸í„´ í›„ë°°ê°€ í™œë™í•  ë•Œ ì‹¤ì œë¡œ ë„ì›€ì´ ë  ìˆ˜ ìˆëŠ” í˜„ì¥í˜• ì¡°ì–¸ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”."></textarea>
                        <div class="char-counter invalid">
                            <span id="adviceForFutureCounter">0</span> / ìµœì†Œ 300ì
                        </div>
                    </div>
                </div>

                <!-- ëŒ€í‘œ ì‚¬ì§„ ë“±ë¡ -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <label class="block text-sm font-medium text-gray-900">
                            ê´€ë ¨ ì‚¬ì§„ ë“±ë¡
                        </label>
                        <span id="reflectionPhotoCount" class="text-sm text-gray-500">0 / 5</span>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">
                        â€» ë¬¸í™”ì¸í„´ í™œë™ì˜ ì˜ë¯¸ ìˆëŠ” ìˆœê°„ë“¤ì„ ë‹´ì€ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”. ìµœëŒ€ 5ê°œê¹Œì§€ ë“±ë¡ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                    </p>
                    
                    <div id="reflectionPhotoUploadArea" class="photo-upload-area">
                        <i data-lucide="image-plus" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
                        <p class="text-sm font-medium text-gray-700 mb-1">í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
                        <p class="text-xs text-gray-500">JPG, PNG íŒŒì¼ (ê° ìµœëŒ€ 15MB)</p>
                    </div>
                    <input type="file" id="reflectionPhotoInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple class="hidden">
                    
                    <!-- ì‚¬ì§„ ë¯¸ë¦¬ë³´ê¸° ê·¸ë¦¬ë“œ -->
                    <div id="reflectionPhotoGrid" class="photo-grid"></div>
                </div>

                <!-- ì„ì‹œì €ì¥ ë²„íŠ¼ -->
                <div class="flex justify-end">
                    <button id="saveDraftBtn4" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                        <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>ì„ì‹œì €ì¥
                    </button>
                </div>
            </div>
        </section>

        <!-- ì¶”ê°€ ë¯¸ë””ì–´ URL ì„¹ì…˜ -->
        <section class="bg-white rounded-lg shadow-sm border">
            
            <div class="p-6 space-y-6">
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start space-x-3">
                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-semibold mb-1">ğŸ“¸ ì¶”ê°€ ë¯¸ë””ì–´ ì œì¶œ ì•ˆë‚´</p>
                            <p class="mb-2">ì¶”ê°€ë¡œ ì‚¬ì§„ê³¼ ì˜ìƒì„ ì œì¶œí•˜ê³  ì‹¶ìœ¼ì‹  ë¶„ë“¤ì€, ì‚¬ì§„ê³¼ ì˜ìƒì„ ë”°ë¡œ ZIPìœ¼ë¡œ ë¬¶ì–´ 
                            <strong>êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì—…ë¡œë“œ</strong> í•œ í›„ <strong>ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•œ ë§í¬</strong>ë¥¼ ë“±ë¡í•˜ì—¬ ì£¼ì„¸ìš”.</p>
                            <p class="text-xs">ğŸ’¡ íŒ: êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì" ê¶Œí•œìœ¼ë¡œ ê³µìœ  ì„¤ì • í›„ ë§í¬ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”.</p>
                        </div>
                    </div>
                </div>

                <!-- ì‚¬ì§„ URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        ğŸ“· ì‚¬ì§„ ZIP íŒŒì¼ URL
                        <span class="text-gray-500 text-xs ml-2">(ì„ íƒì‚¬í•­)</span>
                    </label>
                    <div class="flex gap-3">
                        <input 
                            type="url" 
                            id="photosDriveUrl" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="ì˜ˆ: https://drive.google.com/file/d/..."
                        >
                        <button 
                            type="button" 
                            id="savePhotosUrlBtn" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium whitespace-nowrap"
                        >
                            ğŸ’¾ ì €ì¥
                        </button>
                    </div>
                    <div id="photosUrlStatus" class="mt-2 text-sm"></div>
                </div>

                <!-- ì˜ìƒ URL -->
                <div>
                    <label class="block text-sm font-medium text-gray-900 mb-2">
                        ğŸ¥ ì˜ìƒ ZIP íŒŒì¼ URL
                        <span class="text-gray-500 text-xs ml-2">(ì„ íƒì‚¬í•­)</span>
                    </label>
                    <div class="flex gap-3">
                        <input 
                            type="url" 
                            id="videosDriveUrl" 
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                            placeholder="ì˜ˆ: https://drive.google.com/file/d/..."
                        >
                        <button 
                            type="button" 
                            id="saveVideosUrlBtn" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium whitespace-nowrap"
                        >
                            ğŸ’¾ ì €ì¥
                        </button>
                    </div>
                    <div id="videosUrlStatus" class="mt-2 text-sm"></div>
                </div>

            </div>
        </section>        
        
        <!-- ìµœì¢… ì œì¶œ ì„¹ì…˜ -->
        <section class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg shadow-sm border-2 border-green-200">
            <div class="p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="send" class="w-8 h-8 text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">í™œë™ ìˆ˜ê¸° ìµœì¢… ì œì¶œ</h2>
                    <p class="text-gray-600">ëª¨ë“  í•­ëª©ì„ ì™„ë£Œí•œ í›„ ì œì¶œí•˜ì‹œë©´ ê´€ë¦¬ìê°€ ê²€í† í•©ë‹ˆë‹¤</p>
                </div>

                <!-- ì œì¶œ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ -->
                <div class="bg-white rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ì œì¶œ ì „ í™•ì¸ì‚¬í•­</h3>
                    <div class="space-y-3">
                        <div class="flex items-start space-x-3">
                            <div id="check1" class="flex-shrink-0 w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center">
                                <i data-lucide="x" class="w-3 h-3 text-gray-400"></i>
                            </div>
                            <p class="text-sm text-gray-700">ê¸°ë³¸ì •ë³´ì˜ ì£¼ìš” í™œë™ ë‚´ìš©ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤</p>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div id="check2" class="flex-shrink-0 w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center">
                                <i data-lucide="x" class="w-3 h-3 text-gray-400"></i>
                            </div>
                            <p class="text-sm text-gray-700">í˜„ì§€ ì •ì°© ì •ë³´ 5ê°œ í•­ëª©ì„ ëª¨ë‘ ì‘ì„±í–ˆìŠµë‹ˆë‹¤ (ìµœì†Œ 300ì í•­ëª© í¬í•¨)</p>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div id="check3" class="flex-shrink-0 w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center">
                                <i data-lucide="x" class="w-3 h-3 text-gray-400"></i>
                            </div>
                            <p class="text-sm text-gray-700">ìˆ˜ì—… ì •ë³´ 3ê°œ ë¬¸í•­ì„ ëª¨ë‘ ì‘ì„±í–ˆìŠµë‹ˆë‹¤ (ê° ìµœì†Œ 300ì)</p>
                        </div>
                        <div class="flex items-start space-x-3">
                            <div id="check4" class="flex-shrink-0 w-5 h-5 rounded border-2 border-gray-300 flex items-center justify-center">
                                <i data-lucide="x" class="w-3 h-3 text-gray-400"></i>
                            </div>
                            <p class="text-sm text-gray-700">í™œë™ ì†Œê° 2ê°œ ë¬¸í•­ì„ ëª¨ë‘ ì‘ì„±í–ˆìŠµë‹ˆë‹¤ (ê° ìµœì†Œ 300ì)</p>
                        </div>
                    </div>
                </div>

                <!-- ì•ˆë‚´ì‚¬í•­ -->
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start space-x-3">
                        <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-600 mt-0.5 flex-shrink-0"></i>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">ì œì¶œ ì „ ìœ ì˜ì‚¬í•­</p>
                            <ul class="space-y-1">
                                <li>â€¢ ì œì¶œ í›„ì—ëŠ” ê´€ë¦¬ì ìŠ¹ì¸ ì „ê¹Œì§€ ìˆ˜ì •ì´ ì œí•œë©ë‹ˆë‹¤</li>
                                <li>â€¢ ëª¨ë“  í•„ìˆ˜ í•­ëª©(*)ì„ ì™„ë£Œí•´ì•¼ ì œì¶œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤</li>
                                <li>â€¢ ìµœì†Œ ê¸€ì ìˆ˜ ìš”êµ¬ì‚¬í•­ì„ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="flex justify-center space-x-4">
                    <button id="finalSaveDraftBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">
                        <i data-lucide="save" class="w-5 h-5 inline mr-2"></i>ìµœì¢… ì„ì‹œì €ì¥
                    </button>
                    <button id="finalSubmitBtn" disabled 
                            class="px-8 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed font-semibold text-lg">
                        <i data-lucide="send" class="w-5 h-5 inline mr-2"></i>ìµœì¢… ì œì¶œí•˜ê¸°
                    </button>
                </div>
            </div>
        </section>

    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.50.2"></script>
    <script type="module" src="../js/config.js"></script>
    <script type="module" src="../js/utils.js"></script>
    <script src="../js/supabase/supabase-core.js"></script>
    <script src="../js/auth.js"></script>

    <script>
// ============================================
// í™œë™ ìˆ˜ê¸° ë“±ë¡ í˜ì´ì§€ - ì „ì²´ ìŠ¤í¬ë¦½íŠ¸ (Supabase ì´ˆê¸°í™” ë¬¸ì œ í•´ê²°)
// ============================================

// ============================================
// ì „ì—­ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
// ============================================
let supabase = null;
let currentUser = null;
let currentReport = null;

// ì‚¬ì§„ ì—…ë¡œë“œ ìƒíƒœ ê´€ë¦¬
const photoState = {
    settlement: [],
    class: [],
    reflection: []
};

// ğŸ“ íƒ€ì…ë³„ íŒŒì¼ëª… prefix ë§¤í•‘
const photoTypeNames = {
    settlement: 'location',   // í˜„ì§€ ì •ì°© ì •ë³´
    class: 'class',           // ìˆ˜ì—… ì •ë³´
    reflection: 'review'      // í™œë™ ì†Œê°
};
        
// ============================================
// âœ¨ ê°œì„ ëœ Supabase ì´ˆê¸°í™” (retry ë¡œì§ ì¶”ê°€)
// ============================================
async function initializeSupabase() {
    const maxRetries = 10;
    const retryDelay = 300;
    
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
        try {
            console.log(`ğŸ”„ Supabase ì´ˆê¸°í™” ì‹œë„ ${attempt}/${maxRetries}...`);
            
            // SupabaseCoreê°€ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            if (!window.SupabaseCore) {
                console.log(`â³ SupabaseCore ë¡œë”© ëŒ€ê¸° ì¤‘... (${attempt}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                continue;
            }
            
            // SupabaseCoreë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
            if (window.SupabaseCore.client) {
                supabase = window.SupabaseCore.client;
                console.log('âœ… SupabaseCore.client ì‚¬ìš©');
            } else if (typeof window.SupabaseCore.getClient === 'function') {
                supabase = window.SupabaseCore.getClient();
                console.log('âœ… SupabaseCore.getClient() ì‚¬ìš©');
            } else {
                console.log(`â³ SupabaseCore ë©”ì„œë“œ ëŒ€ê¸° ì¤‘... (${attempt}/${maxRetries})`);
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                continue;
            }

            // í´ë¼ì´ì–¸íŠ¸ ìœ íš¨ì„± ê²€ì¦
            if (!supabase || typeof supabase.from !== 'function') {
                console.warn('âš ï¸ Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŒ - ì¬ì‹œë„');
                supabase = null;
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                continue;
            }

            // ì„±ê³µ!
            console.log('âœ… Supabase ì´ˆê¸°í™” ì™„ë£Œ:', {
                attempt: attempt,
                hasFrom: typeof supabase.from === 'function',
                hasStorage: typeof supabase.storage === 'function'
            });
            return true;
            
        } catch (error) {
            console.warn(`âš ï¸ Supabase ì´ˆê¸°í™” ì‹œë„ ${attempt} ì‹¤íŒ¨:`, error);
            if (attempt === maxRetries) {
                console.error('âŒ Supabase ì´ˆê¸°í™” ìµœì¢… ì‹¤íŒ¨:', error);
                showAlert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
                return false;
            }
            await new Promise(resolve => setTimeout(resolve, retryDelay));
        }
    }
    
    console.error('âŒ Supabase ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ');
    return false;
}

// ============================================
// ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ
// ============================================
function loadUserData() {
    try {
        // localStorageì—ì„œ currentStudent ê°€ì ¸ì˜¤ê¸°
        const userDataStr = localStorage.getItem('currentStudent');
        if (!userDataStr) {
            throw new Error('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
        }

        currentUser = JSON.parse(userDataStr);

        // í•„ìˆ˜ í•„ë“œ ê²€ì¦
        if (!currentUser.id || !currentUser.name) {
            throw new Error('ì‚¬ìš©ì ë°ì´í„°ê°€ ë¶ˆì™„ì „í•©ë‹ˆë‹¤.');
        }

        console.log('âœ… ì‚¬ìš©ì ì •ë³´ ë¡œë“œ:', currentUser.name);

        // í—¤ë” ì •ë³´ ì—…ë°ì´íŠ¸
        updateHeaderInfo();

        // ê¸°ë³¸ì •ë³´ ìë™ ì…ë ¥ (localStorage ê¸°ë°˜)
        fillBasicInfo();

        return true;
    } catch (error) {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAlert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤', 'error');
        setTimeout(() => {
            window.location.href = '../index.html';
        }, 2000);
        return false;
    }
}

function updateHeaderInfo() {
    const titleEl = document.getElementById('pageTitle');
    const subtitleEl = document.getElementById('pageSubtitle');

    if (titleEl && currentUser.name) {
        titleEl.textContent = `í™œë™ ìˆ˜ê¸° ë“±ë¡ - ${currentUser.name}ë‹˜`;
    }

    if (subtitleEl) {
        const instituteName = currentUser.institute_name_korean || 
                             currentUser.sejong_institute || 
                             currentUser.institute_name;
        if (instituteName) {
            subtitleEl.textContent = `${instituteName}ì—ì„œì˜ ì†Œì¤‘í•œ ê²½í—˜ì„ ê³µìœ í•´ì£¼ì„¸ìš”`;
        }
    }
}

// âœ¨ ìˆ˜ì •ëœ fillBasicInfo í•¨ìˆ˜ - view ë°ì´í„°ë¥¼ ë°›ì„ ìˆ˜ ìˆë„ë¡ ê°œì„ 
function fillBasicInfo(userData = null) {
    // userDataê°€ ì œê³µë˜ì§€ ì•Šìœ¼ë©´ currentUser ì‚¬ìš© (í›„ë°©í˜¸í™˜ì„±)
    const source = userData || currentUser;
    
    console.log('ğŸ“ ê¸°ë³¸ì •ë³´ ì±„ìš°ê¸° ì‹œì‘:', source);

    // ì„±ëª…
    const studentNameEl = document.getElementById('studentName');
    if (studentNameEl) studentNameEl.value = source.name || '';

    // ì†Œì†ëŒ€í•™
    const universityEl = document.getElementById('university');
    if (universityEl) universityEl.value = source.university_name || 'ì •ë³´ ì—†ìŒ';

    // ì „ê³µ
    const majorEl = document.getElementById('major');
    if (majorEl) {
        let majorText = 'ì •ë³´ ì—†ìŒ';
        
        // major í•„ë“œ ì²´í¬
        if (source.major) {
            if (Array.isArray(source.major)) {
                majorText = source.major.join(', ');
            } else {
                majorText = source.major;
            }
        }
        
        // major_fieldë„ ì²´í¬ (viewì—ì„œëŠ” ì´ í•„ë“œ ì‚¬ìš©)
        if ((!majorText || majorText === 'ì •ë³´ ì—†ìŒ') && source.major_field) {
            if (Array.isArray(source.major_field)) {
                majorText = source.major_field.join(', ');
            } else if (typeof source.major_field === 'string') {
                majorText = source.major_field;
            }
        }
        
        majorEl.value = majorText;
    }

    // íŒŒê²¬ì§€ (ì„¸ì¢…í•™ë‹¹)
    const instituteEl = document.getElementById('institute');
    if (instituteEl) {
        instituteEl.value = source.institute_name_korean || 
                           source.sejong_institute || 
                           source.institute_name || 
                           'ì •ë³´ ì—†ìŒ';
    }

    // í™œë™ ë¶„ì•¼
    const activityFieldEl = document.getElementById('activityField');
    if (activityFieldEl) {
        // major_field ì •ë³´ í™œìš©
        if (source.major_field && Array.isArray(source.major_field) && source.major_field.length > 0) {
            activityFieldEl.value = source.major_field.join(', ');
        } else {
            activityFieldEl.value = 'ì •ë³´ ì—†ìŒ';
        }
    }

    // í™œë™ ê¸°ê°„
    const activityPeriodEl = document.getElementById('activityPeriod');
    if (activityPeriodEl && source.actual_arrival_date && source.actual_work_end_date) {
        const startDate = new Date(source.actual_arrival_date).toLocaleDateString('ko-KR');
        const endDate = new Date(source.actual_work_end_date).toLocaleDateString('ko-KR');
        activityPeriodEl.value = `${startDate} ~ ${endDate}`;
    }

    console.log('âœ… ê¸°ë³¸ì •ë³´ ìë™ ì…ë ¥ ì™„ë£Œ');
}

// ============================================
// âœ¨ ìƒˆë¡œìš´ í•¨ìˆ˜: viewì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
// ============================================
async function loadUserInfoFromView() {
    try {
        if (!supabase) {
            console.warn('âš ï¸ Supabase ì´ˆê¸°í™” ì „ - loadUserInfoFromView ê±´ë„ˆëœ€');
            return null;
        }

        console.log('ğŸ” viewì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹œì‘...');

        const { data, error } = await supabase
            .from('v_activity_report_user_info')
            .select('*')
            .eq('user_id', currentUser.id)
            .single();

        if (error) {
            if (error.code !== 'PGRST116') {  // ë°ì´í„° ì—†ìŒ ì—ëŸ¬ê°€ ì•„ë‹Œ ê²½ìš°ë§Œ ë¡œê·¸
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ view ì¡°íšŒ ì‹¤íŒ¨:', error);
            } else {
                console.log('â„¹ï¸ viewì— í•´ë‹¹ ì‚¬ìš©ì ë°ì´í„° ì—†ìŒ');
            }
            return null;
        }

        if (data) {
            console.log('âœ… viewì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì„±ê³µ:', data);
            return data;
        }

        return null;
    } catch (error) {
        console.error('âŒ loadUserInfoFromView ì˜¤ë¥˜:', error);
        return null;
    }
}

// ============================================
// ë°ì´í„° ë¡œë“œ
// ============================================
async function loadExistingReport() {
    try {
        if (!supabase) {
            console.warn('âš ï¸ Supabase ì´ˆê¸°í™” ì „ - loadExistingReport ê±´ë„ˆëœ€');
            return;
        }

        console.log('ğŸ“‹ ê¸°ì¡´ í™œë™ ìˆ˜ê¸° ì¡°íšŒ ì¤‘... user_id:', currentUser.id);

        const { data, error } = await supabase
            .from('activity_reports')
            .select('*')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (error) {
            console.error('âŒ í™œë™ ìˆ˜ê¸° ì¡°íšŒ ì‹¤íŒ¨:', error);
            return;
        }

        if (data) {
            currentReport = data;
            console.log('âœ… ê¸°ì¡´ í™œë™ ìˆ˜ê¸° ë¡œë“œ:', {
                id: data.id,
                status: data.status,
                created_at: data.created_at
            });
            fillFormWithData(data);
            updateStatusBadge(data.status);
        } else {
            console.log('â„¹ï¸ ê¸°ì¡´ í™œë™ ìˆ˜ê¸° ì—†ìŒ - ìƒˆë¡œ ì‘ì„±');
            currentReport = null;
        }
    } catch (error) {
        console.error('âŒ í™œë™ ìˆ˜ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
        currentReport = null;
    }
}


function fillFormWithData(data) {
    
    // ìµœì¢… í™œë™ ë¶„ì•¼
    if (data.final_activity_field) {
        document.getElementById('finalActivityField').value = data.final_activity_field;
    }
    
    // ê¸°ë³¸ì •ë³´
    if (data.main_activities) {
        document.getElementById('mainActivities').value = data.main_activities;
    }

    // í˜„ì§€ ì •ì°© ì •ë³´
    if (data.visa_info) document.getElementById('visaInfo').value = data.visa_info;
    if (data.accommodation_info) document.getElementById('accommodationInfo').value = data.accommodation_info;
    if (data.transportation_info) document.getElementById('transportationInfo').value = data.transportation_info;
    if (data.preparation_info) document.getElementById('preparationInfo').value = data.preparation_info;
    if (data.living_tips) document.getElementById('livingTips').value = data.living_tips;

    // ìˆ˜ì—… ì •ë³´
    if (data.class_description) document.getElementById('classDescription').value = data.class_description;
    if (data.memorable_class) document.getElementById('memorableClass').value = data.memorable_class;
    if (data.challenges_solutions) document.getElementById('challengesSolutions').value = data.challenges_solutions;

    // í™œë™ ì†Œê°
    if (data.one_sentence_summary) document.getElementById('oneSentenceSummary').value = data.one_sentence_summary;
    if (data.advice_for_future) document.getElementById('adviceForFuture').value = data.advice_for_future;

    // ë¯¸ë””ì–´ URL ë¡œë“œ
    if (data.photos_drive_url) {
        const photosUrlInput = document.getElementById('photosDriveUrl');
        if (photosUrlInput) photosUrlInput.value = data.photos_drive_url;
    }

    if (data.videos_drive_url) {
        const videosUrlInput = document.getElementById('videosDriveUrl');
        if (videosUrlInput) videosUrlInput.value = data.videos_drive_url;
    }

    
    // ì‚¬ì§„ ë¡œë“œ
    if (data.settlement_photos) loadPhotos('settlement', data.settlement_photos);
    if (data.class_photos) loadPhotos('class', data.class_photos);
    if (data.reflection_photos) loadPhotos('reflection', data.reflection_photos);

    // ê¸€ì ìˆ˜ ì¹´ìš´í„° ì—…ë°ì´íŠ¸
    updateAllCharCounters();
    updateProgress();
}

function loadPhotos(type, urls) {
    if (!urls || urls.length === 0) {
        console.log(`â„¹ï¸ ${type}: ì €ì¥ëœ ì‚¬ì§„ ì—†ìŒ`);
        return;
    }

    console.log(`ğŸ“¸ ${type} ì‚¬ì§„ ë¡œë“œ ì‹œì‘:`, urls.length + 'ê°œ');
    
    // URL ë°°ì—´ì„ photoState í˜•ì‹ìœ¼ë¡œ ë³€í™˜
    photoState[type] = urls.map((url, index) => {
        // URLì—ì„œ íŒŒì¼ëª… ì¶”ì¶œ
        const urlParts = url.split('/');
        const fileName = urlParts[urlParts.length - 1];
        
        return {
            url: url,
            fileName: fileName,
            uploaded: true,
            originalName: fileName  // ì›ë³¸ íŒŒì¼ëª…
        };
    });

    console.log(`âœ… ${type} ì‚¬ì§„ ${photoState[type].length}ê°œ ë¡œë“œ ì™„ë£Œ`);
    
    // ê·¸ë¦¬ë“œ ë Œë”ë§
    renderPhotoGrid(type);
    
    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    const countId = `${type}PhotoCount`;
    const maxPhotos = 5;
    updatePhotoCount(type, countId, maxPhotos);
}
function updateStatusBadge(status) {
    const badge = document.getElementById('statusBadge');
    if (!badge) return;

    badge.className = 'status-badge';

    if (status === 'draft') {
        badge.classList.add('draft');
        badge.innerHTML = '<i data-lucide="file-edit"></i><span>ì‘ì„±ì¤‘</span>';
    } else if (status === 'submitted') {
        badge.classList.add('submitted');
        badge.innerHTML = '<i data-lucide="clock"></i><span>ê²€í† ì¤‘</span>';
    } else if (status === 'approved') {
        badge.classList.add('approved');
        badge.innerHTML = '<i data-lucide="check-circle"></i><span>ìŠ¹ì¸ì™„ë£Œ</span>';
    }

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

// ============================================
// ê¸€ì ìˆ˜ ì¹´ìš´í„°
// ============================================
function setupCharCounters() {
    const textareas = [
        { id: 'mainActivities', counterId: 'mainActivitiesCounter', minLength: 0 },
        { id: 'visaInfo', counterId: 'visaInfoCounter', minLength: 300 },
        { id: 'accommodationInfo', counterId: 'accommodationInfoCounter', minLength: 300 },
        { id: 'transportationInfo', counterId: 'transportationInfoCounter', minLength: 0 },
        { id: 'preparationInfo', counterId: 'preparationInfoCounter', minLength: 300 },
        { id: 'livingTips', counterId: 'livingTipsCounter', minLength: 0 },
        { id: 'classDescription', counterId: 'classDescriptionCounter', minLength: 300 },
        { id: 'memorableClass', counterId: 'memorableClassCounter', minLength: 300 },
        { id: 'challengesSolutions', counterId: 'challengesSolutionsCounter', minLength: 300 },
        { id: 'oneSentenceSummary', counterId: 'oneSentenceSummaryCounter', minLength: 300 },
        { id: 'adviceForFuture', counterId: 'adviceForFutureCounter', minLength: 300 }
    ];

    textareas.forEach(({ id, counterId, minLength }) => {
        const textarea = document.getElementById(id);
        const counter = document.getElementById(counterId);

        if (!textarea || !counter) return;

        textarea.addEventListener('input', () => {
            const length = textarea.value.length;
            counter.textContent = length;

            const counterParent = counter.parentElement;
            if (minLength > 0) {
                if (length >= minLength) {
                    counterParent.classList.remove('invalid');
                    counterParent.classList.add('valid');
                } else {
                    counterParent.classList.remove('valid');
                    counterParent.classList.add('invalid');
                }
            }

            updateProgress();
        });

        // ì´ˆê¸° ê°’ ì„¤ì •
        textarea.dispatchEvent(new Event('input'));
    });
}

function updateAllCharCounters() {
    const textareas = document.querySelectorAll('textarea[id]');
    textareas.forEach(textarea => {
        textarea.dispatchEvent(new Event('input'));
    });
}

// ============================================
// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
// ============================================
function updateProgress() {
    // í•„ìˆ˜ í•­ëª© ì²´í¬
    const requiredFields = [
        { id: 'mainActivities', minLength: 1 },
        { id: 'visaInfo', minLength: 300 },
        { id: 'accommodationInfo', minLength: 300 },
        { id: 'transportationInfo', minLength: 1 },
        { id: 'preparationInfo', minLength: 300 },
        { id: 'livingTips', minLength: 1 },
        { id: 'classDescription', minLength: 300 },
        { id: 'memorableClass', minLength: 300 },
        { id: 'challengesSolutions', minLength: 300 },
        { id: 'oneSentenceSummary', minLength: 300 },
        { id: 'adviceForFuture', minLength: 300 }
    ];

    let completedCount = 0;
    requiredFields.forEach(({ id, minLength }) => {
        const field = document.getElementById(id);
        if (field && field.value.length >= minLength) {
            completedCount++;
        }
    });

    const progress = Math.round((completedCount / requiredFields.length) * 100);
    
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    if (progressBar) progressBar.style.width = `${progress}%`;
    if (progressText) progressText.textContent = `${progress}%`;

    // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
    updateChecklist();
    
    // ì œì¶œ ë²„íŠ¼ í™œì„±í™” ì²´í¬
    updateSubmitButton();
}

function updateChecklist() {
    // Check 1: ê¸°ë³¸ì •ë³´
    const mainActivities = document.getElementById('mainActivities');
    updateCheckItem('check1', mainActivities && mainActivities.value.length > 0);

    // Check 2: í˜„ì§€ ì •ì°© ì •ë³´
    const settlementComplete = 
        document.getElementById('visaInfo').value.length >= 300 &&
        document.getElementById('accommodationInfo').value.length >= 300 &&
        document.getElementById('transportationInfo').value.length > 0 &&
        document.getElementById('preparationInfo').value.length >= 300 &&
        document.getElementById('livingTips').value.length > 0;
    updateCheckItem('check2', settlementComplete);

    // Check 3: ìˆ˜ì—… ì •ë³´
    const classComplete =
        document.getElementById('classDescription').value.length >= 300 &&
        document.getElementById('memorableClass').value.length >= 300 &&
        document.getElementById('challengesSolutions').value.length >= 300;
    updateCheckItem('check3', classComplete);

    // Check 4: í™œë™ ì†Œê°
    const reflectionComplete =
        document.getElementById('oneSentenceSummary').value.length >= 300 &&
        document.getElementById('adviceForFuture').value.length >= 300;
    updateCheckItem('check4', reflectionComplete);
}

function updateCheckItem(checkId, isComplete) {
    const checkEl = document.getElementById(checkId);
    if (!checkEl) return;

    if (isComplete) {
        checkEl.classList.remove('border-gray-300');
        checkEl.classList.add('border-green-500', 'bg-green-500');
        checkEl.innerHTML = '<i data-lucide="check" class="w-3 h-3 text-white"></i>';
    } else {
        checkEl.classList.remove('border-green-500', 'bg-green-500');
        checkEl.classList.add('border-gray-300');
        checkEl.innerHTML = '<i data-lucide="x" class="w-3 h-3 text-gray-400"></i>';
    }

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

function updateSubmitButton() {
    const submitBtn = document.getElementById('finalSubmitBtn');
    if (!submitBtn) return;

    // ëª¨ë“  í•„ìˆ˜ í•­ëª© ì™„ë£Œ ì—¬ë¶€ í™•ì¸
    const allComplete = 
        document.getElementById('mainActivities').value.length > 0 &&
        document.getElementById('visaInfo').value.length >= 300 &&
        document.getElementById('accommodationInfo').value.length >= 300 &&
        document.getElementById('transportationInfo').value.length > 0 &&
        document.getElementById('preparationInfo').value.length >= 300 &&
        document.getElementById('livingTips').value.length > 0 &&
        document.getElementById('classDescription').value.length >= 300 &&
        document.getElementById('memorableClass').value.length >= 300 &&
        document.getElementById('challengesSolutions').value.length >= 300 &&
        document.getElementById('oneSentenceSummary').value.length >= 300 &&
        document.getElementById('adviceForFuture').value.length >= 300 &&
        photoState.class.length >= 3;  // ìˆ˜ì—… ì‚¬ì§„ ìµœì†Œ 3ê°œ

    submitBtn.disabled = !allComplete;
}

// ============================================
// ì‚¬ì§„ ì—…ë¡œë“œ
// ============================================
function setupPhotoUploads() {
    // ê° ì‚¬ì§„ ì„¹ì…˜ë³„ ì„¤ì •
    const sections = [
        { type: 'settlement', inputId: 'settlementPhotoInput', areaId: 'settlementPhotoUploadArea', countId: 'settlementPhotoCount', maxPhotos: 5 },
        { type: 'class', inputId: 'classPhotoInput', areaId: 'classPhotoUploadArea', countId: 'classPhotoCount', maxPhotos: 5 },
        { type: 'reflection', inputId: 'reflectionPhotoInput', areaId: 'reflectionPhotoUploadArea', countId: 'reflectionPhotoCount', maxPhotos: 5 }
    ];

    sections.forEach(({ type, inputId, areaId, countId, maxPhotos }) => {
        const input = document.getElementById(inputId);
        const area = document.getElementById(areaId);

        if (!input || !area) return;

        // í´ë¦­ ì´ë²¤íŠ¸
        area.addEventListener('click', () => {
            if (photoState[type].length >= maxPhotos) {
                showAlert(`ìµœëŒ€ ${maxPhotos}ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'warning');
                return;
            }
            input.click();
        });

        // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
        input.addEventListener('change', (e) => handlePhotoUpload(e, type, maxPhotos, countId));

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });

        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });

        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            
            if (photoState[type].length >= maxPhotos) {
                showAlert(`ìµœëŒ€ ${maxPhotos}ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'warning');
                return;
            }

            const files = Array.from(e.dataTransfer.files).filter(file => 
                file.type.startsWith('image/')
            );
            
            if (files.length > 0) {
                handlePhotoFiles(files, type, maxPhotos, countId);
            }
        });
    });
}

async function handlePhotoUpload(event, type, maxPhotos, countId) {
    const files = Array.from(event.target.files);
    await handlePhotoFiles(files, type, maxPhotos, countId);
    event.target.value = ''; // ì´ˆê¸°í™”
}

async function handlePhotoFiles(files, type, maxPhotos, countId) {
    const remainingSlots = maxPhotos - photoState[type].length;
    const filesToUpload = files.slice(0, remainingSlots);

    if (filesToUpload.length === 0) {
        showAlert(`ìµœëŒ€ ${maxPhotos}ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤`, 'warning');
        return;
    }

    showAlert('ì‚¬ì§„ ì—…ë¡œë“œ ì¤‘...', 'info');

    for (const file of filesToUpload) {
        // íŒŒì¼ í¬ê¸° ê²€ì¦ (15MB)
        if (file.size > 15 * 1024 * 1024) {
            showAlert(`${file.name}ì€(ëŠ”) 15MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤`, 'warning');
            continue;
        }

        try {
            // ğŸ“ í˜„ì¬ ì¸ë±ìŠ¤ ê³„ì‚°
            const currentIndex = photoState[type].length;
            
            // ğŸ“ íŒŒì¼ í™•ì¥ì ì¶”ì¶œ (ì›ë³¸ íŒŒì¼ì˜ í™•ì¥ì ìœ ì§€)
            const fileExt = getFileExtension(file.name);
            
            // ğŸ“ ìƒˆë¡œìš´ íŒŒì¼ëª… ìƒì„±: {user_id}_{type}_{number}.{ext}
            const prefix = photoTypeNames[type] || type;
            const fileNumber = currentIndex + 1;
            const fileName = `${currentUser.id}_${prefix}_${fileNumber}${fileExt}`;
            
            console.log(`ğŸ“ ì›ë³¸ íŒŒì¼ëª…: ${file.name}`);
            console.log(`ğŸ“¤ ì €ì¥ íŒŒì¼ëª…: ${fileName}`);

            // íŒŒì¼ í™•ì¥ìì— ë§ê²Œ MIME íƒ€ì… ì¡°ì •
            let fileToUpload = file;
            if (fileExt === '.png' || fileExt === '.jpg' || fileExt === '.jpeg') {
                // ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            } else {
                // ì§€ì›í•˜ì§€ ì•ŠëŠ” í™•ì¥ìëŠ” .jpgë¡œ ë³€í™˜
                console.log(`âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” í™•ì¥ì ${fileExt}, .jpgë¡œ ì €ì¥`);
            }

            // Supabase Storageì— ì—…ë¡œë“œ
            const { data, error } = await supabase.storage
                .from('activity-report-photos')
                .upload(fileName, fileToUpload, {
                    cacheControl: '3600',
                    upsert: false  // ê°™ì€ ì´ë¦„ íŒŒì¼ ë®ì–´ì“°ê¸° ë°©ì§€
                });

            if (error) {
                console.error('âŒ ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                
                // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íŒŒì¼ì¸ ê²½ìš° ë®ì–´ì“°ê¸° ì‹œë„
                if (error.message && error.message.includes('already exists')) {
                    console.log('ğŸ”„ ê¸°ì¡´ íŒŒì¼ ë®ì–´ì“°ê¸° ì‹œë„...');
                    
                    const { data: updateData, error: updateError } = await supabase.storage
                        .from('activity-report-photos')
                        .update(fileName, fileToUpload, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    
                    if (updateError) {
                        showAlert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${updateError.message}`, 'error');
                        continue;
                    }
                } else {
                    showAlert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                    continue;
                }
            }

            // ì—…ë¡œë“œëœ íŒŒì¼ì˜ ê³µê°œ URL ìƒì„±
            const { data: urlData } = supabase.storage
                .from('activity-report-photos')
                .getPublicUrl(fileName);

            // photoStateì— ì¶”ê°€
            photoState[type].push({
                url: urlData.publicUrl,
                fileName: fileName,
                uploaded: true,
                originalName: file.name  // ì›ë³¸ íŒŒì¼ëª… ë³´ê´€
            });

            console.log(`âœ… ${file.name} â†’ ${fileName} ì—…ë¡œë“œ ì™„ë£Œ`);

        } catch (error) {
            console.error('âŒ ì—…ë¡œë“œ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
            showAlert(`${file.name} ì—…ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
    }

    renderPhotoGrid(type);
    updatePhotoCount(type, countId, maxPhotos);
    updateProgress();
    
    if (photoState[type].length > 0) {
        showAlert('ì‚¬ì§„ ì—…ë¡œë“œ ì™„ë£Œ', 'success');
    }
}

function renderPhotoGrid(type) {
    const gridId = `${type}PhotoGrid`;
    const grid = document.getElementById(gridId);
    if (!grid) return;

    grid.innerHTML = '';

    photoState[type].forEach((photo, index) => {
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
            <img src="${photo.url}" alt="ì‚¬ì§„ ${index + 1}">
            <button class="photo-delete-btn" onclick="deletePhoto('${type}', ${index})">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        `;
        grid.appendChild(photoItem);
    });

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
}

async function deletePhoto(type, index) {
    const photo = photoState[type][index];
    
    // Storageì—ì„œ íŒŒì¼ ì‚­ì œ
    if (photo.uploaded && photo.fileName) {
        try {
            const { error } = await supabase.storage
                .from('activity-report-photos')
                .remove([photo.fileName]);
            
            if (error) {
                console.warn('âš ï¸ Storage íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', error);
            } else {
                console.log('âœ… Storage íŒŒì¼ ì‚­ì œ ì™„ë£Œ:', photo.fileName);
            }
        } catch (error) {
            console.error('âŒ Storage ì‚­ì œ ì˜¤ë¥˜:', error);
        }
    }
    
    // photoStateì—ì„œ ì œê±°
    photoState[type].splice(index, 1);
    
    // ğŸ”„ ë‚˜ë¨¸ì§€ ì‚¬ì§„ë“¤ì˜ íŒŒì¼ëª…ì„ ì¬ì •ë ¬ (ìˆœì„œ ìœ ì§€)
    await reorderPhotos(type);
    
    renderPhotoGrid(type);
    
    const countId = `${type}PhotoCount`;
    const maxPhotos = 5;
    updatePhotoCount(type, countId, maxPhotos);
    updateProgress();
}

// ğŸ”„ ì‚¬ì§„ ìˆœì„œ ì¬ì •ë ¬ í•¨ìˆ˜
async function reorderPhotos(type) {
    // Storageì— ì—…ë¡œë“œëœ ì‚¬ì§„ë“¤ì˜ íŒŒì¼ëª…ì„ ìˆœì„œëŒ€ë¡œ ì¬ì •ë ¬
    for (let i = 0; i < photoState[type].length; i++) {
        const photo = photoState[type][i];
        const prefix = photoTypeNames[type] || type;
        const correctFileName = `${currentUser.id}_${prefix}_${i + 1}.jpg`;
        
        // í˜„ì¬ íŒŒì¼ëª…ì´ ìˆœì„œì™€ ë§ì§€ ì•Šìœ¼ë©´ rename
        if (photo.fileName !== correctFileName && photo.uploaded) {
            try {
                console.log(`ğŸ”„ íŒŒì¼ëª… ë³€ê²½: ${photo.fileName} â†’ ${correctFileName}`);
                
                // SupabaseëŠ” ì§ì ‘ renameì´ ì—†ìœ¼ë¯€ë¡œ move ì‚¬ìš©
                const { error } = await supabase.storage
                    .from('activity-report-photos')
                    .move(photo.fileName, correctFileName);
                
                if (error) {
                    console.warn('âš ï¸ íŒŒì¼ëª… ë³€ê²½ ì‹¤íŒ¨:', error);
                } else {
                    // photoState ì—…ë°ì´íŠ¸
                    photo.fileName = correctFileName;
                    
                    // URL ì¬ìƒì„±
                    const { data: urlData } = supabase.storage
                        .from('activity-report-photos')
                        .getPublicUrl(correctFileName);
                    
                    photo.url = urlData.publicUrl;
                    console.log('âœ… íŒŒì¼ëª… ë³€ê²½ ì™„ë£Œ:', correctFileName);
                }
            } catch (error) {
                console.error('âŒ íŒŒì¼ëª… ë³€ê²½ ì˜¤ë¥˜:', error);
            }
        }
    }
}

function updatePhotoCount(type, countId, maxPhotos) {
    const countEl = document.getElementById(countId);
    if (countEl) {
        countEl.textContent = `${photoState[type].length} / ${maxPhotos}`;
    }
}

// ============================================
// íŒŒì¼ëª… ìƒì„± í•¨ìˆ˜
// ============================================
function generateFileName(type, index) {
    // type: 'settlement', 'class', 'reflection'
    // index: í˜„ì¬ ë°°ì—´ì˜ ì¸ë±ìŠ¤ (0ë¶€í„° ì‹œì‘)
    
    const prefix = photoTypeNames[type] || type;
    const fileNumber = index + 1;  // 1ë¶€í„° ì‹œì‘
    
    return `${currentUser.id}_${prefix}_${fileNumber}.jpg`;
}

// íŒŒì¼ í™•ì¥ì ì¶”ì¶œ í•¨ìˆ˜
function getFileExtension(fileName) {
    const lastDot = fileName.lastIndexOf('.');
    if (lastDot === -1) return '.jpg';  // ê¸°ë³¸ê°’
    return fileName.substring(lastDot).toLowerCase();
}        
        
        
// ============================================
// ì„ì‹œì €ì¥
// ============================================
async function saveDraft() {
    if (!supabase) {
        showAlert('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
        return;
    }

    try {
        console.log('ğŸ’¾ ì„ì‹œì €ì¥ ì‹œì‘... currentReport:', currentReport?.id || 'null');
        
        const formData = collectFormData();
        
        // STEP 1: ì‹¤ì œ DBì—ì„œ ê¸°ì¡´ ë°ì´í„° í™•ì¸
        const { data: existingData, error: checkError } = await supabase
            .from('activity_reports')
            .select('id, status')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError) {
            console.error('âŒ ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨:', checkError);
            throw checkError;
        }

        console.log('ğŸ” ê¸°ì¡´ ë°ì´í„° í™•ì¸:', existingData);

        if (existingData) {
            // STEP 2-A: ì—…ë°ì´íŠ¸
            console.log('ğŸ“ ì—…ë°ì´íŠ¸ ëª¨ë“œ:', existingData.id);
            
            const { data: updatedData, error: updateError } = await supabase
                .from('activity_reports')
                .update({
                    ...formData,
                    updated_at: new Date().toISOString()
                })
                .eq('id', existingData.id)
                .select()
                .single();

            if (updateError) {
                console.error('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
                throw updateError;
            }
            
            currentReport = updatedData;
            console.log('âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ:', updatedData.id);
            
        } else {
            // STEP 2-B: ìƒˆë¡œ ìƒì„±
            console.log('âœ¨ ìƒì„± ëª¨ë“œ: ìƒˆ ë°ì´í„° ì‚½ì…');
            
            const { data: newData, error: insertError } = await supabase
                .from('activity_reports')
                .insert({
                    ...formData,
                    user_id: currentUser.id,
                    status: 'draft'
                })
                .select()
                .single();

            if (insertError) {
                console.error('âŒ ì‚½ì… ì‹¤íŒ¨:', insertError);
                throw insertError;
            }
            
            currentReport = newData;
            console.log('âœ… ì‚½ì… ì™„ë£Œ:', newData.id);
        }

        showAlert('ì„ì‹œì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        
    } catch (error) {
        console.error('âŒ ì„ì‹œì €ì¥ ì‹¤íŒ¨:', error);
        
        if (error.code === '23505') {
            // ì¤‘ë³µ í‚¤ ì—ëŸ¬ - ë°ì´í„°ê°€ ì´ë¯¸ ìˆëŠ”ë° INSERT ì‹œë„í•¨
            showAlert('ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'warning');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert('ì„ì‹œì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
        }
    }
}


// ============================================
// ìµœì¢… ì œì¶œ
// ============================================
async function finalSubmit() {
    if (!supabase) {
        showAlert('ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'error');
        return;
    }

    if (!confirm('ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •ì´ ì œí•œë©ë‹ˆë‹¤. ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
    }

    try {
        console.log('ğŸ“¤ ìµœì¢… ì œì¶œ ì‹œì‘... currentReport:', currentReport?.id || 'null');
        
        const formData = collectFormData();
        
        // STEP 1: ì‹¤ì œ DBì—ì„œ ê¸°ì¡´ ë°ì´í„° í™•ì¸
        const { data: existingData, error: checkError } = await supabase
            .from('activity_reports')
            .select('id, status')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError) {
            console.error('âŒ ê¸°ì¡´ ë°ì´í„° í™•ì¸ ì‹¤íŒ¨:', checkError);
            throw checkError;
        }

        console.log('ğŸ” ê¸°ì¡´ ë°ì´í„° í™•ì¸:', existingData);

        if (existingData) {
            // STEP 2-A: ì—…ë°ì´íŠ¸ í›„ ì œì¶œ
            console.log('ğŸ“ ì—…ë°ì´íŠ¸ í›„ ì œì¶œ:', existingData.id);
            
            const { data: updatedData, error: updateError } = await supabase
                .from('activity_reports')
                .update({
                    ...formData,
                    status: 'submitted',
                    submitted_at: new Date().toISOString()
                })
                .eq('id', existingData.id)
                .select()
                .single();

            if (updateError) {
                console.error('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
                throw updateError;
            }
            
            currentReport = updatedData;
            console.log('âœ… ì—…ë°ì´íŠ¸ í›„ ì œì¶œ ì™„ë£Œ:', updatedData.id);
            
        } else {
            // STEP 2-B: ìƒˆë¡œ ìƒì„± í›„ ì œì¶œ
            console.log('âœ¨ ìƒì„± í›„ ì œì¶œ: ìƒˆ ë°ì´í„° ì‚½ì…');
            
            const { data: newData, error: insertError } = await supabase
                .from('activity_reports')
                .insert({
                    ...formData,
                    user_id: currentUser.id,
                    status: 'submitted',
                    submitted_at: new Date().toISOString()
                })
                .select()
                .single();

            if (insertError) {
                console.error('âŒ ì‚½ì… ì‹¤íŒ¨:', insertError);
                throw insertError;
            }
            
            currentReport = newData;
            console.log('âœ… ì‚½ì… í›„ ì œì¶œ ì™„ë£Œ:', newData.id);
        }

        showAlert('í™œë™ ìˆ˜ê¸°ê°€ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
        updateStatusBadge('submitted');
        
        setTimeout(() => {
            window.location.href = 'dashboard.html';
        }, 2000);
        
    } catch (error) {
        console.error('âŒ ì œì¶œ ì‹¤íŒ¨:', error);
        
        if (error.code === '23505') {
            // ì¤‘ë³µ í‚¤ ì—ëŸ¬
            showAlert('ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜ì…ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.', 'warning');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert('ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + (error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
        }
    }
}

function collectFormData() {
    return {
        final_activity_field: document.getElementById('finalActivityField').value,
        main_activities: document.getElementById('mainActivities').value,
        visa_info: document.getElementById('visaInfo').value,
        accommodation_info: document.getElementById('accommodationInfo').value,
        transportation_info: document.getElementById('transportationInfo').value,
        preparation_info: document.getElementById('preparationInfo').value,
        living_tips: document.getElementById('livingTips').value,
        class_description: document.getElementById('classDescription').value,
        memorable_class: document.getElementById('memorableClass').value,
        challenges_solutions: document.getElementById('challengesSolutions').value,
        one_sentence_summary: document.getElementById('oneSentenceSummary').value,
        advice_for_future: document.getElementById('adviceForFuture').value,
        settlement_photos: photoState.settlement.map(p => p.url),
        class_photos: photoState.class.map(p => p.url),
        reflection_photos: photoState.reflection.map(p => p.url),
        photos_drive_url: document.getElementById('photosDriveUrl')?.value || null,
        videos_drive_url: document.getElementById('videosDriveUrl')?.value || null

    };
}
        
        
// ============================================
// ë¯¸ë””ì–´ URL ì €ì¥
// ============================================
async function saveMediaUrl(urlType) {
    const urlInput = document.getElementById(urlType === 'photos' ? 'photosDriveUrl' : 'videosDriveUrl');
    const statusDiv = document.getElementById(urlType === 'photos' ? 'photosUrlStatus' : 'videosUrlStatus');
    const saveBtn = document.getElementById(urlType === 'photos' ? 'savePhotosUrlBtn' : 'saveVideosUrlBtn');
    
    const url = urlInput.value.trim();
    
    // URL ìœ íš¨ì„± ê²€ì‚¬
    if (url && !isValidUrl(url)) {
        statusDiv.innerHTML = '<span class="text-red-600">âŒ ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.</span>';
        return;
    }
    
    try {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ì €ì¥ ì¤‘...';
        statusDiv.innerHTML = '<span class="text-blue-600">ğŸ’¾ ì €ì¥ ì¤‘...</span>';
        
        const columnName = urlType === 'photos' ? 'photos_drive_url' : 'videos_drive_url';
        
        // ê¸°ì¡´ ë°ì´í„° í™•ì¸
        const { data: existingData, error: checkError } = await supabase
            .from('activity_reports')
            .select('id')
            .eq('user_id', currentUser.id)
            .maybeSingle();

        if (checkError) {
            throw checkError;
        }

        if (existingData) {
            // ì—…ë°ì´íŠ¸
            const { error } = await supabase
                .from('activity_reports')
                .update({
                    [columnName]: url || null,
                    updated_at: new Date().toISOString()
                })
                .eq('user_id', currentUser.id);
                
            if (error) throw error;
        } else {
            // ìƒˆë¡œ ìƒì„±
            const { error } = await supabase
                .from('activity_reports')
                .insert({
                    user_id: currentUser.id,
                    [columnName]: url || null,
                    status: 'draft'
                });
                
            if (error) throw error;
        }
        
        statusDiv.innerHTML = `<span class="text-green-600">âœ… ${urlType === 'photos' ? 'ì‚¬ì§„' : 'ì˜ìƒ'} URLì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</span>`;
        setTimeout(() => {
            statusDiv.innerHTML = '';
        }, 3000);
        
    } catch (error) {
        console.error('URL ì €ì¥ ì˜¤ë¥˜:', error);
        statusDiv.innerHTML = '<span class="text-red-600">âŒ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>';
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ğŸ’¾ ì €ì¥';
    }
}

// URL ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
function isValidUrl(string) {
    try {
        const url = new URL(string);
        return url.protocol === 'http:' || url.protocol === 'https:';
    } catch (_) {
        return false;
    }
}
// ============================================
// âœ¨ ìˆ˜ì •ëœ í˜ì´ì§€ ì´ˆê¸°í™” - retry ë¡œì§ ì ìš©
// ============================================
async function initializeActivityReportApp() {
    console.log('ğŸš€ í™œë™ ìˆ˜ê¸° í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘');

    // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    try {
        // 1. ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ (localStorageë§Œ ì‚¬ìš©)
        const userReady = loadUserData();
        if (!userReady) return;

        // 2. Supabase ì´ˆê¸°í™” (retry ë¡œì§ í¬í•¨)
        const supabaseReady = await initializeSupabase();
        if (!supabaseReady) {
            console.warn('âš ï¸ Supabase ì´ˆê¸°í™” ì‹¤íŒ¨ - ê¸°ë³¸ ê¸°ëŠ¥ë§Œ ì‚¬ìš©');
        }

        // 3. âœ¨ viewì—ì„œ ìµœì‹  ì‚¬ìš©ì ì •ë³´ ë¡œë“œí•˜ì—¬ ê¸°ë³¸ì •ë³´ ë‹¤ì‹œ ì±„ìš°ê¸°
        if (supabase) {
            const viewData = await loadUserInfoFromView();
            if (viewData) {
                console.log('ğŸ”„ view ë°ì´í„°ë¡œ ê¸°ë³¸ì •ë³´ ì—…ë°ì´íŠ¸');
                fillBasicInfo(viewData);  // view ë°ì´í„°ë¡œ ê¸°ë³¸ì •ë³´ ì—…ë°ì´íŠ¸
            } else {
                console.log('â„¹ï¸ view ë°ì´í„° ì—†ìŒ - localStorage ë°ì´í„° ì‚¬ìš©');
            }
        }

        // 4. ê¸°ì¡´ í™œë™ ìˆ˜ê¸° ë¡œë“œ (Supabase ì¤€ë¹„ëœ ê²½ìš°ì—ë§Œ)
        if (supabase) {
            await loadExistingReport();
        }

        // 5. UI ì„¤ì •
        setupCharCounters();
        setupPhotoUploads();
        setupEventListeners();
        updateProgress();

        console.log('âœ… í˜ì´ì§€ ì´ˆê¸°í™” ì™„ë£Œ');

    } catch (error) {
        console.error('âŒ í˜ì´ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showAlert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
    }
}
        
        

// ============================================
// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
// ============================================
function setupEventListeners() {
    // ë’¤ë¡œê°€ê¸°
    const backBtn = document.getElementById('backBtn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            window.location.href = 'dashboard.html';
        });
    }

    // ì„ì‹œì €ì¥ ë²„íŠ¼ë“¤
    const saveBtns = [
        'saveDraftBtn1', 'saveDraftBtn2', 'saveDraftBtn3', 
        'saveDraftBtn4', 'finalSaveDraftBtn'
    ];
    saveBtns.forEach(btnId => {
        const btn = document.getElementById(btnId);
        if (btn) {
            btn.addEventListener('click', saveDraft);
        }
    });

    // ìµœì¢… ì œì¶œ
    const submitBtn = document.getElementById('finalSubmitBtn');
    if (submitBtn) {
        submitBtn.addEventListener('click', finalSubmit);
    }
    
        // ë¯¸ë””ì–´ URL ì €ì¥ ë²„íŠ¼
    const savePhotosUrlBtn = document.getElementById('savePhotosUrlBtn');
    const saveVideosUrlBtn = document.getElementById('saveVideosUrlBtn');

    if (savePhotosUrlBtn) {
        savePhotosUrlBtn.addEventListener('click', () => saveMediaUrl('photos'));
    }

    if (saveVideosUrlBtn) {
        saveVideosUrlBtn.addEventListener('click', () => saveMediaUrl('videos'));
    }

    
}

// ============================================
// Alert í•¨ìˆ˜
// ============================================
function showAlert(message, type = 'info') {
    const container = document.getElementById('alert-container');
    if (!container) return;

    const colors = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        warning: 'bg-yellow-50 border-yellow-200 text-yellow-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
    };

    const icons = {
        success: 'check-circle',
        error: 'x-circle',
        warning: 'alert-triangle',
        info: 'info'
    };

    const alert = document.createElement('div');
    alert.className = `${colors[type]} border rounded-lg p-4 mb-4 flex items-center space-x-3`;
    alert.innerHTML = `
        <i data-lucide="${icons[type]}" class="w-5 h-5 flex-shrink-0"></i>
        <p class="flex-1">${message}</p>
        <button onclick="this.parentElement.remove()" class="text-gray-500 hover:text-gray-700">
            <i data-lucide="x" class="w-4 h-4"></i>
        </button>
    `;

    container.appendChild(alert);

    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// ============================================
// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ˆê¸°í™”
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM ë¡œë“œ ì™„ë£Œ - í™œë™ ìˆ˜ê¸° ì´ˆê¸°í™”');
    initializeActivityReportApp();
});

// DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°ë¥¼ ìœ„í•œ ì¶”ê°€ ì²˜ë¦¬
if (document.readyState !== 'loading') {
    console.log('ğŸš€ DOM ì´ë¯¸ ë¡œë“œë¨ - ì¦‰ì‹œ ì´ˆê¸°í™” ì‹¤í–‰');
    initializeActivityReportApp();
}

    </script>
</body>
</html>