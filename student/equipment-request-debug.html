<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸í™”êµêµ¬ ì‹ ì²­ (ë””ë²„ê¹…) - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../css/main.css?v=1.3.0">
    <link rel="stylesheet" href="../css/student.css?v=1.3.0">
    <link rel="stylesheet" href="../css/lesson-plan.css?v=1.3.0">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #333;
        }

        .debug-panel h4 {
            color: #ffff00;
            margin: 0 0 0.5rem 0;
        }

        .debug-error {
            color: #ff4444;
        }

        .debug-success {
            color: #44ff44;
        }

        .debug-info {
            color: #4444ff;
        }

        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }

        .test-button:hover {
            background: #005999;
        }
    </style>
</head>
<body>
    <!-- ë””ë²„ê¹… íŒ¨ë„ -->
    <div class="debug-panel">
        <h4>ğŸ” ë””ë²„ê¹… ì •ë³´</h4>
        <div id="debugLog">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        <div style="margin-top: 1rem;">
            <button class="test-button" onclick="testUserAuth()">ì‚¬ìš©ì ì¸ì¦ í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="testDatabaseConnection()">DB ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="testLoadApplications()">ì‹ ì²­ë‚´ì—­ ë¡œë“œ í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="clearStorageAndReload()">ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app">
        <!-- í•™ìƒ ëŒ€ì‹œë³´ë“œ (êµêµ¬ ì‹ ì²­) -->
        <div id="studentPage" class="page active">
            <header class="header">
                <div class="header-content">
                    <div class="user-info">
                        <div class="breadcrumb">
                            <a href="dashboard.html" class="breadcrumb-link">
                                <i data-lucide="home"></i>
                                ëŒ€ì‹œë³´ë“œ
                            </a>
                            <i data-lucide="chevron-right"></i>
                            <span>ë¬¸í™”êµêµ¬ ì‹ ì²­ (ë””ë²„ê¹…)</span>
                        </div>
                        <h1 id="studentWelcome">ë¬¸í™”êµêµ¬ ì‹ ì²­</h1>
                        <p id="studentDetails">ìˆ˜ì—…ì— í•„ìš”í•œ êµêµ¬ë¥¼ ì‹ ì²­í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                        <!-- ì˜ˆì‚° í˜„í™© í‘œì‹œ ì˜ì—­ -->
                        <div id="budgetStatus" class="budget-status-container"></div>
                    </div>
                    <div class="header-actions">
                        <button id="backToDashboard" class="btn secondary">
                            <i data-lucide="arrow-left"></i>
                            ëŒ€ì‹œë³´ë“œ
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="dashboard-header">
                    <h2>êµêµ¬ ì‹ ì²­ í˜„í™©</h2>
                    <div class="dashboard-actions">
                        <button id="newApplicationBtn" class="btn primary">
                            <i data-lucide="plus"></i>
                            ìƒˆ êµêµ¬ ì‹ ì²­ (í…ŒìŠ¤íŠ¸)
                        </button>
                    </div>
                </div>

                <div id="studentApplications" class="applications-grid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì‹ ì²­ ë‚´ì—­ -->
                </div>

                <div id="noApplications" class="empty-state" style="display: none;">
                    <i data-lucide="package" class="empty-icon"></i>
                    <p>ì•„ì§ ì‹ ì²­í•œ êµêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="../js/config.js?v=1.3.0"></script>
    <script src="../js/supabase-client.js?v=1.3.0"></script>
    <script src="../js/utils.js?v=1.3.0"></script>
    <script src="../js/auth.js?v=1.3.0"></script>
    
    <!-- ë””ë²„ê¹… ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ë””ë²„ê¹… ë¡œê·¸ í•¨ìˆ˜
        function debugLog(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'debug-error' : type === 'success' ? 'debug-success' : 'debug-info';
            
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // ì‚¬ìš©ì ì¸ì¦ í…ŒìŠ¤íŠ¸
        async function testUserAuth() {
            debugLog('ì‚¬ìš©ì ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...', 'info');
            
            try {
                // localStorageì—ì„œ ì‚¬ìš©ì ì •ë³´ í™•ì¸
                const currentStudent = localStorage.getItem('currentStudent');
                const studentSession = localStorage.getItem('studentSession');
                
                debugLog(`currentStudent: ${currentStudent ? 'ì¡´ì¬' : 'ì—†ìŒ'}`, currentStudent ? 'success' : 'error');
                debugLog(`studentSession: ${studentSession ? 'ì¡´ì¬' : 'ì—†ìŒ'}`, studentSession ? 'success' : 'error');
                
                if (currentStudent) {
                    const studentData = JSON.parse(currentStudent);
                    debugLog(`í•™ìƒ ì´ë¦„: ${studentData.name}`, 'success');
                    debugLog(`í•™ìƒ ID: ${studentData.id}`, 'success');
                    debugLog(`ìƒë…„ì›”ì¼: ${studentData.birth_date}`, 'success');
                    
                    // SupabaseAPIì—ì„œ í•´ë‹¹ í•™ìƒ ì •ë³´ ì¬í™•ì¸
                    if (window.SupabaseAPI) {
                        const result = await SupabaseAPI.authenticateStudent(studentData.name, studentData.birth_date);
                        if (result.success) {
                            debugLog('Supabase ì¸ì¦ ì„±ê³µ âœ…', 'success');
                            debugLog(`DB í•™ìƒ ID: ${result.data.id}`, 'success');
                        } else {
                            debugLog(`Supabase ì¸ì¦ ì‹¤íŒ¨: ${result.message}`, 'error');
                        }
                    }
                } else {
                    debugLog('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                debugLog(`ì¸ì¦ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
        async function testDatabaseConnection() {
            debugLog('ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
            
            try {
                if (!window.SupabaseAPI) {
                    debugLog('SupabaseAPIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const healthCheck = await SupabaseAPI.healthCheck();
                debugLog(`DB ìƒíƒœ: ${healthCheck.status}`, healthCheck.status === 'healthy' ? 'success' : 'error');
                debugLog(`ì‘ë‹µì‹œê°„: ${healthCheck.responseTimeMs}ms`, 'info');
                
                if (healthCheck.error) {
                    debugLog(`DB ì˜¤ë¥˜: ${healthCheck.error}`, 'error');
                }
            } catch (error) {
                debugLog(`DB ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì‹ ì²­ ë‚´ì—­ ë¡œë“œ í…ŒìŠ¤íŠ¸
        async function testLoadApplications() {
            debugLog('ì‹ ì²­ ë‚´ì—­ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
            
            try {
                const currentStudent = localStorage.getItem('currentStudent');
                if (!currentStudent) {
                    debugLog('ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const studentData = JSON.parse(currentStudent);
                debugLog(`í•™ìƒ IDë¡œ ì‹ ì²­ë‚´ì—­ ì¡°íšŒ: ${studentData.id}`, 'info');
                
                if (window.SupabaseAPI) {
                    const applications = await SupabaseAPI.getStudentApplications(studentData.id);
                    debugLog(`ì¡°íšŒëœ ì‹ ì²­ ë‚´ì—­: ${applications.length}ê±´`, applications.length > 0 ? 'success' : 'info');
                    
                    if (applications.length > 0) {
                        applications.forEach((app, index) => {
                            debugLog(`${index + 1}. ${app.item_name} - ${app.price}ì› (${app.status})`, 'success');
                        });
                        
                        // ì‹¤ì œ í™”ë©´ì— ë Œë”ë§
                        renderApplicationsDebug(applications);
                    } else {
                        debugLog('ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
                    }
                } else {
                    debugLog('SupabaseAPIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
            } catch (error) {
                debugLog(`ì‹ ì²­ë‚´ì—­ ë¡œë“œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì‹¤ì œ ì‹ ì²­ ë‚´ì—­ ë Œë”ë§ (ë””ë²„ê·¸ìš©)
        function renderApplicationsDebug(applications) {
            const container = document.getElementById('studentApplications');
            const emptyState = document.getElementById('noApplications');
            
            container.innerHTML = '';
            emptyState.style.display = 'none';
            container.style.display = 'block';
            
            applications.forEach(app => {
                const card = document.createElement('div');
                card.className = 'application-card';
                card.innerHTML = `
                    <div class="application-card-header">
                        <h3>${app.item_name}</h3>
                        <span class="status-badge ${getStatusClass(app.status)}">${getStatusText(app.status)}</span>
                    </div>
                    <div class="application-details">
                        <div class="detail-item">
                            <span class="detail-label">ëª©ì </span>
                            <span class="detail-value">${app.purpose}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ê°€ê²©</span>
                            <span class="detail-value">${app.price.toLocaleString('ko-KR')}ì›</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">êµ¬ë§¤ë°©ì‹</span>
                            <span class="detail-value">${app.purchase_type === 'offline' ? 'ì˜¤í”„ë¼ì¸' : 'ì˜¨ë¼ì¸'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ì‹ ì²­ì¼</span>
                            <span class="detail-value">${new Date(app.created_at).toLocaleDateString('ko-KR')}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            
            debugLog(`${applications.length}ê°œì˜ ì‹ ì²­ ë‚´ì—­ì´ í™”ë©´ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤`, 'success');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'warning',
                'approved': 'success', 
                'rejected': 'danger',
                'purchased': 'info',
                'completed': 'info'
            };
            return statusMap[status] || 'secondary';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ê²€í†  ì¤‘',
                'approved': 'ìŠ¹ì¸ë¨',
                'rejected': 'ë°˜ë ¤ë¨',
                'purchased': 'êµ¬ë§¤ì™„ë£Œ',
                'completed': 'êµ¬ë§¤ì™„ë£Œ'
            };
            return statusMap[status] || status;
        }

        // ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
        function clearStorageAndReload() {
            localStorage.clear();
            sessionStorage.clear();
            debugLog('ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™” í›„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'info');
            setTimeout(() => {
                window.location.href = '../index.html';
            }, 1000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
            
            // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                debugLog('Lucide ì•„ì´ì½˜ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            }

            // ìë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            setTimeout(() => {
                debugLog('ìë™ ì§„ë‹¨ ì‹œì‘...', 'info');
                testUserAuth();
                setTimeout(() => testDatabaseConnection(), 500);
                setTimeout(() => testLoadApplications(), 1000);
            }, 1000);

            // ëŒ€ì‹œë³´ë“œ ì´ë™ ë²„íŠ¼
            const backBtn = document.getElementById('backToDashboard');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    window.location.href = 'dashboard.html';
                });
            }

            // ìƒˆ ì‹ ì²­ í…ŒìŠ¤íŠ¸ ë²„íŠ¼
            const newAppBtn = document.getElementById('newApplicationBtn');
            if (newAppBtn) {
                newAppBtn.addEventListener('click', () => {
                    debugLog('ìƒˆ êµêµ¬ ì‹ ì²­ ë²„íŠ¼ í´ë¦­ë¨', 'info');
                    alert('ë””ë²„ê¹… ëª¨ë“œì—ì„œëŠ” ì‹ ì²­ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                });
            }
        });
    </script>
</body>
</html>