<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸í™”êµêµ¬ ì‹ ì²­ (ë¬¸ì œ í•´ê²°) - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../css/main.css?v=1.3.0">
    <link rel="stylesheet" href="../css/student.css?v=1.3.0">
    <link rel="stylesheet" href="../css/lesson-plan.css?v=1.3.0">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        .debug-panel {
            background: #1a1a1a;
            color: #00ff00;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #333;
        }

        .debug-panel h4 {
            color: #ffff00;
            margin: 0 0 0.5rem 0;
        }

        .debug-error {
            color: #ff4444;
        }

        .debug-success {
            color: #44ff44;
        }

        .debug-info {
            color: #4444ff;
        }

        .debug-warning {
            color: #ffaa00;
        }

        .test-button {
            background: #007acc;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }

        .test-button:hover {
            background: #005999;
        }

        .fix-button {
            background: #28a745;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.25rem;
        }

        .fix-button:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <!-- ë¬¸ì œ í•´ê²° íŒ¨ë„ -->
    <div class="debug-panel">
        <h4>ğŸ”§ localStorage ë¬¸ì œ í•´ê²°</h4>
        <div id="debugLog">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        <div style="margin-top: 1rem;">
            <button class="test-button" onclick="inspectStorageData()">ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ê²€ì‚¬</button>
            <button class="fix-button" onclick="fixStudentDataStructure()">ë°ì´í„° êµ¬ì¡° ìˆ˜ì •</button>
            <button class="test-button" onclick="testFixedData()">ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸</button>
            <button class="test-button" onclick="reLoginAsLeeGaJja()">ì´ê°€ì§œë¡œ ì¬ë¡œê·¸ì¸</button>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app">
        <!-- í•™ìƒ ëŒ€ì‹œë³´ë“œ (êµêµ¬ ì‹ ì²­) -->
        <div id="studentPage" class="page active">
            <header class="header">
                <div class="header-content">
                    <div class="user-info">
                        <div class="breadcrumb">
                            <a href="dashboard.html" class="breadcrumb-link">
                                <i data-lucide="home"></i>
                                ëŒ€ì‹œë³´ë“œ
                            </a>
                            <i data-lucide="chevron-right"></i>
                            <span>ë¬¸í™”êµêµ¬ ì‹ ì²­ (ë¬¸ì œ í•´ê²°)</span>
                        </div>
                        <h1 id="studentWelcome">ë¬¸í™”êµêµ¬ ì‹ ì²­</h1>
                        <p id="studentDetails">ìˆ˜ì—…ì— í•„ìš”í•œ êµêµ¬ë¥¼ ì‹ ì²­í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</p>
                        <!-- ì˜ˆì‚° í˜„í™© í‘œì‹œ ì˜ì—­ -->
                        <div id="budgetStatus" class="budget-status-container"></div>
                    </div>
                    <div class="header-actions">
                        <button id="backToDashboard" class="btn secondary">
                            <i data-lucide="arrow-left"></i>
                            ëŒ€ì‹œë³´ë“œ
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="dashboard-header">
                    <h2>êµêµ¬ ì‹ ì²­ í˜„í™©</h2>
                    <div class="dashboard-actions">
                        <button id="newApplicationBtn" class="btn primary" disabled>
                            <i data-lucide="plus"></i>
                            ìƒˆ êµêµ¬ ì‹ ì²­
                        </button>
                    </div>
                </div>

                <div id="studentApplications" class="applications-grid">
                    <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì‹ ì²­ ë‚´ì—­ -->
                </div>

                <div id="noApplications" class="empty-state" style="display: none;">
                    <i data-lucide="package" class="empty-icon"></i>
                    <p>ì•„ì§ ì‹ ì²­í•œ êµêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </main>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="../js/config.js?v=1.3.0"></script>
    <script src="../js/supabase-client.js?v=1.3.0"></script>
    <script src="../js/utils.js?v=1.3.0"></script>
    <script src="../js/auth.js?v=1.3.0"></script>
    
    <!-- ë¬¸ì œ í•´ê²° ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // ë””ë²„ê¹… ë¡œê·¸ í•¨ìˆ˜
        function debugLog(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'debug-info';
            
            switch(type) {
                case 'error': colorClass = 'debug-error'; break;
                case 'success': colorClass = 'debug-success'; break;
                case 'warning': colorClass = 'debug-warning'; break;
                default: colorClass = 'debug-info';
            }
            
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[FIX] ${message}`);
        }

        // localStorage ë°ì´í„° ê²€ì‚¬
        function inspectStorageData() {
            debugLog('=== localStorage ë°ì´í„° êµ¬ì¡° ê²€ì‚¬ ===', 'info');
            
            try {
                // ëª¨ë“  localStorage í‚¤ í™•ì¸
                const keys = Object.keys(localStorage);
                debugLog(`ì´ ${keys.length}ê°œì˜ í‚¤ ë°œê²¬: ${keys.join(', ')}`, 'info');
                
                // currentStudent ë°ì´í„° ìƒì„¸ ê²€ì‚¬
                const currentStudent = localStorage.getItem('currentStudent');
                if (currentStudent) {
                    debugLog('currentStudent ë°ì´í„° ë°œê²¬!', 'success');
                    
                    try {
                        const studentData = JSON.parse(currentStudent);
                        debugLog('=== currentStudent ë‚´ìš© ===', 'info');
                        
                        // ëª¨ë“  í•„ë“œ ì¶œë ¥
                        Object.keys(studentData).forEach(key => {
                            const value = studentData[key];
                            debugLog(`  ${key}: ${value} (íƒ€ì…: ${typeof value})`, 'info');
                        });
                        
                        // ê°€ëŠ¥í•œ ID í•„ë“œë“¤ í™•ì¸
                        const possibleIdFields = ['id', 'user_id', 'student_id', 'uuid'];
                        const possibleDateFields = ['birth_date', 'birthDate', 'birth', 'dateOfBirth'];
                        
                        debugLog('=== ID í•„ë“œ ê²€ì‚¬ ===', 'warning');
                        possibleIdFields.forEach(field => {
                            if (studentData[field]) {
                                debugLog(`  ${field}: ${studentData[field]} âœ“`, 'success');
                            } else {
                                debugLog(`  ${field}: ì—†ìŒ`, 'error');
                            }
                        });
                        
                        debugLog('=== ìƒë…„ì›”ì¼ í•„ë“œ ê²€ì‚¬ ===', 'warning');
                        possibleDateFields.forEach(field => {
                            if (studentData[field]) {
                                debugLog(`  ${field}: ${studentData[field]} âœ“`, 'success');
                            } else {
                                debugLog(`  ${field}: ì—†ìŒ`, 'error');
                            }
                        });
                        
                    } catch (parseError) {
                        debugLog(`JSON íŒŒì‹± ì˜¤ë¥˜: ${parseError.message}`, 'error');
                        debugLog(`ì›ë³¸ ë°ì´í„°: ${currentStudent}`, 'error');
                    }
                } else {
                    debugLog('currentStudent ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!', 'error');
                }
                
                // studentSessionë„ í™•ì¸
                const studentSession = localStorage.getItem('studentSession');
                if (studentSession) {
                    debugLog('studentSession ë°ì´í„°ë„ ë°œê²¬ë¨', 'success');
                    try {
                        const sessionData = JSON.parse(studentSession);
                        debugLog('=== studentSession ë‚´ìš© ===', 'info');
                        Object.keys(sessionData).forEach(key => {
                            debugLog(`  ${key}: ${typeof sessionData[key] === 'object' ? JSON.stringify(sessionData[key]) : sessionData[key]}`, 'info');
                        });
                    } catch (error) {
                        debugLog(`studentSession íŒŒì‹± ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                debugLog(`ìŠ¤í† ë¦¬ì§€ ê²€ì‚¬ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ë°ì´í„° êµ¬ì¡° ìˆ˜ì • (ì´ê°€ì§œ í•™ìƒì˜ ì •í™•í•œ ì •ë³´ë¡œ)
        function fixStudentDataStructure() {
            debugLog('=== ë°ì´í„° êµ¬ì¡° ìˆ˜ì • ì‹œì‘ ===', 'warning');
            
            try {
                // ì˜¬ë°”ë¥¸ ì´ê°€ì§œ í•™ìƒ ë°ì´í„° (DBì—ì„œ í™•ì¸ëœ ì •ë³´)
                const correctStudentData = {
                    id: '13c27f96-ee99-4eb0-9ab7-56121d14a6a7',
                    name: 'ì´ê°€ì§œ',
                    birth_date: '1992-02-02',
                    user_type: 'student',
                    sejong_institute: 'í…ŒìŠ¤íŠ¸í•™ë‹¹',
                    field: 'í…ŒìŠ¤íŠ¸ ë¶„ì•¼',
                    email: null,
                    dispatch_start_date: null,
                    dispatch_end_date: null,
                    total_lessons: 0,
                    created_at: '2025-06-13T10:59:32.551137+00:00',
                    updated_at: '2025-06-17T04:26:06.950005+00:00'
                };
                
                // localStorage ì—…ë°ì´íŠ¸
                localStorage.setItem('currentStudent', JSON.stringify(correctStudentData));
                
                // ì„¸ì…˜ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸
                const sessionData = {
                    user: correctStudentData,
                    userType: 'student',
                    loginTime: new Date().toISOString()
                };
                localStorage.setItem('studentSession', JSON.stringify(sessionData));
                
                debugLog('âœ… ë°ì´í„° êµ¬ì¡° ìˆ˜ì • ì™„ë£Œ!', 'success');
                debugLog(`í•™ìƒ ID: ${correctStudentData.id}`, 'success');
                debugLog(`í•™ìƒ ì´ë¦„: ${correctStudentData.name}`, 'success');
                debugLog(`ìƒë…„ì›”ì¼: ${correctStudentData.birth_date}`, 'success');
                
            } catch (error) {
                debugLog(`ë°ì´í„° êµ¬ì¡° ìˆ˜ì • ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸
        async function testFixedData() {
            debugLog('=== ìˆ˜ì •ëœ ë°ì´í„° í…ŒìŠ¤íŠ¸ ===', 'info');
            
            try {
                // ìˆ˜ì •ëœ ë°ì´í„° í™•ì¸
                const currentStudent = localStorage.getItem('currentStudent');
                if (!currentStudent) {
                    debugLog('ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                const studentData = JSON.parse(currentStudent);
                debugLog(`í…ŒìŠ¤íŠ¸ ëŒ€ìƒ: ${studentData.name} (${studentData.id})`, 'info');
                
                // SupabaseAPI ì¸ì¦ í…ŒìŠ¤íŠ¸
                if (window.SupabaseAPI) {
                    debugLog('Supabase API ì¸ì¦ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
                    const result = await SupabaseAPI.authenticateStudent(studentData.name, studentData.birth_date);
                    
                    if (result.success) {
                        debugLog('âœ… Supabase ì¸ì¦ ì„±ê³µ!', 'success');
                        debugLog(`DB í•™ìƒ ID: ${result.data.id}`, 'success');
                        
                        // ì‹ ì²­ ë‚´ì—­ ë¡œë“œ í…ŒìŠ¤íŠ¸
                        debugLog('ì‹ ì²­ ë‚´ì—­ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì¤‘...', 'info');
                        const applications = await SupabaseAPI.getStudentApplications(result.data.id);
                        debugLog(`âœ… ì‹ ì²­ ë‚´ì—­ ${applications.length}ê±´ ë¡œë“œ ì„±ê³µ!`, 'success');
                        
                        if (applications.length > 0) {
                            // ì‹¤ì œ ë°ì´í„° í‘œì‹œ
                            renderApplications(applications);
                            debugLog('í™”ë©´ì— ì‹ ì²­ ë‚´ì—­ì„ í‘œì‹œí–ˆìŠµë‹ˆë‹¤', 'success');
                            
                            // ì‹ ì²­ ë²„íŠ¼ í™œì„±í™”
                            const newAppBtn = document.getElementById('newApplicationBtn');
                            if (newAppBtn) {
                                newAppBtn.disabled = false;
                                newAppBtn.innerHTML = '<i data-lucide="plus"></i> ìƒˆ êµêµ¬ ì‹ ì²­ (í™œì„±í™”ë¨)';
                                lucide.createIcons();
                            }
                        } else {
                            debugLog('ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤', 'info');
                        }
                        
                    } else {
                        debugLog(`âŒ Supabase ì¸ì¦ ì‹¤íŒ¨: ${result.message}`, 'error');
                    }
                } else {
                    debugLog('SupabaseAPIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                }
                
            } catch (error) {
                debugLog(`í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì´ê°€ì§œë¡œ ì¬ë¡œê·¸ì¸
        async function reLoginAsLeeGaJja() {
            debugLog('=== ì´ê°€ì§œ í•™ìƒ ì¬ë¡œê·¸ì¸ ===', 'info');
            
            try {
                if (!window.SupabaseAPI) {
                    debugLog('SupabaseAPIë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                    return;
                }
                
                debugLog('ì´ê°€ì§œ (1992-02-02) ë¡œê·¸ì¸ ì‹œë„...', 'info');
                const result = await SupabaseAPI.authenticateStudent('ì´ê°€ì§œ', '1992-02-02');
                
                if (result.success) {
                    debugLog('âœ… ì¬ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
                    
                    // localStorageì— ì €ì¥
                    localStorage.setItem('currentStudent', JSON.stringify(result.data));
                    
                    // ì¦‰ì‹œ í…ŒìŠ¤íŠ¸
                    setTimeout(() => testFixedData(), 500);
                    
                } else {
                    debugLog(`âŒ ì¬ë¡œê·¸ì¸ ì‹¤íŒ¨: ${result.message}`, 'error');
                }
                
            } catch (error) {
                debugLog(`ì¬ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì‹ ì²­ ë‚´ì—­ ë Œë”ë§
        function renderApplications(applications) {
            const container = document.getElementById('studentApplications');
            const emptyState = document.getElementById('noApplications');
            
            container.innerHTML = '';
            emptyState.style.display = 'none';
            container.style.display = 'block';
            
            applications.forEach(app => {
                const card = document.createElement('div');
                card.className = 'application-card';
                card.innerHTML = `
                    <div class="application-card-header">
                        <h3>${app.item_name}</h3>
                        <span class="status-badge ${getStatusClass(app.status)}">${getStatusText(app.status)}</span>
                    </div>
                    <div class="application-details">
                        <div class="detail-item">
                            <span class="detail-label">ëª©ì </span>
                            <span class="detail-value">${app.purpose}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ê°€ê²©</span>
                            <span class="detail-value">${app.price.toLocaleString('ko-KR')}ì›</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">êµ¬ë§¤ë°©ì‹</span>
                            <span class="detail-value">${app.purchase_type === 'offline' ? 'ì˜¤í”„ë¼ì¸' : 'ì˜¨ë¼ì¸'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">ì‹ ì²­ì¼</span>
                            <span class="detail-value">${new Date(app.created_at).toLocaleDateString('ko-KR')}</span>
                        </div>
                        ${app.status === 'purchased' ? '<div class="status-info">âœ… êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</div>' : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function getStatusClass(status) {
            const statusMap = {
                'pending': 'warning',
                'approved': 'success', 
                'rejected': 'danger',
                'purchased': 'info',
                'completed': 'info'
            };
            return statusMap[status] || 'secondary';
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ê²€í†  ì¤‘',
                'approved': 'ìŠ¹ì¸ë¨',
                'rejected': 'ë°˜ë ¤ë¨',
                'purchased': 'êµ¬ë§¤ì™„ë£Œ',
                'completed': 'êµ¬ë§¤ì™„ë£Œ'
            };
            return statusMap[status] || status;
        }

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ë¬¸ì œ í•´ê²° í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'success');
            
            // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                debugLog('Lucide ì•„ì´ì½˜ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
            }

            // ì¦‰ì‹œ ë¬¸ì œ ì§„ë‹¨
            setTimeout(() => {
                debugLog('=== ìë™ ë¬¸ì œ ì§„ë‹¨ ì‹œì‘ ===', 'warning');
                inspectStorageData();
            }, 1000);

            // ëŒ€ì‹œë³´ë“œ ì´ë™ ë²„íŠ¼
            const backBtn = document.getElementById('backToDashboard');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    window.location.href = 'dashboard.html';
                });
            }
        });
    </script>
</body>
</html>