<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>문화교구 신청 - 세종학당 문화인턴 지원 시스템</title>
    
    <!-- CSS Files - Updated Cache Busting --> 
    <link rel="stylesheet" href="../css/main.css?v=4.3.1">
    <link rel="stylesheet" href="../css/student.css?v=4.3.1">
    <link rel="stylesheet" href="../css/lesson-plan.css?v=4.3.1">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client - Fixed CDN URL with Cache Busting -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js?v=4.3.1"></script>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        <!-- 수업 계획 작성 페이지 -->
        <div id="lessonPlanPage" class="page">
            <div class="lesson-plan-container">
                <div class="lesson-plan-header">
                    <h1>수업 계획 작성</h1>
                    <p>파견 기간 동안의 상세한 수업 계획을 <strong>필수적으로</strong> 작성해주세요. 관리자가 이 내용을 검토하여 승인 여부를 결정하며, 승인 후에만 교구 신청이 가능합니다.</p>
                </div>

                <div class="lesson-plan-content">
                    <form id="lessonPlanForm">
                        <!-- 기본 정보 입력 -->
                        <div class="basic-info-section">
                            <h2>기본 정보</h2>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>파견 시작일 *</label>
                                    <input type="date" id="startDate" required>
                                </div>
                                <div class="form-group">
                                    <label>파견 종료일 *</label>
                                    <input type="date" id="endDate" required>
                                </div>
                                <div class="form-group">
                                    <label>총 수업 횟수</label>
                                    <div class="lesson-count-display">
                                        <span id="totalLessonsDisplay" class="lesson-count-number">0</span>
                                        <span class="lesson-count-label">회</span>
                                    </div>
                                    <small class="text-muted">아래에서 수업을 추가하면 자동으로 계산됩니다</small>
                                </div>
                            </div>
                        </div>

                        <!-- 수업 계획표 -->
                        <div class="lesson-table-section">
                            <div class="lesson-table-header">
                                <h2>수업 계획표</h2>
                                <button type="button" id="addLessonBtn" class="btn primary">
                                    <i data-lucide="plus"></i>
                                    수업 추가
                                </button>
                            </div>
                            <div class="lesson-plan-requirements">
                                <div class="requirement-notice">
                                    <i data-lucide="alert-circle"></i>
                                    <div>
                                        <strong>필수 제출 사항</strong>
                                        <p>모든 수업의 주제와 내용을 구체적으로 작성해주세요. 수업은 개별적으로 추가/삭제할 수 있으며, 총 수업 횟수는 자동으로 계산됩니다.</p>
                                    </div>
                                </div>
                            </div>
                            <div id="lessonTableContainer" class="lesson-table-container">
                                <div class="empty-lessons-message">
                                    <i data-lucide="calendar-plus"></i>
                                    <p>아직 추가된 수업이 없습니다.</p>
                                    <p>위의 "수업 추가" 버튼을 클릭하여 첫 번째 수업을 추가해보세요.</p>
                                </div>
                            </div>
                        </div>

                        <!-- 추가 정보 -->
                        <div class="additional-info-section">
                            <h2>추가 정보</h2>
                            <div class="form-group">
                                <label>전체 수업 목표 *</label>
                                <textarea id="overallGoals" rows="4" required placeholder="전체 수업을 통해 달성하고자 하는 목표를 구체적으로 입력하세요"></textarea>
                            </div>
                            <div class="form-group">
                                <label>특별 고려사항</label>
                                <textarea id="specialNotes" rows="3" placeholder="현지 상황이나 특별히 고려해야 할 사항이 있으면 입력하세요"></textarea>
                            </div>
                        </div>

                        <!-- 제출 버튼 (동적으로 변경됨) -->
                        <div class="form-actions">
                            <button type="button" id="backToDashboardBtn" class="btn secondary">
                                <i data-lucide="arrow-left"></i>
                                대시보드로 돌아가기
                            </button>
                            <button type="button" id="saveDraftBtn" class="btn secondary">
                                <i data-lucide="save"></i>
                                임시 저장
                            </button>
                            <button type="submit" id="submitLessonPlanBtn" class="btn primary">
                                <i data-lucide="check"></i>
                                수업 계획 완료 및 제출
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 🎨 학생 대시보드 (교구 신청) - 개선된 UI -->
        <div id="studentPage" class="page active">
            <header class="header">
                <div class="header-content">
                    <div class="user-info">
                        <h1 id="studentWelcome">문화교구 신청</h1>
                        <p id="studentDetails">수업에 필요한 교구를 신청하고 관리하세요</p>
                        
                        <!-- 예산 현황 표시 영역 -->
                        <div id="budgetStatus" class="budget-status-container"></div>
                    </div>
                    <div class="header-actions">
                        <button id="lessonPlanBtn" class="btn secondary">
                            <i data-lucide="calendar"></i>
                            수업 계획
                        </button>
                        <button id="shippingAddressBtn" class="btn secondary shipping-address-btn">
                            <i data-lucide="map-pin"></i>
                            배송지 설정
                        </button>
                        <button id="backToDashboard" class="btn secondary">
                            <i data-lucide="arrow-left"></i>
                            대시보드
                        </button>
                    </div>
                </div>
            </header>

            <main class="main-content">
                <div class="dashboard-header">
                    <h2>교구 신청 현황</h2>
                    <div class="dashboard-actions">
                        <button id="bundleApplicationBtn" class="btn secondary">
                            <i data-lucide="shopping-cart"></i>
                            묶음 신청
                        </button>
                        <button id="newApplicationBtn" class="btn primary">
                            <i data-lucide="plus"></i>
                            새 교구 신청
                        </button>
                    </div>
                </div>

                <!-- 🆕 개선된 UI: 온라인/오프라인 분리 표시 -->
                <div id="applicationsContainer" class="applications-container">
                    
                    <!-- 🌐 온라인 대리구매 섹션 -->
                    <div class="applications-section" id="onlineSection">
                        <div class="section-header">
                            <div class="section-title">
                                <i data-lucide="shopping-cart" class="section-icon online"></i>
                                <h3>온라인 대리구매</h3>
                                <span class="section-subtitle">관리자가 대신 구매하여 배송</span>
                            </div>
                            <div class="section-stats" id="onlineStats">
                                <span class="stat-item">
                                    <span class="stat-number" id="onlineCount">0</span>
                                    <span class="stat-label">건</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-number" id="onlineTotalPrice">0원</span>
                                    <span class="stat-label">총액</span>
                                </span>
                            </div>
                        </div>
                        
                        <div id="onlineApplications" class="applications-grid">
                            <!-- 동적으로 생성될 온라인 신청 내역 -->
                        </div>
                        
                        <div id="noOnlineApplications" class="empty-state-mini" style="display: none;">
                            <i data-lucide="shopping-cart" class="empty-icon-small"></i>
                            <p>온라인 구매 신청이 없습니다</p>
                            <small>관리자가 대신 구매해드리는 방식입니다</small>
                        </div>
                    </div>

                    <!-- 🏪 오프라인 직접구매 섹션 -->
                    <div class="applications-section" id="offlineSection">
                        <div class="section-header">
                            <div class="section-title">
                                <i data-lucide="store" class="section-icon offline"></i>
                                <h3>오프라인 직접구매</h3>
                                <span class="section-subtitle">직접 구매 후 영수증 제출로 정산</span>
                            </div>
                            <div class="section-stats" id="offlineStats">
                                <span class="stat-item">
                                    <span class="stat-number" id="offlineCount">0</span>
                                    <span class="stat-label">건</span>
                                </span>
                                <span class="stat-item">
                                    <span class="stat-number" id="offlineTotalPrice">0원</span>
                                    <span class="stat-label">총액</span>
                                </span>
                            </div>
                        </div>
                        
                        <div id="offlineApplications" class="applications-grid">
                            <!-- 동적으로 생성될 오프라인 신청 내역 -->
                        </div>
                        
                        <div id="noOfflineApplications" class="empty-state-mini" style="display: none;">
                            <i data-lucide="store" class="empty-icon-small"></i>
                            <p>오프라인 구매 신청이 없습니다</p>
                            <small>본인이 직접 구매하는 방식입니다</small>
                        </div>
                    </div>
                </div>

                <!-- 전체 빈 상태 (둘 다 없을 때) -->
                <div id="noApplications" class="empty-state" style="display: none;">
                    <i data-lucide="package" class="empty-icon"></i>
                    <h3>아직 신청한 교구가 없습니다</h3>
                    <p>새 교구 신청 버튼을 클릭하여 첫 번째 교구를 신청해보세요</p>
                    <button class="btn primary empty-state-btn" id="emptyStateNewBtn">
                        <i data-lucide="plus"></i>
                        첫 교구 신청하기
                    </button>
                </div>

                <!-- 🆕 숨겨진 기존 컨테이너 (하위 호환성) -->
                <div id="studentApplications" class="applications-grid" style="display: none;">
                    <!-- 기존 코드와의 호환성을 위해 유지 -->
                </div>
            </main>
        </div>
    </div>

    <!-- 교구 신청 모달 -->
    <div id="applicationModal" class="modal">
        <div class="modal-content">
            <h3 id="applicationModalTitle">새 교구 신청</h3>
            <form id="applicationForm">
                <!-- 구매 방식 선택 -->
                <div class="form-group">
                    <label>구매 방식 *</label>
                    <div class="purchase-method-options">
                        <label class="radio-option">
                            <input type="radio" name="purchaseMethod" value="online" checked>
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>온라인 구매</strong>
                                <p>관리자가 대신 구매하여 배송</p>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="purchaseMethod" value="offline">
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>오프라인 구매</strong>
                                <p>직접 구매 후 영수증 제출로 비용 정산</p>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>교구명 *</label>
                    <input type="text" id="itemName" name="itemName" required placeholder="교구 이름을 입력하세요">
                </div>
                <div class="form-group">
                    <label>사용 목적 *</label>
                    <textarea id="itemPurpose" name="itemPurpose" required rows="3" placeholder="교구 사용 목적을 설명하세요"></textarea>
                </div>
                <div class="form-group">
                    <label>가격 (원) *</label>
                    <input type="number" id="itemPrice" name="itemPrice" required placeholder="가격을 입력하세요">
                </div>
                <div class="form-group" id="itemLinkGroup">
                    <label id="itemLinkLabel">구매 링크 *</label>
                    <input type="url" id="itemLink" name="itemLink" required placeholder="구매 가능한 링크를 입력하세요">
                </div>
                <div class="modal-actions">
                    <button type="button" id="cancelBtn" class="btn secondary">취소</button>
                    <button type="submit" class="btn primary" id="submitBtn">신청하기</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 📦 묶음 신청 모달 - v4.3.0 완전 재설계 (4가지 타입별 최적화) -->
    <div id="bundleModal" class="modal">
        <div class="modal-content">
            <h3>묶음 교구 신청 <span class="version-badge">v4.3.0</span></h3>
            <div class="bundle-intro">
                <p>여러 교구를 한 번에 신청할 때 사용하세요. 구매 방식에 따라 필요한 정보가 다릅니다.</p>
            </div>
            
            <form id="bundleForm">
                <!-- 기본 정보 -->
                <div class="form-section">
                    <h4><i data-lucide="info"></i> 기본 정보</h4>
                    
                    <div class="form-group">
                        <label>묶음 제목 *</label>
                        <input type="text" id="bundleTitle" name="bundleTitle" required placeholder="묶음 교구를 대표하는 제목을 입력하세요">
                        <small class="text-muted">예: 한국 전통문화 체험 교구 세트, K-POP 댄스 수업용 도구 묶음</small>
                    </div>
                    
                    <div class="form-group">
                        <label>사용 목적 *</label>
                        <textarea id="bundlePurpose" name="bundlePurpose" required rows="3" placeholder="이 묶음 교구들을 어떤 목적으로 사용할 예정인지 구체적으로 설명해주세요"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>구매 총액 (원) *</label>
                        <input type="number" id="bundleTotalPrice" name="bundleTotalPrice" required min="1" placeholder="예상 총 구매 금액을 입력하세요">
                        <small class="text-muted">모든 교구의 예상 총액 (배송비 포함)</small>
                    </div>
                </div>
                
                <!-- 🎯 v4.3.0 구매 방식 선택 - 4가지 타입별 최적화 -->
                <div class="form-section">
                    <h4><i data-lucide="shopping-cart"></i> 구매 방식 선택</h4>
                    <div class="purchase-method-options">
                        <label class="radio-option enhanced">
                            <input type="radio" name="bundlePurchaseMethod" value="online" checked>
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>온라인 구매</strong>
                                <p>관리자가 학생 계정으로 대신 구매</p>
                                <div class="method-features">
                                    <span class="feature-tag">계정 정보 필요</span>
                                    <span class="feature-tag">장바구니 준비</span>
                                </div>
                            </div>
                        </label>
                        <label class="radio-option enhanced">
                            <input type="radio" name="bundlePurchaseMethod" value="offline">
                            <span class="radio-custom"></span>
                            <div class="radio-content">
                                <strong>오프라인 구매</strong>
                                <p>직접 구매 후 영수증 제출로 비용 정산</p>
                                <div class="method-features">
                                    <span class="feature-tag">구매처 정보 필요</span>
                                    <span class="feature-tag">영수증 제출</span>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- 🆕 v4.3.0 온라인 구매 정보 (account_id, account_pw 활용) -->
                <div id="onlinePurchaseInfo" class="purchase-info-section">
                    <div class="form-section">
                        <h4><i data-lucide="globe"></i> 온라인 구매 정보</h4>
                        
                        <div class="form-group">
                            <label>구매 사이트 *</label>
                            <select id="purchaseSite" name="purchaseSite" required>
                                <option value="">구매 사이트를 선택하세요</option>
                                <option value="coupang">쿠팡 (Coupang)</option>
                                <option value="11st">11번가</option>
                                <option value="gmarket">지마켓 (Gmarket)</option>
                                <option value="auction">옥션 (Auction)</option>
                                <option value="interpark">인터파크</option>
                                <option value="lotte">롯데온</option>
                                <option value="ssg">SSG.COM</option>
                                <option value="yes24">YES24</option>
                                <option value="kyobo">교보문고</option>
                                <option value="other">기타 (직접 입력)</option>
                            </select>
                            <input type="url" id="otherSite" name="otherSite" placeholder="기타 사이트 URL을 입력하세요 (예: https://example.com)" style="display: none; margin-top: 8px;">
                        </div>
                        
                        <!-- 🔐 v4.3.0 계정 정보 (별도 컬럼으로 저장) -->
                        <div class="account-info-section">
                            <div class="account-info-header">
                                <i data-lucide="shield-check"></i>
                                <div>
                                    <h5>계정 정보 (v4.3.0 보안 강화)</h5>
                                    <p>관리자가 대신 구매하기 위한 계정 정보입니다. 암호화되어 안전하게 저장됩니다.</p>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>계정 아이디 *</label>
                                <input type="text" id="accountId" name="accountId" required placeholder="구매 사이트 로그인 아이디">
                                <small class="text-muted">관리자가 대신 주문하기 위한 계정 아이디</small>
                            </div>
                            
                            <div class="form-group">
                                <label>계정 비밀번호 *</label>
                                <input type="password" id="accountPassword" name="accountPassword" required placeholder="구매 사이트 로그인 비밀번호">
                                <small class="text-muted">⚠️ 보안을 위해 암호화되어 저장되며, 구매 완료 후 즉시 삭제됩니다</small>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>장바구니 메모 (선택)</label>
                            <textarea id="cartNote" name="cartNote" rows="3" placeholder="장바구니에 담은 상품들에 대한 설명이나 특별 요청사항이 있으면 입력하세요&#10;&#10;예: 
- 한복 재료: 성인용 한복 원단 5세트
- 전통 악기: 소고 10개, 장구 3개  
- 포장 요청: 개별 포장 필요"></textarea>
                            <small class="text-muted">관리자가 장바구니를 찾기 쉽도록 구체적으로 작성해주세요</small>
                        </div>
                    </div>
                </div>

                <!-- 🆕 v4.3.0 오프라인 구매 정보 (store_info 활용) -->
                <div id="offlinePurchaseInfo" class="purchase-info-section" style="display: none;">
                    <div class="form-section">
                        <h4><i data-lucide="store"></i> 오프라인 구매 정보</h4>
                        
                        <div class="form-group">
                            <label>구매 업체 정보 *</label>
                            <textarea id="offlineVendor" name="offlineVendor" required rows="4" placeholder="구매 예정 업체의 상세 정보를 입력하세요&#10;&#10;예:
업체명: 한국전통문화센터
주소: 서울시 종로구 인사동길 123
연락처: 02-1234-5678
홈페이지: www.example.com"></textarea>
                            <small class="text-muted">영수증 확인을 위해 정확한 업체 정보가 필요합니다</small>
                        </div>
                        
                        <div class="form-group">
                            <label>구매 계획 (선택)</label>
                            <textarea id="purchasePlan" name="purchasePlan" rows="3" placeholder="구매 일정이나 방법에 대한 구체적인 계획을 입력하세요&#10;&#10;예:
- 구매 예정일: 2025년 1월 15일
- 구매 방법: 업체 방문 또는 전화 주문
- 배송 방법: 업체 직접 배송"></textarea>
                            <small class="text-muted">관리자가 승인 여부를 판단하는데 도움이 됩니다</small>
                        </div>

                        <!-- 📋 오프라인 구매 안내사항 -->
                        <div class="offline-notice">
                            <i data-lucide="info"></i>
                            <div>
                                <strong>오프라인 구매 안내</strong>
                                <ul>
                                    <li>구매 후 <strong>7일 이내</strong>에 영수증을 제출해주세요</li>
                                    <li>영수증은 구매처명, 구매일, 금액이 명확히 표시되어야 합니다</li>
                                    <li>분할 구매 시 모든 영수증을 각각 제출해주세요</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" id="bundleCancelBtn" class="btn secondary">취소</button>
                    <button type="submit" class="btn primary">
                        <i data-lucide="shopping-cart"></i>
                        묶음 신청하기
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 배송지 설정 모달 -->
    <div id="shippingModal" class="modal">
        <div class="modal-content">
            <h3>배송지 설정</h3>
            <form id="shippingForm">
                <div class="form-group">
                    <label>받는 분 *</label>
                    <input type="text" id="shippingName" name="shippingName" required placeholder="받는 분 성명을 입력하세요">
                </div>
                <div class="form-group">
                    <label>연락처 *</label>
                    <input type="tel" id="shippingPhone" name="shippingPhone" required placeholder="연락처를 입력하세요">
                </div>
                <div class="form-group">
                    <label>주소 *</label>
                    <textarea id="shippingAddress" name="shippingAddress" required rows="3" placeholder="상세 주소를 입력하세요&#10;예: 서울특별시 강남구 테헤란로 123, 456호"></textarea>
                </div>
                <div class="form-group">
                    <label>우편번호</label>
                    <input type="text" id="shippingPostcode" name="shippingPostcode" placeholder="우편번호 (선택)">
                </div>
                <div class="form-group">
                    <label>배송 요청사항</label>
                    <textarea id="shippingNote" name="shippingNote" rows="2" placeholder="배송 시 요청사항이 있으면 입력하세요"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" id="shippingCancelBtn" class="btn secondary">취소</button>
                    <button type="submit" class="btn primary">저장하기</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 영수증 등록 모달 - UX 개선 v4.3.0 -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <h3>영수증 등록</h3>
            <form id="receiptForm">
                <div class="receipt-info">
                    <div class="receipt-item-info">
                        <h4 id="receiptItemName">교구명</h4>
                        <p id="receiptItemPrice">가격: </p>
                    </div>
                </div>
                
                <!-- 📸 영수증 파일 업로드 영역 - 개선된 UI -->
                <div class="form-group">
                    <label>영수증 이미지 *</label>
                    <div class="file-upload-area" id="receiptDropZone">
                        <input type="file" id="receiptFile" accept="image/*,application/pdf" required>
                        <div class="file-upload-content" id="uploadContent">
                            <i data-lucide="upload"></i>
                            <p>영수증 이미지를 선택하거나 여기에 드래그하세요</p>
                            <small>JPG, PNG, PDF 파일 지원 (최대 5MB)</small>
                        </div>
                        
                        <!-- 📄 파일 선택됨 상태 표시 -->
                        <div id="fileSelectedContent" class="file-selected-content" style="display: none;">
                            <div class="file-info">
                                <i data-lucide="file-check" class="file-icon"></i>
                                <div class="file-details">
                                    <div id="receiptFileName" class="file-name"></div>
                                    <div id="receiptFileSize" class="file-size"></div>
                                </div>
                                <button type="button" id="removeReceiptBtn" class="btn small danger">
                                    <i data-lucide="x"></i>
                                    제거
                                </button>
                            </div>
                        </div>
                        
                        <!-- 🖼️ 이미지 미리보기 -->
                        <div id="receiptPreview" class="receipt-preview" style="display: none;">
                            <!-- 동적으로 생성됨 -->
                        </div>
                    </div>
                </div>
                
                <!-- 📅 구매 날짜 (시간 정보 제거) -->
                <div class="form-group">
                    <label>구매 날짜 *</label>
                    <input type="date" id="purchaseDate" name="purchaseDate" required>
                    <small class="text-muted">영수증에 표시된 구매 날짜를 선택하세요</small>
                </div>
                
                <div class="form-group">
                    <label>구매처</label>
                    <input type="text" id="purchaseStore" name="purchaseStore" placeholder="구매한 상점명을 입력하세요">
                </div>
                
                <div class="form-group">
                    <label>비고</label>
                    <textarea id="receiptNote" name="receiptNote" rows="2" placeholder="추가 설명이 있으면 입력하세요"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" id="receiptCancelBtn" class="btn secondary">취소</button>
                    <button type="submit" class="btn primary">영수증 제출</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 시스템 오류 알림 모달 -->
    <div id="systemErrorModal" class="modal">
        <div class="modal-content">
            <h3>시스템 오류</h3>
            <div id="systemErrorContent">
                <div class="error-info">
                    <i data-lucide="alert-triangle" style="width: 48px; height: 48px; color: #ef4444;"></i>
                    <div>
                        <h4>페이지를 정상적으로 로드할 수 없습니다</h4>
                        <p id="systemErrorMessage">시스템 초기화 중 오류가 발생했습니다.</p>
                    </div>
                </div>
                <div class="error-actions">
                    <button id="refreshPageBtn" class="btn primary">
                        <i data-lucide="refresh-cw"></i>
                        페이지 새로고침
                    </button>
                    <button id="clearCacheBtn" class="btn secondary">
                        <i data-lucide="trash-2"></i>
                        캐시 지우고 다시 시도
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files - v4.3.1 모듈화 시스템 및 부분 로딩 허용 -->
    
    <!-- 🔧 1단계: 핵심 설정 파일들 (의존성 순서) -->
    <script src="../js/config.js?v=4.3.1"></script>
    <script src="../js/auth.js?v=4.3.1"></script>
    <script src="../js/utils.js?v=4.3.1"></script>

    <!-- 🔧 2단계: Supabase 모듈들 (의존성 순서 중요) -->
    <script src="../js/supabase/supabase-core.js?v=4.3.1"></script>
    <script src="../js/supabase/supabase-student.js?v=4.3.1"></script>
    <script src="../js/supabase/supabase-admin.js?v=4.3.1"></script>
    <script src="../js/supabase-client.js?v=4.3.1"></script>

    <!-- 🔧 3단계: 학생 모듈 시스템 (의존성 순서대로) -->
    <script src="../js/student/api-helper.js?v=4.3.1"></script>
    <script src="../js/student/notification-system.js?v=4.3.1"></script>
    <script src="../js/student/lesson-plan-helper.js?v=4.3.1"></script>
    <script src="../js/student/equipment-request.js?v=4.3.1"></script>
    <script src="../js/student/shipping-management.js?v=4.3.1"></script>
    <script src="../js/student/receipt-management.js?v=4.3.1"></script>
    <script src="../js/student/flight-request.js?v=4.3.1"></script>

    <!-- 🔧 4단계: 수업 계획 및 통합 매니저 -->
    <script src="../js/lesson-plan.js?v=4.3.1"></script>
    <script src="../js/student.js?v=4.3.1"></script>

    <!-- 🔧 5단계: 모듈 로딩 안전장치 및 초기화 시스템 v4.3.1 -->
    <script>
        /**
         * 🚀 Equipment Request 페이지 초기화 v4.3.1 - 개선된 UI 적용
         * - ✅ 부분 로딩 허용: 80% 이상 로드되면 진행
         * - ✅ 필수 모듈만 엄격 체크: 핵심 기능만 필수
         * - ✅ 타임아웃 시간 연장: 20초
         * - ✅ 상세한 디버깅 정보 제공
         * - ✅ graceful degradation: 선택적 모듈 없어도 진행
         * - 🆕 온라인/오프라인 분리 UI 적용
         */

        // 🛡️ 모듈 로딩 상태 추적 v4.3.1
        window.ModuleStatusTracker = {
            modules: {
                // 필수 모듈 (반드시 로드되어야 함)
                CONFIG: false,
                AUTH: false,
                UTILS: false,
                SUPABASE_CORE: false,
                SUPABASE_CLIENT: false,
                STUDENT_MANAGER: false,
                
                // 선택적 모듈 (없어도 기본 기능 동작)
                SUPABASE_STUDENT: false,
                SUPABASE_ADMIN: false,
                API_HELPER: false,
                NOTIFICATION_SYSTEM: false,
                LESSON_PLAN_HELPER: false,
                EQUIPMENT_REQUEST: false,
                SHIPPING_MANAGEMENT: false,
                RECEIPT_MANAGEMENT: false,
                FLIGHT_REQUEST: false,
                LESSON_PLAN: false
            },
            isInitialized: false,
            
            updateStatus: function() {
                if (this.isInitialized) return; // 중복 실행 방지
                
                // 필수 모듈
                this.modules.CONFIG = typeof CONFIG !== 'undefined';
                this.modules.AUTH = typeof AuthManager !== 'undefined';
                this.modules.UTILS = typeof checkConnection !== 'undefined';
                this.modules.SUPABASE_CORE = typeof SupabaseCore !== 'undefined';
                this.modules.SUPABASE_CLIENT = typeof SupabaseAPI !== 'undefined';
                this.modules.STUDENT_MANAGER = typeof StudentManager !== 'undefined';
                
                // 선택적 모듈
                this.modules.SUPABASE_STUDENT = typeof SupabaseStudent !== 'undefined';
                this.modules.SUPABASE_ADMIN = typeof SupabaseAdmin !== 'undefined';
                this.modules.API_HELPER = typeof ApiHelper !== 'undefined';
                this.modules.NOTIFICATION_SYSTEM = typeof NotificationSystem !== 'undefined';
                this.modules.LESSON_PLAN_HELPER = typeof LessonPlanHelper !== 'undefined';
                this.modules.EQUIPMENT_REQUEST = typeof EquipmentRequestModule !== 'undefined';
                this.modules.SHIPPING_MANAGEMENT = typeof ShippingManagement !== 'undefined';
                this.modules.RECEIPT_MANAGEMENT = typeof ReceiptManagement !== 'undefined';
                this.modules.FLIGHT_REQUEST = typeof FlightRequestModule !== 'undefined';
                this.modules.LESSON_PLAN = typeof LessonPlanManager !== 'undefined';
            },
            
            checkRequiredModules: function() {
                this.updateStatus();
                
                // 필수 모듈만 체크
                const requiredModules = [
                    'CONFIG', 'AUTH', 'UTILS', 'SUPABASE_CORE', 'SUPABASE_CLIENT', 'STUDENT_MANAGER'
                ];
                
                const missingRequired = requiredModules.filter(module => !this.modules[module]);
                
                if (missingRequired.length === 0) {
                    return true;
                }
                
                console.error('❌ 누락된 필수 모듈:', missingRequired);
                return false;
            },
            
            checkPartialLoading: function() {
                this.updateStatus();
                
                const loadedCount = Object.values(this.modules).filter(Boolean).length;
                const totalCount = Object.keys(this.modules).length;
                const percentage = Math.round((loadedCount / totalCount) * 100);
                
                // 80% 이상 로드되면 부분 로딩 허용
                if (percentage >= 80) {
                    return true;
                }
                
                return false;
            },
            
            checkAllModules: function() {
                if (this.isInitialized) return true; // 중복 확인 방지
                
                // 1. 필수 모듈 체크
                if (this.checkRequiredModules()) {
                    this.isInitialized = true;
                    return true;
                }
                
                // 2. 부분 로딩 체크 (80% 이상)
                if (this.checkPartialLoading()) {
                    console.warn('⚠️ 부분 로딩으로 진행 (일부 기능 제한 가능)');
                    this.isInitialized = true;
                    return true;
                }
                
                return false;
            },
            
            getStatus: function() {
                this.updateStatus();
                const loadedCount = Object.values(this.modules).filter(Boolean).length;
                const totalCount = Object.keys(this.modules).length;
                
                // 필수/선택적 모듈 구분하여 상태 반환
                const requiredModules = ['CONFIG', 'AUTH', 'UTILS', 'SUPABASE_CORE', 'SUPABASE_CLIENT', 'STUDENT_MANAGER'];
                const requiredLoaded = requiredModules.filter(module => this.modules[module]).length;
                const requiredTotal = requiredModules.length;
                
                return {
                    loaded: loadedCount,
                    total: totalCount,
                    percentage: Math.round((loadedCount / totalCount) * 100),
                    requiredLoaded: requiredLoaded,
                    requiredTotal: requiredTotal,
                    requiredPercentage: Math.round((requiredLoaded / requiredTotal) * 100),
                    modules: this.modules,
                    missingRequired: requiredModules.filter(module => !this.modules[module]),
                    missingOptional: Object.keys(this.modules).filter(module => 
                        !requiredModules.includes(module) && !this.modules[module])
                };
            }
        };

        // 🆕 시스템 오류 모달 표시 함수
        function showSystemErrorModal(errorMessage) {
            try {
                const modal = document.getElementById('systemErrorModal');
                const messageEl = document.getElementById('systemErrorMessage');
                
                if (modal && messageEl) {
                    messageEl.textContent = errorMessage || '알 수 없는 오류가 발생했습니다.';
                    modal.style.display = 'flex';
                    
                    // 새로고침 버튼
                    const refreshBtn = document.getElementById('refreshPageBtn');
                    if (refreshBtn) {
                        refreshBtn.onclick = function() {
                            window.location.reload(true);
                        };
                    }
                    
                    // 캐시 지우기 버튼
                    const clearCacheBtn = document.getElementById('clearCacheBtn');
                    if (clearCacheBtn) {
                        clearCacheBtn.onclick = function() {
                            if ('caches' in window) {
                                caches.keys().then(function(names) {
                                    names.forEach(function(name) {
                                        caches.delete(name);
                                    });
                                }).finally(function() {
                                    localStorage.clear();
                                    sessionStorage.clear();
                                    window.location.reload(true);
                                });
                            } else {
                                localStorage.clear();
                                sessionStorage.clear();
                                window.location.reload(true);
                            }
                        };
                    }
                }
            } catch (error) {
                console.error('❌ 시스템 오류 모달 표시 실패:', error);
                alert('페이지를 새로고침해주세요: ' + (errorMessage || '시스템 오류'));
            }
        }

        // 🔧 모듈 로딩 완료 대기 함수 v4.3.1 (부분 로딩 허용)
        function waitForModulesReady(maxWait = 20000) {
            return new Promise(function(resolve, reject) {
                const startTime = Date.now();
                const checkInterval = 500;
                
                function checkModules() {
                    const status = window.ModuleStatusTracker.getStatus();
                    
                    // 상세한 로딩 상태 로그 (오류만 표시)
                    if (status.loaded < status.total) {
                        if (status.missingRequired.length > 0) {
                            console.error('❌ 누락된 필수 모듈:', status.missingRequired);
                        }
                    }
                    
                    if (window.ModuleStatusTracker.checkAllModules()) {
                        resolve();
                        return;
                    }
                    
                    const elapsedTime = Date.now() - startTime;
                    if (elapsedTime >= maxWait) {
                        console.error('❌ 모듈 로딩 시간 초과 v4.3.1:', status);
                        
                        // 필수 모듈이 모두 로드되었다면 부분 진행
                        if (status.requiredPercentage === 100) {
                            console.warn('⚠️ 필수 모듈만으로 부분 진행');
                            resolve();
                            return;
                        }
                        
                        reject(new Error('모듈 로딩 시간 초과'));
                        return;
                    }
                    
                    setTimeout(checkModules, checkInterval);
                }
                
                checkModules();
            });
        }

        // 🎯 사용자 정보 로드 및 UI 업데이트
        function getCurrentUserSafely() {
            try {
                // ApiHelper 모듈 사용 (선택적)
                if (typeof window.ApiHelper !== 'undefined' && window.ApiHelper.getCurrentUserSafely) {
                    return window.ApiHelper.getCurrentUserSafely();
                }

                // 폴백: localStorage
                const currentStudentData = localStorage.getItem('currentStudent');
                if (currentStudentData) {
                    try {
                        const studentData = JSON.parse(currentStudentData);
                        if (studentData && studentData.id) {
                            return studentData;
                        }
                    } catch (parseError) {
                        console.error('❌ localStorage 파싱 오류:', parseError);
                    }
                }

                return null;
            } catch (error) {
                console.error('❌ 사용자 정보 로드 오류:', error);
                return null;
            }
        }

        // 🆕 수업계획 상태 확인 및 페이지 분기 (오류 허용)
        async function checkLessonPlanStatusAndSetPage() {
            try {
                const currentUser = getCurrentUserSafely();
                if (!currentUser) {
                    console.error('❌ 사용자 정보 없음 - 로그인 페이지로 이동');
                    redirectToLogin();
                    return;
                }

                // SupabaseAPI를 통한 수업계획 조회 (필수 모듈이므로 안전)
                const client = await SupabaseAPI.ensureClient();
                const { data: lessonPlan, error } = await client
                    .from('lesson_plans')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('❌ 수업계획 조회 오류:', error);
                    showLessonPlanPage();
                    return;
                }

                if (!lessonPlan) {
                    showLessonPlanPage();
                } else {
                    showStudentPage();
                }

            } catch (error) {
                console.error('❌ 수업계획 상태 확인 오류:', error);
                // 오류 발생 시에도 기본 페이지 표시
                showStudentPage();
            }
        }

        // 수업계획 페이지 표시
        function showLessonPlanPage() {
            try {
                const studentPage = document.getElementById('studentPage');
                const lessonPlanPage = document.getElementById('lessonPlanPage');
                
                if (studentPage && lessonPlanPage) {
                    studentPage.classList.remove('active');
                    lessonPlanPage.classList.add('active');
                    
                    setTimeout(() => {
                        if (window.LessonPlanManager && typeof window.LessonPlanManager.showLessonPlanPage === 'function') {
                            window.LessonPlanManager.showLessonPlanPage('create');
                        }
                    }, 200);
                }
            } catch (error) {
                console.error('❌ 수업계획 페이지 표시 오류:', error);
            }
        }

        // 교구신청 페이지 표시
        function showStudentPage() {
            try {
                const studentPage = document.getElementById('studentPage');
                const lessonPlanPage = document.getElementById('lessonPlanPage');
                
                if (studentPage && lessonPlanPage) {
                    lessonPlanPage.classList.remove('active');
                    studentPage.classList.add('active');
                }
            } catch (error) {
                console.error('❌ 교구신청 페이지 표시 오류:', error);
            }
        }

        // 🎯 네비게이션 설정
        function setupNavigation() {
            // 대시보드로 돌아가기
            const backBtn = document.getElementById('backToDashboard');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    window.location.href = 'dashboard.html';
                });
            }

            // 수업계획 버튼
            const lessonPlanBtn = document.getElementById('lessonPlanBtn');
            if (lessonPlanBtn) {
                lessonPlanBtn.addEventListener('click', function() {
                    if (typeof StudentManager !== 'undefined' && 
                        typeof StudentManager.handleLessonPlanClick === 'function') {
                        try {
                            StudentManager.handleLessonPlanClick();
                        } catch (error) {
                            console.error('❌ 수업계획 처리 오류:', error);
                            alert('수업계획 처리 중 오류가 발생했습니다.');
                        }
                    } else {
                        alert('시스템이 아직 로딩 중입니다. 잠시 후 다시 시도해주세요.');
                    }
                });
            }

            // 배송지 설정 버튼
            const shippingAddressBtn = document.getElementById('shippingAddressBtn');
            if (shippingAddressBtn) {
                shippingAddressBtn.addEventListener('click', function() {
                    if (typeof StudentManager !== 'undefined' && 
                        typeof StudentManager.handleShippingClick === 'function') {
                        StudentManager.handleShippingClick();
                    } else {
                        alert('배송지 설정 기능을 사용할 수 없습니다.');
                    }
                });
            }

            // 🆕 v4.3.1 전체 빈 상태에서 신청 버튼
            const emptyStateNewBtn = document.getElementById('emptyStateNewBtn');
            if (emptyStateNewBtn) {
                emptyStateNewBtn.addEventListener('click', function() {
                    const newApplicationBtn = document.getElementById('newApplicationBtn');
                    if (newApplicationBtn) {
                        newApplicationBtn.click();
                    }
                });
            }
        }

        // 🆕 v4.3.1 묶음 신청 UI 이벤트 설정 (호환성 유지)
        function setupBundleModalEvents() {
            try {
                // 구매 방식 라디오 버튼 이벤트
                const bundlePurchaseMethodRadios = document.querySelectorAll('input[name="bundlePurchaseMethod"]');
                bundlePurchaseMethodRadios.forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        if (radio.checked && typeof window.toggleBundlePurchaseInfo === 'function') {
                            window.toggleBundlePurchaseInfo(radio.value);
                        }
                    });
                });

                // 구매 사이트 선택 변경 이벤트
                const purchaseSiteSelect = document.getElementById('purchaseSite');
                if (purchaseSiteSelect && typeof window.handlePurchaseSiteChange === 'function') {
                    purchaseSiteSelect.addEventListener('change', window.handlePurchaseSiteChange);
                }

                // 초기 상태 설정
                if (typeof window.toggleBundlePurchaseInfo === 'function') {
                    window.toggleBundlePurchaseInfo('online');
                }
            } catch (error) {
                console.error('❌ 묶음 신청 UI 이벤트 설정 오류:', error);
            }
        }

        // v4.3.1 호환성 함수들
        window.toggleBundlePurchaseInfo = function(method) {
            const onlineInfo = document.getElementById('onlinePurchaseInfo');
            const offlineInfo = document.getElementById('offlinePurchaseInfo');
            
            if (method === 'online') {
                if (onlineInfo) onlineInfo.style.display = 'block';
                if (offlineInfo) offlineInfo.style.display = 'none';
                
                setFieldRequired('purchaseSite', true);
                setFieldRequired('accountId', true);
                setFieldRequired('accountPassword', true);
                setFieldRequired('offlineVendor', false);
                
            } else if (method === 'offline') {
                if (onlineInfo) onlineInfo.style.display = 'none';
                if (offlineInfo) offlineInfo.style.display = 'block';
                
                setFieldRequired('purchaseSite', false);
                setFieldRequired('accountId', false);
                setFieldRequired('accountPassword', false);
                setFieldRequired('offlineVendor', true);
            }
        };

        window.handlePurchaseSiteChange = function() {
            const siteSelect = document.getElementById('purchaseSite');
            const otherSiteInput = document.getElementById('otherSite');
            
            if (siteSelect && otherSiteInput) {
                if (siteSelect.value === 'other') {
                    otherSiteInput.style.display = 'block';
                    otherSiteInput.required = true;
                } else {
                    otherSiteInput.style.display = 'none';
                    otherSiteInput.required = false;
                    otherSiteInput.value = '';
                }
            }
        };

        function setFieldRequired(fieldId, required) {
            const field = document.getElementById(fieldId);
            if (field) {
                field.required = required;
                
                const label = document.querySelector(`label[for="${fieldId}"]`) || 
                            field.closest('.form-group')?.querySelector('label');
                if (label) {
                    const text = label.textContent.replace(' *', '');
                    label.textContent = required ? text + ' *' : text;
                }
            }
        }

        function redirectToLogin() {
            if (confirm('로그인 페이지로 이동하시겠습니까?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '../index.html';
            }
        }

        // 🚀 메인 초기화 함수 v4.3.1 (부분 로딩 허용)
        async function initializeEquipmentRequestPage() {
            try {
                console.log('🎨 v4.3.1 개선된 UI 초기화 시작');
                
                // 모듈 로딩 대기 (부분 로딩 허용)
                await waitForModulesReady();
                
                // 사용자 정보 로드 및 UI 업데이트
                const currentUser = getCurrentUserSafely();
                if (!currentUser) {
                    throw new Error('로그인 세션이 없습니다');
                }

                // 사용자 인터페이스 업데이트
                const welcomeEl = document.getElementById('studentWelcome');
                if (welcomeEl) {
                    welcomeEl.textContent = `${currentUser.name}님의 교구 신청`;
                }
                
                const detailsEl = document.getElementById('studentDetails');
                if (detailsEl) {
                    const institute = currentUser.sejong_institute || '세종학당';
                    const field = currentUser.field || '';
                    detailsEl.textContent = field ? `${institute} - ${field}` : institute;
                }

                // 수업계획 상태 확인 및 페이지 분기 (오류 허용)
                await checkLessonPlanStatusAndSetPage();
                
                // 🆕 v4.3.1 개선된 UI용 렌더링 함수 오버라이드
                setupImprovedUI();
                
                // StudentManager 초기화 (안전한 체크)
                const studentPage = document.getElementById('studentPage');
                if (studentPage && studentPage.classList.contains('active')) {
                    if (typeof StudentManager !== 'undefined') {
                        try {
                            await StudentManager.init();
                        } catch (managerError) {
                            console.error('❌ StudentManager 초기화 오류 (계속 진행):', managerError);
                        }
                    }
                }
                
                // 네비게이션 설정
                setupNavigation();
                
                // v4.3.1 묶음 신청 UI 이벤트 설정
                setupBundleModalEvents();
                
                console.log('✅ v4.3.1 개선된 UI 초기화 완료');
                
            } catch (error) {
                console.error('❌ 페이지 초기화 실패:', error);
                
                if (error.message.includes('로그인 세션')) {
                    setTimeout(function() {
                        alert('로그인 세션이 만료되었습니다. 다시 로그인해주세요.');
                        window.location.href = '../index.html';
                    }, 1000);
                } else {
                    showSystemErrorModal('페이지 초기화에 실패했습니다: ' + error.message);
                }
            }
        }

        // 🎨 v4.3.1 개선된 UI 설정 함수
        function setupImprovedUI() {
            try {
                console.log('🎨 v4.3.1 개선된 UI 렌더링 함수 설정');
                
                // EquipmentRequestModule이 로드되었다면 렌더링 함수 오버라이드
                if (typeof window.EquipmentRequestModule !== 'undefined') {
                    
                    // 기존 renderApplications 함수를 새로운 버전으로 교체
                    window.EquipmentRequestModule.renderApplicationsGrouped = function(applications) {
                        try {
                            console.log('🎨 개선된 UI로 교구신청 렌더링:', applications);
                            
                            const onlineContainer = document.getElementById('onlineApplications');
                            const offlineContainer = document.getElementById('offlineApplications');
                            const noOnlineState = document.getElementById('noOnlineApplications');
                            const noOfflineState = document.getElementById('noOfflineApplications');
                            const noApplicationsState = document.getElementById('noApplications');
                            const applicationsContainer = document.getElementById('applicationsContainer');
                            
                            // 온라인/오프라인으로 분류
                            const onlineApplications = applications.filter(app => app.purchase_type === 'online');
                            const offlineApplications = applications.filter(app => app.purchase_type === 'offline');
                            
                            // 전체 빈 상태 처리
                            if (!applications || applications.length === 0) {
                                if (applicationsContainer) applicationsContainer.style.display = 'none';
                                if (noApplicationsState) noApplicationsState.style.display = 'block';
                                return;
                            }

                            if (applicationsContainer) applicationsContainer.style.display = 'block';
                            if (noApplicationsState) noApplicationsState.style.display = 'none';
                            
                            // 온라인 신청 렌더링
                            this.renderSectionApplications('온라인', onlineApplications, onlineContainer, noOnlineState);
                            
                            // 오프라인 신청 렌더링
                            this.renderSectionApplications('오프라인', offlineApplications, offlineContainer, noOfflineState);
                            
                            // 통계 업데이트
                            this.updateSectionStats(onlineApplications, offlineApplications);
                            
                            // 아이콘 생성
                            if (typeof lucide !== 'undefined') {
                                lucide.createIcons();
                            }

                            // 카드 이벤트 리스너 설정
                            this.setupCardEventListeners();
                            
                            console.log('✅ 개선된 UI 렌더링 완료');
                        } catch (error) {
                            console.error('❌ 개선된 UI 렌더링 오류:', error);
                        }
                    };

                    // 섹션별 신청 렌더링
                    window.EquipmentRequestModule.renderSectionApplications = function(sectionType, applications, container, emptyState) {
                        if (!container || !emptyState) return;
                        
                        if (!applications || applications.length === 0) {
                            container.innerHTML = '';
                            emptyState.style.display = 'block';
                            return;
                        }

                        emptyState.style.display = 'none';
                        container.innerHTML = '';
                        
                        applications.forEach((application) => {
                            const applicationCard = this.createApplicationCard(application);
                            container.appendChild(applicationCard);
                        });
                    };

                    // 섹션 통계 업데이트
                    window.EquipmentRequestModule.updateSectionStats = function(onlineApplications, offlineApplications) {
                        // 온라인 통계
                        const onlineCount = document.getElementById('onlineCount');
                        const onlineTotalPrice = document.getElementById('onlineTotalPrice');
                        
                        if (onlineCount) onlineCount.textContent = onlineApplications.length;
                        if (onlineTotalPrice) {
                            const total = onlineApplications.reduce((sum, app) => sum + (app.price || 0), 0);
                            onlineTotalPrice.textContent = this.formatPrice(total);
                        }
                        
                        // 오프라인 통계
                        const offlineCount = document.getElementById('offlineCount');
                        const offlineTotalPrice = document.getElementById('offlineTotalPrice');
                        
                        if (offlineCount) offlineCount.textContent = offlineApplications.length;
                        if (offlineTotalPrice) {
                            const total = offlineApplications.reduce((sum, app) => sum + (app.price || 0), 0);
                            offlineTotalPrice.textContent = this.formatPrice(total);
                        }
                    };

                    // 기존 renderApplications 함수를 새로운 버전으로 교체
                    window.EquipmentRequestModule.renderApplications = window.EquipmentRequestModule.renderApplicationsGrouped;
                    
                    console.log('✅ v4.3.1 개선된 UI 렌더링 함수 설정 완료');
                }
            } catch (error) {
                console.error('❌ v4.3.1 개선된 UI 설정 오류:', error);
            }
        }

        // 🎯 DOM 로드 완료 시 실행
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🎨 v4.3.1 DOM 로드 완료 - 개선된 UI 적용');
            
            // Lucide 아이콘 초기화
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // 모든 스크립트 로딩 완료까지 잠시 대기 후 초기화
            setTimeout(function() {
                initializeEquipmentRequestPage();
            }, 1000); // 1000ms 대기 (안정성 확보)
        });

        // 전역 에러 핸들러 (오류만 표시)
        window.addEventListener('error', function(event) {
            console.error('❌ 전역 스크립트 오류:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno
            });
            
            if (typeof showSystemErrorModal === 'function') {
                showSystemErrorModal(event.message);
            }
        });
    </script>
    
    <!-- 🎨 v4.3.1 개선된 UI 스타일 -->
    <style>
        /* 페이지 전환 스타일 */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* 🎨 개선된 UI 스타일 */
        
        /* 전체 컨테이너 */
        .applications-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-top: 1.5rem;
        }

        /* 섹션 스타일 */
        .applications-section {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .applications-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* 섹션 헤더 */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-icon {
            width: 1.5rem;
            height: 1.5rem;
            flex-shrink: 0;
        }

        .section-icon.online {
            color: #3b82f6;
        }

        .section-icon.offline {
            color: #f59e0b;
        }

        .section-title h3 {
            margin: 0;
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .section-subtitle {
            color: #64748b;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }

        /* 섹션 통계 */
        .section-stats {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* 미니 빈 상태 */
        .empty-state-mini {
            text-align: center;
            padding: 3rem 2rem;
            color: #64748b;
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
        }

        .empty-icon-small {
            width: 3rem;
            height: 3rem;
            color: #94a3b8;
            margin-bottom: 1rem;
        }

        .empty-state-mini p {
            margin: 0.5rem 0;
            font-weight: 500;
            color: #475569;
        }

        .empty-state-mini small {
            color: #64748b;
        }

        /* 개선된 전체 빈 상태 */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #64748b;
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            margin-top: 2rem;
        }

        .empty-icon {
            width: 4rem;
            height: 4rem;
            color: #94a3b8;
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            margin: 1rem 0 0.5rem 0;
            color: #475569;
            font-size: 1.25rem;
        }

        .empty-state p {
            margin-bottom: 2rem;
            color: #64748b;
        }

        .empty-state-btn {
            margin-top: 1rem;
        }

        /* 기존 카드 스타일 개선 */
        .applications-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .application-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        }

        .application-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        /* 구매 방식 배지 개선 */
        .purchase-method-badge.online {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .purchase-method-badge.offline {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border: 1px solid #fbbf24;
        }
        
        /* 🆕 v4.3.1 버전 배지 (호환성 유지) */
        .version-badge {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #10b981);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            vertical-align: middle;
        }

        /* 🆕 v4.3.1 묶음 신청 모달 스타일 개선 (호환성 유지) */
        .bundle-intro {
            background: linear-gradient(135deg, #f0f9ff, #ecfdf5);
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .bundle-intro p {
            margin: 0;
            color: #0f172a;
            font-size: 0.875rem;
        }

        /* 폼 섹션 스타일 */
        .form-section {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-section h4 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1rem;
            font-weight: 600;
        }

        .form-section h4 i {
            width: 1.25rem;
            height: 1.25rem;
            color: #3b82f6;
        }

        .form-section h5 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 0.875rem;
            font-weight: 600;
        }

        /* 🔐 계정 정보 섹션 스타일 */
        .account-info-section {
            background: #fff7ed;
            border: 1px solid #fb923c;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .account-info-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .account-info-header i {
            width: 1.5rem;
            height: 1.5rem;
            color: #ea580c;
            flex-shrink: 0;
            margin-top: 2px;
        }

        /* 🏪 오프라인 구매 안내 스타일 */
        .offline-notice {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .offline-notice i {
            width: 1.25rem;
            height: 1.25rem;
            color: #0284c7;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .offline-notice ul {
            margin: 0.5rem 0 0 0;
            padding-left: 1.25rem;
        }

        .offline-notice li {
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #0f172a;
        }

        /* 🎯 구매 방식 옵션 개선 스타일 */
        .radio-option.enhanced {
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .radio-option.enhanced:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .radio-option.enhanced:has(input:checked) {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .method-features {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .feature-tag {
            display: inline-block;
            background: #e0e7ff;
            color: #3730a3;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
        }

        /* 시스템 오류 모달 스타일 */
        #systemErrorModal .modal-content {
            max-width: 500px;
            text-align: center;
        }
        
        #systemErrorModal .error-info {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 2rem;
            text-align: left;
        }
        
        #systemErrorModal .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        #systemErrorModal .error-actions .btn {
            flex: 1;
            max-width: 200px;
        }
        
        /* 🆕 영수증 파일 업로드 개선 스타일 */
        .file-upload-area {
            position: relative;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .file-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }
        
        .file-upload-area.drag-over {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        .file-upload-area input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        .file-upload-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
        
        .file-upload-content i {
            width: 3rem;
            height: 3rem;
            color: #6b7280;
        }
        
        .file-upload-content p {
            color: #374151;
            margin: 0;
        }
        
        .file-upload-content small {
            color: #6b7280;
        }
        
        /* 📄 파일 선택됨 상태 스타일 */
        .file-selected-content {
            display: none;
        }
        
        .file-selected-content.active {
            display: block;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 6px;
        }
        
        .file-icon {
            width: 2rem;
            height: 2rem;
            color: #0ea5e9;
            flex-shrink: 0;
        }
        
        .file-details {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            color: #0f172a;
            word-break: break-all;
        }
        
        .file-size {
            font-size: 0.875rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        
        /* 🖼️ 이미지 미리보기 스타일 */
        .receipt-preview {
            margin-top: 1rem;
            text-align: center;
        }
        
        .receipt-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .receipt-preview .file-info {
            display: inline-block;
            background-color: #f1f5f9;
            border: 1px solid #cbd5e1;
            padding: 0.75rem 1rem;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .applications-container {
                gap: 1.5rem;
            }

            .applications-section {
                padding: 1rem;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .section-stats {
                align-self: stretch;
                justify-content: space-around;
            }

            .applications-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .header-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .header-actions .btn {
                width: 100%;
                justify-content: center;
            }
            
            #systemErrorModal .error-actions {
                flex-direction: column;
            }
            
            #systemErrorModal .error-actions .btn {
                max-width: none;
            }
            
            .file-info {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .file-details {
                order: -1;
            }

            /* v4.3.1 모바일 반응형 */
            .form-section {
                padding: 1rem;
            }

            .account-info-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .method-features {
                flex-direction: column;
            }

            .feature-tag {
                align-self: flex-start;
            }
        }

        @media (max-width: 480px) {
            .section-title {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .section-subtitle {
                margin-left: 0;
            }

            .stat-item {
                align-items: flex-start;
            }
        }
    </style>
</body>
</html>