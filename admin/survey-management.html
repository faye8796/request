<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ë¬¸í™”ìˆ˜ì—… ë§Œì¡±ë„ ì„¤ë¬¸ ê´€ë¦¬ - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“Š%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: #5855eb;
            transform: translateY(-2px);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .excel-export-btn {
            background: #059669;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .excel-export-btn:hover {
            background: #047857;
            transform: translateY(-2px);
        }

        .excel-export-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        /* Statistics */
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            font-size: 36px;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 14px;
        }

        .stat-card.total .stat-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .stat-card.responses .stat-icon { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-card.average .stat-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.excellent .stat-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }

        /* Filter Controls */
        .filter-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 180px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .filter-input, .filter-select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .clear-filters-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            height: 42px;
        }

        .clear-filters-btn:hover {
            background: #dc2626;
        }

        /* Loading */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e5e7eb;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Intern Survey Cards */
        .interns-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .intern-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .intern-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        }

        .intern-card.no-data {
            opacity: 0.7;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f3f4f6;
            flex-wrap: wrap;
            gap: 16px;
        }

        .intern-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .intern-name {
            font-size: 26px;
            font-weight: 700;
            color: #1f2937;
        }

        .institute-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .country-badge {
            background: #eff6ff;
            color: #3b82f6;
            padding: 5px 14px;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 600;
        }

        .institute-name {
            color: #6b7280;
            font-weight: 500;
            font-size: 15px;
        }

        .rating-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 18px 28px;
            border-radius: 14px;
            min-width: 130px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .rating-badge.excellent {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .rating-badge.good {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .rating-badge.average {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .rating-badge.low {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .rating-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .rating-stars {
            font-size: 18px;
        }

        /* Response Summary */
        .response-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .summary-item {
            text-align: center;
        }

        .summary-item .label {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            display: block;
            margin-bottom: 6px;
        }

        .summary-item .value {
            font-size: 26px;
            font-weight: 700;
            color: #1f2937;
        }

        /* Participation Distribution */
        .participation-distribution {
            margin-bottom: 24px;
        }

        .distribution-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .distribution-bars {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .bar-item {
            display: grid;
            grid-template-columns: 100px 1fr 60px;
            align-items: center;
            gap: 12px;
        }

        .bar-label {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            text-align: right;
        }

        .bar-container {
            height: 28px;
            background: #e5e7eb;
            border-radius: 14px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.6s ease;
            border-radius: 14px;
        }

        .bar-count {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            text-align: center;
        }

        /* Detailed Scores */
        .detailed-scores {
            margin-bottom: 24px;
        }

        .scores-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 14px;
        }

        .score-item {
            display: grid;
            grid-template-columns: 180px 1fr 50px;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .score-item:hover {
            background: #f3f4f6;
        }

        .score-item.highlight {
            background: #eff6ff;
            border: 2px solid #3b82f6;
        }

        .score-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }

        .score-bar {
            height: 10px;
            background: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.6s ease;
            border-radius: 5px;
        }

        .score-value {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
        }

        /* Score Distribution Chart */
        .score-distribution {
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .distribution-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chart-bar {
            display: grid;
            grid-template-columns: 60px 1fr 80px;
            align-items: center;
            gap: 12px;
        }

        .chart-bar .bar-label {
            text-align: right;
            font-weight: 600;
            color: #1f2937;
        }

        .chart-bar[data-score="5"] .bar-fill { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .chart-bar[data-score="4"] .bar-fill { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); }
        .chart-bar[data-score="3"] .bar-fill { background: linear-gradient(90deg, #f59e0b 0%, #d97706 100%); }
        .chart-bar[data-score="2"] .bar-fill { background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); }
        .chart-bar[data-score="1"] .bar-fill { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }

        /* Card Actions */
        .card-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }

        /* No Data Message */
        .no-data-message {
            text-align: center;
            padding: 60px 20px;
            color: #9ca3af;
        }

        .no-data-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background: #10b981;
        }

        .toast.error {
            background: #ef4444;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-left {
                flex-direction: column;
                align-items: stretch;
            }

            .header-title h1 {
                font-size: 22px;
            }

            .statistics {
                grid-template-columns: 1fr;
            }

            .filter-group {
                min-width: 100%;
            }

            .response-summary {
                grid-template-columns: 1fr;
            }

            .score-grid {
                grid-template-columns: 1fr;
            }

            .score-item {
                grid-template-columns: 140px 1fr 50px;
            }

            .bar-item {
                grid-template-columns: 80px 1fr 50px;
            }

            .chart-bar {
                grid-template-columns: 50px 1fr 60px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="../admin.html" class="back-button">
                    <span>â†</span>
                    ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                </a>
                <div class="header-title">
                    <span>ğŸ“Š</span>
                    <h1>ë¬¸í™”ìˆ˜ì—… ë§Œì¡±ë„ ì„¤ë¬¸ ê´€ë¦¬</h1>
                </div>
            </div>
            <button class="excel-export-btn" id="exportExcelBtn">
                <span>ğŸ“¥</span>
                ì „ì²´ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°
            </button>
        </div>

        <!-- Statistics -->
        <div class="statistics">
            <div class="stat-card total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalInterns">0</div>
                    <div class="stat-label">ì „ì²´ ë¬¸í™”ì¸í„´</div>
                </div>
            </div>
            <div class="stat-card responses">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-content">
                    <div class="stat-number" id="totalResponses">0</div>
                    <div class="stat-label">ì´ ì‘ë‹µ ìˆ˜</div>
                </div>
            </div>
            <div class="stat-card average">
                <div class="stat-icon">â­</div>
                <div class="stat-content">
                    <div class="stat-number" id="averageRating">0.0</div>
                    <div class="stat-label">ì „ì²´ í‰ê·  ë§Œì¡±ë„</div>
                </div>
            </div>
            <div class="stat-card excellent">
                <div class="stat-icon">ğŸ†</div>
                <div class="stat-content">
                    <div class="stat-number" id="excellentCount">0</div>
                    <div class="stat-label">ìš°ìˆ˜ í‰ê°€ (4.5ì  ì´ìƒ)</div>
                </div>
            </div>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="searchInput">ë¬¸í™”ì¸í„´ ê²€ìƒ‰</label>
                    <input type="text" id="searchInput" class="filter-input" placeholder="ì´ë¦„ ê²€ìƒ‰">
                </div>
                <div class="filter-group">
                    <label for="countryFilter">êµ­ê°€</label>
                    <select id="countryFilter" class="filter-select">
                        <option value="">ì „ì²´ êµ­ê°€</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="instituteFilter">í•™ë‹¹</label>
                    <select id="instituteFilter" class="filter-select">
                        <option value="">ì „ì²´ í•™ë‹¹</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="ratingFilter">í‰ê°€ ë“±ê¸‰</label>
                    <select id="ratingFilter" class="filter-select">
                        <option value="">ì „ì²´ í‰ê°€</option>
                        <option value="excellent">ìš°ìˆ˜ (4.5~5.0)</option>
                        <option value="good">ì–‘í˜¸ (4.0~4.4)</option>
                        <option value="average">ë³´í†µ (3.0~3.9)</option>
                        <option value="low">ê°œì„ í•„ìš” (3.0 ë¯¸ë§Œ)</option>
                    </select>
                </div>
                <button class="clear-filters-btn" id="clearFiltersBtn">
                    âœ– ì´ˆê¸°í™”
                </button>
            </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner"></div>
        </div>

        <!-- Interns Container -->
        <div class="interns-container" id="internsContainer" style="display: none;">
            <!-- Intern cards will be rendered here -->
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">ğŸ“Š</div>
            <h3>ì„¤ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ì•„ì§ ì œì¶œëœ ì„¤ë¬¸ì´ ì—†ê±°ë‚˜ í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Main Script -->
    <script type="module">
        // ğŸ” ê´€ë¦¬ì ì¸ì¦ ì²´í¬
        function checkAdminAuth() {
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession || adminSession !== 'true') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '../admin.html';
                return false;
            }
            return true;
        }

        // Supabase ì„¤ì •
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.0';
        
        const supabaseUrl = 'https://aazvopacnbbkvusihqva.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhenZvcGFjbmJia3Z1c2locXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3OTQyMjQsImV4cCI6MjA2NTM3MDIyNH0.0NXI_tohwFCOl3xY4b1jIlxQR_zGTS9tWDM2OFxTq4s';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // ì „ì—­ ë³€ìˆ˜
        let allInternsData = [];
        let filteredInternsData = [];
        let isLoading = false;

        // DOM ìš”ì†Œ
        const loadingContainer = document.getElementById('loadingContainer');
        const internsContainer = document.getElementById('internsContainer');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const countryFilter = document.getElementById('countryFilter');
        const instituteFilter = document.getElementById('instituteFilter');
        const ratingFilter = document.getElementById('ratingFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        // Toast ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // êµ­ê°€ëª… ì¶”ì¶œ í•¨ìˆ˜ (survey.htmlê³¼ ë™ì¼)
        function extractCountryName(instituteName) {
            if (!instituteName) return '';
            const hyphenIndex = instituteName.indexOf('-');
            if (hyphenIndex > 0) {
                const nextSpaceIndex = instituteName.indexOf(' ', hyphenIndex);
                if (nextSpaceIndex > 0) {
                    return instituteName.substring(0, nextSpaceIndex).trim();
                }
            }
            const spaceIndex = instituteName.indexOf(' ');
            return spaceIndex > 0 ? instituteName.substring(0, spaceIndex).trim() : instituteName.trim();
        }

        // ë°ì´í„° ë¡œë”©
        async function loadSurveyData() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            try {
                // 1. ëª¨ë“  ë¬¸í™”ì¸í„´ ì¡°íšŒ
                const { data: interns, error: internsError } = await supabase
                    .from('user_profiles')
                    .select('id, name, sejong_institute')
                    .eq('role', 'student')
                    .order('name');
                
                if (internsError) throw internsError;
                
                // 2. ëª¨ë“  ì„¤ë¬¸ ì‘ë‹µ ì¡°íšŒ
                const { data: surveys, error: surveysError } = await supabase
                    .from('class_surveys')
                    .select(`
                        *,
                        institutes!inner(id, name_ko, name_en)
                    `);
                
                if (surveysError) throw surveysError;
                
                // 3. ì¸í„´ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
                allInternsData = interns.map(intern => {
                    const internSurveys = surveys.filter(s => s.intern_id === intern.id);
                    
                    if (internSurveys.length === 0) {
                        return {
                            intern,
                            country: extractCountryName(intern.sejong_institute || ''),
                            responseCount: 0,
                            averageScore: 0,
                            hasData: false
                        };
                    }
                    
                    return {
                        intern,
                        country: extractCountryName(intern.sejong_institute || ''),
                        responseCount: internSurveys.length,
                        averageScore: calculateAverageScore(internSurveys),
                        detailedScores: calculateDetailedScores(internSurveys),
                        participationDistribution: calculateParticipationDistribution(internSurveys),
                        scoreDistribution: calculateScoreDistribution(internSurveys),
                        hasData: true
                    };
                });
                
                filteredInternsData = [...allInternsData];
                
                populateFilters();
                updateStatistics();
                renderInterns();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                showToast('ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                showEmptyState();
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        // ë¡œë”© ìƒíƒœ
        function showLoading() {
            loadingContainer.style.display = 'flex';
            internsContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function hideLoading() {
            loadingContainer.style.display = 'none';
        }

        function showEmptyState() {
            emptyState.style.display = 'block';
            internsContainer.style.display = 'none';
        }

        // í†µê³„ ê³„ì‚° í•¨ìˆ˜ë“¤
        function calculateAverageScore(surveys) {
            const scoreFields = [
                'q3_recruitment_info', 'q4_content_interest', 'q5_class_appropriateness',
                'q6_instructor_communication', 'q7_explanation_clarity', 'q8_cultural_learning',
                'q9_overall_satisfaction', 'q10_recommendation'
            ];
            
            let totalScore = 0;
            let count = 0;
            
            surveys.forEach(survey => {
                scoreFields.forEach(field => {
                    totalScore += survey[field];
                    count++;
                });
            });
            
            return count > 0 ? parseFloat((totalScore / count).toFixed(2)) : 0;
        }

        function calculateDetailedScores(surveys) {
            return {
                recruitmentInfo: calculateFieldAverage(surveys, 'q3_recruitment_info'),
                contentInterest: calculateFieldAverage(surveys, 'q4_content_interest'),
                classAppropriateness: calculateFieldAverage(surveys, 'q5_class_appropriateness'),
                instructorCommunication: calculateFieldAverage(surveys, 'q6_instructor_communication'),
                explanationClarity: calculateFieldAverage(surveys, 'q7_explanation_clarity'),
                culturalLearning: calculateFieldAverage(surveys, 'q8_cultural_learning'),
                overallSatisfaction: calculateFieldAverage(surveys, 'q9_overall_satisfaction'),
                recommendation: calculateFieldAverage(surveys, 'q10_recommendation')
            };
        }

        function calculateFieldAverage(surveys, fieldName) {
            const sum = surveys.reduce((acc, survey) => acc + (survey[fieldName] || 0), 0);
            return parseFloat((sum / surveys.length).toFixed(2));
        }

        function calculateParticipationDistribution(surveys) {
            const distribution = { first: 0, second: 0, third_or_more: 0 };
            surveys.forEach(survey => {
                if (distribution.hasOwnProperty(survey.participation_count)) {
                    distribution[survey.participation_count]++;
                }
            });
            return distribution;
        }

        function calculateScoreDistribution(surveys) {
            const distribution = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            const scoreFields = [
                'q3_recruitment_info', 'q4_content_interest', 'q5_class_appropriateness',
                'q6_instructor_communication', 'q7_explanation_clarity', 'q8_cultural_learning',
                'q9_overall_satisfaction', 'q10_recommendation'
            ];
            
            surveys.forEach(survey => {
                scoreFields.forEach(field => {
                    const score = survey[field];
                    if (distribution.hasOwnProperty(score)) {
                        distribution[score]++;
                    }
                });
            });
            
            return distribution;
        }

        // í•„í„° ì±„ìš°ê¸°
        function populateFilters() {
            const countries = [...new Set(allInternsData.map(i => i.country).filter(Boolean))].sort();
            const institutes = [...new Set(allInternsData.map(i => i.intern.sejong_institute).filter(Boolean))].sort();
            
            countryFilter.innerHTML = '<option value="">ì „ì²´ êµ­ê°€</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
            
            instituteFilter.innerHTML = '<option value="">ì „ì²´ í•™ë‹¹</option>';
            institutes.forEach(institute => {
                const option = document.createElement('option');
                option.value = institute;
                option.textContent = institute;
                instituteFilter.appendChild(option);
            });
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const withData = filteredInternsData.filter(i => i.hasData);
            const totalResponses = withData.reduce((sum, i) => sum + i.responseCount, 0);
            const avgRating = withData.length > 0 
                ? (withData.reduce((sum, i) => sum + i.averageScore, 0) / withData.length).toFixed(2)
                : 0;
            const excellentCount = withData.filter(i => i.averageScore >= 4.5).length;
            
            document.getElementById('totalInterns').textContent = filteredInternsData.length;
            document.getElementById('totalResponses').textContent = totalResponses;
            document.getElementById('averageRating').textContent = avgRating;
            document.getElementById('excellentCount').textContent = excellentCount;
        }

        // í‰ê°€ ë“±ê¸‰ ê²°ì •
        function getRatingClass(score) {
            if (score >= 4.5) return 'excellent';
            if (score >= 4.0) return 'good';
            if (score >= 3.0) return 'average';
            return 'low';
        }

        // ë³„ì  í‘œì‹œ
        function getStarRating(score) {
            const fullStars = Math.floor(score);
            const hasHalfStar = score % 1 >= 0.5;
            let stars = 'â­'.repeat(fullStars);
            if (hasHalfStar && fullStars < 5) stars += 'âœ¨';
            return stars;
        }

        // ì¸í„´ ì¹´ë“œ ë Œë”ë§
        function renderInterns() {
            if (filteredInternsData.length === 0) {
                showEmptyState();
                return;
            }
            
            internsContainer.style.display = 'flex';
            emptyState.style.display = 'none';
            
            internsContainer.innerHTML = filteredInternsData.map(data => renderInternCard(data)).join('');
        }

        function renderInternCard(data) {
            if (!data.hasData) {
                return `
                    <div class="intern-card no-data">
                        <div class="card-header">
                            <div class="intern-info">
                                <div class="intern-name">${data.intern.name}</div>
                                <div class="institute-info">
                                    ${data.country ? `<span class="country-badge">${data.country}</span>` : ''}
                                    <span class="institute-name">${data.intern.sejong_institute || 'í•™ë‹¹ ì •ë³´ ì—†ìŒ'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="no-data-message">
                            <div class="no-data-icon">ğŸ“­</div>
                            <p>ì•„ì§ ì„¤ë¬¸ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    </div>
                `;
            }
            
            const ratingClass = getRatingClass(data.averageScore);
            const stars = getStarRating(data.averageScore);
            
            return `
                <div class="intern-card">
                    ${renderCardHeader(data, ratingClass, stars)}
                    ${renderResponseSummary(data)}
                    ${renderParticipationDistribution(data)}
                    ${renderDetailedScores(data)}
                    ${renderScoreDistribution(data)}
                    ${renderCardActions(data)}
                </div>
            `;
        }

        function renderCardHeader(data, ratingClass, stars) {
            return `
                <div class="card-header">
                    <div class="intern-info">
                        <div class="intern-name">${data.intern.name}</div>
                        <div class="institute-info">
                            ${data.country ? `<span class="country-badge">${data.country}</span>` : ''}
                            <span class="institute-name">${data.intern.sejong_institute || 'í•™ë‹¹ ì •ë³´ ì—†ìŒ'}</span>
                        </div>
                    </div>
                    <div class="rating-badge ${ratingClass}">
                        <span class="rating-number">${data.averageScore}</span>
                        <span class="rating-stars">${stars}</span>
                    </div>
                </div>
            `;
        }

        function renderResponseSummary(data) {
            return `
                <div class="response-summary">
                    <div class="summary-item">
                        <span class="label">ì´ ì‘ë‹µ</span>
                        <span class="value">${data.responseCount}ê±´</span>
                    </div>
                    <div class="summary-item">
                        <span class="label">í‰ê·  ë§Œì¡±ë„</span>
                        <span class="value">${data.averageScore}ì </span>
                    </div>
                    <div class="summary-item">
                        <span class="label">ì¶”ì²œ ì˜í–¥</span>
                        <span class="value">${data.detailedScores.recommendation}ì </span>
                    </div>
                </div>
            `;
        }

        function renderParticipationDistribution(data) {
            const dist = data.participationDistribution;
            const total = data.responseCount;
            
            return `
                <div class="participation-distribution">
                    <div class="distribution-title">ğŸ“Š ìˆ˜ì—… ì°¸ì—¬ ê²½í—˜</div>
                    <div class="distribution-bars">
                        ${renderBarItem('ì²˜ìŒ', dist.first, total)}
                        ${renderBarItem('ë‘ ë²ˆì§¸', dist.second, total)}
                        ${renderBarItem('ì„¸ ë²ˆì§¸ ì´ìƒ', dist.third_or_more, total)}
                    </div>
                </div>
            `;
        }

        function renderBarItem(label, count, total) {
            const percentage = total > 0 ? (count / total * 100).toFixed(0) : 0;
            return `
                <div class="bar-item">
                    <span class="bar-label">${label}</span>
                    <div class="bar-container">
                        <div class="bar-fill" style="width: ${percentage}%"></div>
                    </div>
                    <span class="bar-count">${count}ëª…</span>
                </div>
            `;
        }

        function renderDetailedScores(data) {
            const scores = data.detailedScores;
            return `
                <div class="detailed-scores">
                    <div class="scores-title">ğŸ“ ë¬¸í•­ë³„ í‰ê°€</div>
                    <div class="score-grid">
                        ${renderScoreItem('ìˆ˜ê°•ìƒ ëª¨ì§‘ ì•ˆë‚´', scores.recruitmentInfo)}
                        ${renderScoreItem('ìˆ˜ì—… ë‚´ìš© í¥ë¯¸', scores.contentInterest)}
                        ${renderScoreItem('ìˆ˜ì—… êµ¬ì„± ì ì ˆì„±', scores.classAppropriateness)}
                        ${renderScoreItem('ê°•ì‚¬ ì†Œí†µ ëŠ¥ë ¥', scores.instructorCommunication)}
                        ${renderScoreItem('ì„¤ëª… ëª…í™•ì„±', scores.explanationClarity)}
                        ${renderScoreItem('ë¬¸í™” í•™ìŠµ íš¨ê³¼', scores.culturalLearning)}
                        ${renderScoreItem('ì „ë°˜ì  ë§Œì¡±ë„', scores.overallSatisfaction, true)}
                        ${renderScoreItem('ì¶”ì²œ ì˜í–¥', scores.recommendation, true)}
                    </div>
                </div>
            `;
        }

        function renderScoreItem(label, score, highlight = false) {
            const percentage = (score / 5 * 100).toFixed(0);
            return `
                <div class="score-item ${highlight ? 'highlight' : ''}">
                    <div class="score-label">${label}</div>
                    <div class="score-bar">
                        <div class="score-fill" style="width: ${percentage}%"></div>
                    </div>
                    <div class="score-value">${score}</div>
                </div>
            `;
        }

        function renderScoreDistribution(data) {
            const dist = data.scoreDistribution;
            const total = Object.values(dist).reduce((a, b) => a + b, 0);
            
            return `
                <div class="score-distribution">
                    <div class="distribution-title">ğŸ“ˆ ì ìˆ˜ ë¶„í¬</div>
                    <div class="distribution-chart">
                        ${[5, 4, 3, 2, 1].map(score => {
                            const count = dist[score];
                            const percentage = total > 0 ? (count / total * 100).toFixed(0) : 0;
                            return `
                                <div class="chart-bar" data-score="${score}">
                                    <span class="bar-label">${score}ì </span>
                                    <div class="bar-container">
                                        <div class="bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <span class="bar-count">${count}ê±´ (${percentage}%)</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderCardActions(data) {
            return `
                <div class="card-actions">
                    <button onclick="exportInternData('${data.intern.id}')" class="btn btn-secondary">
                        ğŸ“¥ ê°œë³„ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
            `;
        }

        // í•„í„°ë§
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCountry = countryFilter.value;
            const selectedInstitute = instituteFilter.value;
            const selectedRating = ratingFilter.value;
            
            filteredInternsData = allInternsData.filter(data => {
                const matchesSearch = !searchTerm || data.intern.name.toLowerCase().includes(searchTerm);
                const matchesCountry = !selectedCountry || data.country === selectedCountry;
                const matchesInstitute = !selectedInstitute || data.intern.sejong_institute === selectedInstitute;
                
                let matchesRating = true;
                if (selectedRating && data.hasData) {
                    const score = data.averageScore;
                    matchesRating = 
                        (selectedRating === 'excellent' && score >= 4.5) ||
                        (selectedRating === 'good' && score >= 4.0 && score < 4.5) ||
                        (selectedRating === 'average' && score >= 3.0 && score < 4.0) ||
                        (selectedRating === 'low' && score < 3.0);
                }
                
                return matchesSearch && matchesCountry && matchesInstitute && matchesRating;
            });
            
            updateStatistics();
            renderInterns();
        }

        // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        async function exportAllData() {
            try {
                exportExcelBtn.disabled = true;
                exportExcelBtn.innerHTML = 'â³ ë‚´ë³´ë‚´ëŠ” ì¤‘...';
                
                const exportData = filteredInternsData
                    .filter(data => data.hasData)
                    .map(data => ({
                        'ë¬¸í™”ì¸í„´ëª…': data.intern.name,
                        'êµ­ê°€': data.country,
                        'íŒŒê²¬í•™ë‹¹': data.intern.sejong_institute || '',
                        'ì´ì‘ë‹µìˆ˜': data.responseCount,
                        'í‰ê· ë§Œì¡±ë„': data.averageScore,
                        'ìˆ˜ê°•ìƒëª¨ì§‘ì•ˆë‚´': data.detailedScores.recruitmentInfo,
                        'ìˆ˜ì—…ë‚´ìš©í¥ë¯¸': data.detailedScores.contentInterest,
                        'ìˆ˜ì—…êµ¬ì„±ì ì ˆì„±': data.detailedScores.classAppropriateness,
                        'ê°•ì‚¬ì†Œí†µëŠ¥ë ¥': data.detailedScores.instructorCommunication,
                        'ì„¤ëª…ëª…í™•ì„±': data.detailedScores.explanationClarity,
                        'ë¬¸í™”í•™ìŠµíš¨ê³¼': data.detailedScores.culturalLearning,
                        'ì „ë°˜ì ë§Œì¡±ë„': data.detailedScores.overallSatisfaction,
                        'ì¶”ì²œì˜í–¥': data.detailedScores.recommendation,
                        'ì²˜ìŒì°¸ì—¬ì': data.participationDistribution.first,
                        'ë‘ë²ˆì§¸ì°¸ì—¬ì': data.participationDistribution.second,
                        'ì„¸ë²ˆì§¸ì´ìƒì°¸ì—¬ì': data.participationDistribution.third_or_more,
                        '1ì ì‘ë‹µ': data.scoreDistribution[1],
                        '2ì ì‘ë‹µ': data.scoreDistribution[2],
                        '3ì ì‘ë‹µ': data.scoreDistribution[3],
                        '4ì ì‘ë‹µ': data.scoreDistribution[4],
                        '5ì ì‘ë‹µ': data.scoreDistribution[5]
                    }));
                
                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'ì„¤ë¬¸ê²°ê³¼');
                
                const today = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `ë¬¸í™”ìˆ˜ì—…ë§Œì¡±ë„ì„¤ë¬¸_${today}.xlsx`);
                
                showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                showToast('ì—‘ì…€ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                exportExcelBtn.disabled = false;
                exportExcelBtn.innerHTML = '<span>ğŸ“¥</span> ì „ì²´ ì—‘ì…€ë¡œ ë‚´ë³´ë‚´ê¸°';
            }
        }

        window.exportInternData = function(internId) {
            const internData = allInternsData.find(d => d.intern.id === internId);
            if (!internData || !internData.hasData) return;
            
            const exportData = [{
                'ë¬¸í™”ì¸í„´ëª…': internData.intern.name,
                'êµ­ê°€': internData.country,
                'íŒŒê²¬í•™ë‹¹': internData.intern.sejong_institute || '',
                'ì´ì‘ë‹µìˆ˜': internData.responseCount,
                'í‰ê· ë§Œì¡±ë„': internData.averageScore,
                'ìˆ˜ê°•ìƒëª¨ì§‘ì•ˆë‚´': internData.detailedScores.recruitmentInfo,
                'ìˆ˜ì—…ë‚´ìš©í¥ë¯¸': internData.detailedScores.contentInterest,
                'ìˆ˜ì—…êµ¬ì„±ì ì ˆì„±': internData.detailedScores.classAppropriateness,
                'ê°•ì‚¬ì†Œí†µëŠ¥ë ¥': internData.detailedScores.instructorCommunication,
                'ì„¤ëª…ëª…í™•ì„±': internData.detailedScores.explanationClarity,
                'ë¬¸í™”í•™ìŠµíš¨ê³¼': internData.detailedScores.culturalLearning,
                'ì „ë°˜ì ë§Œì¡±ë„': internData.detailedScores.overallSatisfaction,
                'ì¶”ì²œì˜í–¥': internData.detailedScores.recommendation
            }];
            
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'ì„¤ë¬¸ê²°ê³¼');
            
            XLSX.writeFile(workbook, `${internData.intern.name}_ì„¤ë¬¸ê²°ê³¼.xlsx`);
            showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        searchInput.addEventListener('input', applyFilters);
        countryFilter.addEventListener('change', applyFilters);
        instituteFilter.addEventListener('change', applyFilters);
        ratingFilter.addEventListener('change', applyFilters);
        
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            countryFilter.value = '';
            instituteFilter.value = '';
            ratingFilter.value = '';
            applyFilters();
        });
        
        exportExcelBtn.addEventListener('click', exportAllData);

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAdminAuth()) return;
            loadSurveyData();
        });
    </script>
</body>
</html>