<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>파견학당 정보 관리 - 세종학당 문화인턴 지원 시스템</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../css/main.css?v=4.4.0">
    <link rel="stylesheet" href="../css/institute.css?v=4.4.0">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="institute-management-container">
        <!-- 헤더 섹션 -->
        <div class="institute-header">
            <div class="institute-header-content">
                <div class="institute-header-title">
                    <h1>파견학당 정보 관리</h1>
                    <p>세종학당의 15개 필드 정보를 체계적으로 관리하고 문화인턴 배정 현황을 확인할 수 있습니다.</p>
                </div>
                <button class="institute-btn institute-btn-secondary" onclick="goBackToDashboard()">
                    <i data-lucide="arrow-left"></i>
                    대시보드로 돌아가기
                </button>
            </div>
        </div>

        <!-- 통계 섹션 -->
        <div class="institute-stats-section">
            <div class="institute-stat-card total">
                <div class="institute-stat-icon">
                    <i data-lucide="building2"></i>
                </div>
                <div class="institute-stat-number" id="total-institutes">-</div>
                <p class="institute-stat-label">총 세종학당 수</p>
            </div>
            <div class="institute-stat-card assigned">
                <div class="institute-stat-icon">
                    <i data-lucide="users"></i>
                </div>
                <div class="institute-stat-number" id="assigned-interns">-</div>
                <p class="institute-stat-label">배정된 문화인턴</p>
            </div>
            <div class="institute-stat-card active">
                <div class="institute-stat-icon">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="institute-stat-number" id="complete-institutes">-</div>
                <p class="institute-stat-label">정보 완성 학당</p>
            </div>
            <div class="institute-stat-card pending">
                <div class="institute-stat-icon">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="institute-stat-number" id="incomplete-institutes">-</div>
                <p class="institute-stat-label">정보 미완성 학당</p>
            </div>
        </div>

        <!-- 필터 및 검색 섹션 -->
        <div class="institute-filters-section">
            <div class="institute-filters-grid">
                <div class="institute-search-box">
                    <i data-lucide="search" class="institute-search-icon"></i>
                    <input type="text" class="institute-search-input" id="institute-search" 
                           placeholder="학당명, 운영기관, 담당자 이름으로 검색...">
                </div>
                <div class="institute-view-toggle">
                    <button class="institute-view-btn active" id="view-toggle-grid" data-view="grid">
                        <i data-lucide="grid-3x3"></i>
                        그리드
                    </button>
                    <button class="institute-view-btn" id="view-toggle-list" data-view="list">
                        <i data-lucide="list"></i>
                        리스트
                    </button>
                </div>
                <button class="institute-btn institute-btn-primary" id="refresh-button">
                    <i data-lucide="refresh-cw"></i>
                    새로고침
                </button>
            </div>
        </div>

        <!-- 메인 콘텐츠 영역 -->
        <div id="institute-management-container">
            <!-- 로딩 상태 -->
            <div class="institute-loading" id="loading-spinner">
                <div class="institute-loading-spinner"></div>
                <span>학당 정보를 불러오는 중...</span>
            </div>

            <!-- 그리드 뷰 -->
            <div class="institute-grid" id="institute-grid" style="display: none;">
                <!-- 학당 카드들이 동적으로 생성됩니다 -->
            </div>

            <!-- 리스트 뷰 -->
            <div class="institute-list" id="institute-list" style="display: none;">
                <table class="institute-table">
                    <thead>
                        <tr>
                            <th>학당명</th>
                            <th>운영기관</th>
                            <th>주소</th>
                            <th>담당자</th>
                            <th>문화인턴</th>
                            <th>상태</th>
                            <th>작업</th>
                        </tr>
                    </thead>
                    <tbody id="institute-table-body">
                        <!-- 학당 행들이 동적으로 생성됩니다 -->
                    </tbody>
                </table>
            </div>

            <!-- 빈 상태 -->
            <div class="institute-empty-state" id="empty-state" style="display: none;">
                <i data-lucide="search" class="institute-empty-icon"></i>
                <h3>검색 결과가 없습니다</h3>
                <p>다른 검색어를 시도해보세요.</p>
            </div>
        </div>
    </div>

    <!-- 학당 상세 정보 모달 -->
    <div class="institute-modal-overlay" id="institute-detail-modal" style="display: none;">
        <div class="institute-modal">
            <div class="institute-modal-header">
                <h2 class="institute-modal-title">
                    <i data-lucide="building2"></i>
                    학당 상세 정보
                </h2>
                <button class="institute-modal-close" onclick="closeDetailModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="institute-modal-body" id="institute-detail-content">
                <!-- 상세 정보가 동적으로 생성됩니다 -->
            </div>
            <div class="institute-modal-footer">
                <button class="institute-btn institute-btn-primary" id="edit-institute-btn">
                    <i data-lucide="edit"></i>
                    정보 수정
                </button>
                <button class="institute-btn institute-btn-secondary" onclick="closeDetailModal()">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- 학당 정보 수정 모달 -->
    <div class="institute-modal-overlay" id="institute-edit-modal" style="display: none;">
        <div class="institute-modal">
            <div class="institute-modal-header">
                <h2 class="institute-modal-title">
                    <i data-lucide="edit"></i>
                    학당 정보 수정
                </h2>
                <button class="institute-modal-close" onclick="closeEditModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="institute-modal-body">
                <form id="institute-edit-form">
                    <div class="institute-field-groups">
                        <!-- 기본 정보 그룹 -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="info"></i>
                                기본 정보
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label required" for="edit-name-ko">학당명</label>
                                <input type="text" class="institute-form-input" id="edit-name-ko" name="name_ko" required>
                                <div class="institute-form-help">학당의 공식 한국어 명칭</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-name-en">영문명</label>
                                <input type="text" class="institute-form-input" id="edit-name-en" name="name_en">
                                <div class="institute-form-help">학당의 영문 명칭</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-operating-organization">운영기관</label>
                                <input type="text" class="institute-form-input" id="edit-operating-organization" name="operating_organization">
                                <div class="institute-form-help">학당을 운영하는 기관명</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-image-url">학당사진</label>
                                <div class="institute-image-upload" id="image-upload-area">
                                    <img id="image-preview" class="institute-image-preview" style="display: none;">
                                    <i data-lucide="upload" class="institute-image-upload-icon"></i>
                                    <div class="institute-image-upload-text">
                                        클릭하거나 이미지를 드래그하여 업로드
                                    </div>
                                </div>
                                <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                                <input type="hidden" id="edit-image-url" name="image_url">
                            </div>
                        </div>

                        <!-- 연락처 정보 그룹 -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="phone"></i>
                                연락처 정보
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-address">주소</label>
                                <textarea class="institute-form-textarea" id="edit-address" name="address" rows="3"></textarea>
                                <div class="institute-form-help">학당의 상세 주소</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-phone">대표연락처</label>
                                <input type="tel" class="institute-form-input" id="edit-phone" name="phone">
                                <div class="institute-form-help">학당의 대표 전화번호</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-website-sns">홈페이지/SNS</label>
                                <input type="url" class="institute-form-input" id="edit-website-sns" name="website_sns">
                                <div class="institute-form-help">학당의 웹사이트 또는 SNS 주소</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-manager-name">담당자성명</label>
                                <input type="text" class="institute-form-input" id="edit-manager-name" name="manager_name">
                                <div class="institute-form-help">학당 담당자의 성명</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-manager-contact">담당자연락처</label>
                                <input type="text" class="institute-form-input" id="edit-manager-contact" name="manager_contact">
                                <div class="institute-form-help">담당자의 전화번호 또는 이메일</div>
                            </div>
                        </div>

                        <!-- 프로그램 정보 그룹 -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="graduation-cap"></i>
                                프로그램 정보
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-local-adaptation-staff">현지적응전담인력</label>
                                <textarea class="institute-form-textarea" id="edit-local-adaptation-staff" name="local_adaptation_staff" rows="4"></textarea>
                                <div class="institute-form-help">현지 적응을 도와주는 전담 인력 정보</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-cultural-program-plan">문화수업운영계획</label>
                                <textarea class="institute-form-textarea" id="edit-cultural-program-plan" name="cultural_program_plan" rows="4"></textarea>
                                <div class="institute-form-help">문화 수업 운영 계획 및 내용</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-desired-courses">희망개설강좌</label>
                                <textarea class="institute-form-textarea" id="edit-desired-courses" name="desired_courses" rows="4"></textarea>
                                <div class="institute-form-help">개설하고자 하는 강좌 목록</div>
                            </div>
                        </div>

                        <!-- 지원 정보 그룹 -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="help-circle"></i>
                                지원 정보
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-local-language-requirement">현지어구사필요수준</label>
                                <textarea class="institute-form-textarea" id="edit-local-language-requirement" name="local_language_requirement" rows="4"></textarea>
                                <div class="institute-form-help">문화인턴에게 요구되는 현지어 수준</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-institute-support">학당지원사항</label>
                                <textarea class="institute-form-textarea" id="edit-institute-support" name="institute_support" rows="4"></textarea>
                                <div class="institute-form-help">학당에서 제공하는 지원 사항</div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-country-safety-info">파견국가안전정보</label>
                                <textarea class="institute-form-textarea" id="edit-country-safety-info" name="country_safety_info" rows="4"></textarea>
                                <div class="institute-form-help">파견 국가의 안전 관련 정보</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="institute-modal-footer">
                <button class="institute-btn institute-btn-success" id="save-institute-btn">
                    <i data-lucide="save"></i>
                    저장하기
                </button>
                <button class="institute-btn institute-btn-secondary" onclick="closeEditModal()">
                    취소
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <!-- 1. 기본 설정 모듈 (의존성 순서 중요!) -->
    <script src="../js/config.js?v=4.4.0"></script>
    <script src="../js/auth.js?v=4.4.0"></script>
    <script src="../js/utils.js?v=4.4.0"></script>
    
    <!-- 2. Supabase 모듈들 -->
    <script src="../js/supabase/supabase-core.js?v=4.4.0"></script>
    <script src="../js/supabase/supabase-student.js?v=4.4.0"></script>
    <script src="../js/supabase/supabase-admin.js?v=4.4.0"></script>
    <script src="../js/supabase-client.js?v=4.4.0"></script>

    <!-- 3. Institute 전용 모듈들 (B단계) -->
    <script src="../js/institute/institute-utils.js?v=4.4.0"></script>
    <script src="../js/institute/institute-validation.js?v=4.4.0"></script>
    <script src="../js/institute/institute-api.js?v=4.4.0"></script>
    <script src="../js/institute/institute-core.js?v=4.4.0"></script>
    <script src="../js/institute/institute-ui.js?v=4.4.0"></script>

    <script>
        // 전역 변수
        let currentInstitute = null;
        let currentView = 'grid';

        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🏛️ 파견학당 정보 관리 시스템 v4.4.0 초기화');
            
            try {
                // Lucide 아이콘 초기화
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // 관리자 인증 확인
                checkAdminAuthentication();

                // Institute 모듈들 초기화 대기
                await initializeInstituteModules();

                // UI 이벤트 설정
                setupEventListeners();

                // 초기 데이터 로드
                await loadInstituteData();

                console.log('✅ 파견학당 관리 시스템 초기화 완료');

            } catch (error) {
                console.error('❌ 시스템 초기화 실패:', error);
                showError('시스템 초기화에 실패했습니다: ' + error.message);
            }
        });

        /**
         * 🔐 관리자 인증 확인
         */
        function checkAdminAuthentication() {
            console.log('🔐 관리자 인증 확인 중...');
            
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession) {
                console.warn('⚠️ 관리자 세션이 없습니다');
                alert('관리자 로그인이 필요합니다.');
                window.location.href = '../admin.html';
                return;
            }

            console.log('✅ 관리자 인증 확인됨');
        }

        /**
         * 🚀 Institute 모듈들 초기화
         */
        async function initializeInstituteModules() {
            console.log('🔄 Institute 모듈들 초기화 중...');

            // 모듈 로드 대기
            await waitForModules([
                'InstituteUtils',
                'InstituteValidation', 
                'InstituteAPI',
                'InstituteCore',
                'InstituteUI'
            ]);

            // 순차적 초기화
            const initResults = [];
            
            initResults.push(await window.InstituteUtils.initialize());
            initResults.push(await window.InstituteValidation.initialize());
            initResults.push(await window.InstituteAPI.initialize());
            initResults.push(await window.InstituteCore.initialize());
            initResults.push(await window.InstituteUI.initialize());

            const failedModules = initResults.filter(result => !result);
            if (failedModules.length > 0) {
                throw new Error(`${failedModules.length}개 모듈 초기화 실패`);
            }

            console.log('✅ 모든 Institute 모듈 초기화 완료');
        }

        /**
         * ⏰ 모듈 로드 대기
         */
        async function waitForModules(moduleNames, timeout = 10000) {
            const startTime = Date.now();
            
            while (Date.now() - startTime < timeout) {
                const allLoaded = moduleNames.every(name => window[name]);
                if (allLoaded) {
                    console.log(`✅ 모든 모듈 로드 완료: ${moduleNames.join(', ')}`);
                    return;
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            const missingModules = moduleNames.filter(name => !window[name]);
            throw new Error(`모듈 로드 타임아웃: ${missingModules.join(', ')}`);
        }

        /**
         * 📡 이벤트 리스너 설정
         */
        function setupEventListeners() {
            // 검색 기능
            const searchInput = document.getElementById('institute-search');
            if (searchInput) {
                searchInput.addEventListener('input', window.Utils.debounce(handleSearch, 300));
            }

            // 뷰 전환 버튼
            document.getElementById('view-toggle-grid')?.addEventListener('click', () => switchView('grid'));
            document.getElementById('view-toggle-list')?.addEventListener('click', () => switchView('list'));

            // 새로고침 버튼
            document.getElementById('refresh-button')?.addEventListener('click', refreshData);

            // 수정 모달 저장 버튼
            document.getElementById('save-institute-btn')?.addEventListener('click', saveInstituteData);

            // 이미지 업로드
            setupImageUpload();

            // ESC 키로 모달 닫기
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });

            console.log('📡 이벤트 리스너 설정 완료');
        }

        /**
         * 📊 초기 데이터 로드
         */
        async function loadInstituteData() {
            try {
                showLoading(true);
                
                // InstituteCore를 통해 데이터 로드
                await window.InstituteCore.loadBasicData();
                
                // UI 렌더링
                await renderInstitutes();
                
                // 통계 업데이트
                updateStatistics();
                
                showLoading(false);
                
            } catch (error) {
                console.error('❌ 데이터 로드 실패:', error);
                showError('학당 데이터를 불러오는데 실패했습니다.');
                showLoading(false);
            }
        }

        /**
         * 🎨 학당 목록 렌더링
         */
        async function renderInstitutes() {
            const institutes = window.InstituteCore.getAllInstitutes();
            
            if (institutes.length === 0) {
                showEmptyState();
                return;
            }

            if (currentView === 'grid') {
                renderGridView(institutes);
            } else {
                renderListView(institutes);
            }

            // 아이콘 다시 생성
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * 🔲 그리드 뷰 렌더링
         */
        function renderGridView(institutes) {
            const grid = document.getElementById('institute-grid');
            const list = document.getElementById('institute-list');
            
            if (!grid) return;

            grid.innerHTML = institutes.map(institute => createInstituteCard(institute)).join('');
            grid.style.display = 'grid';
            if (list) list.style.display = 'none';
        }

        /**
         * 📄 리스트 뷰 렌더링  
         */
        function renderListView(institutes) {
            const grid = document.getElementById('institute-grid');
            const list = document.getElementById('institute-list');
            const tableBody = document.getElementById('institute-table-body');
            
            if (!tableBody) return;

            tableBody.innerHTML = institutes.map(institute => createInstituteRow(institute)).join('');
            if (list) list.style.display = 'block';
            if (grid) grid.style.display = 'none';
        }

        /**
         * 🏗️ 학당 카드 생성
         */
        function createInstituteCard(institute) {
            const displayData = window.InstituteUtils.createDisplayData(institute);
            const completionStatus = getCompletionStatus(institute);
            
            return `
                <div class="institute-card institute-fade-in" data-id="${institute.id}">
                    <div class="institute-card-header">
                        <h3 class="institute-card-name">${institute.name_ko}</h3>
                        ${institute.name_en ? `<p class="institute-card-name-en">${institute.name_en}</p>` : ''}
                        <span class="institute-status-badge ${completionStatus.class}">
                            ${completionStatus.label}
                        </span>
                    </div>
                    
                    <div class="institute-card-body">
                        <div class="institute-info-row">
                            <i data-lucide="building" class="institute-info-icon"></i>
                            <div class="institute-info-content">
                                <div class="institute-info-label">운영기관</div>
                                <div class="institute-info-value ${!institute.operating_organization ? 'placeholder' : ''}">
                                    ${institute.operating_organization || '미설정'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="institute-info-row">
                            <i data-lucide="map-pin" class="institute-info-icon"></i>
                            <div class="institute-info-content">
                                <div class="institute-info-label">주소</div>
                                <div class="institute-info-value long-text ${!institute.address ? 'placeholder' : ''}">
                                    ${window.InstituteUtils.truncateText(institute.address || '주소 미설정', 60)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="institute-info-row">
                            <i data-lucide="user" class="institute-info-icon"></i>
                            <div class="institute-info-content">
                                <div class="institute-info-label">담당자</div>
                                <div class="institute-info-value ${!institute.manager_name ? 'placeholder' : ''}">
                                    ${institute.manager_name || '미지정'}
                                </div>
                            </div>
                        </div>
                        
                        ${getInternSection(institute)}
                    </div>
                    
                    <div class="institute-card-footer">
                        <div class="institute-last-updated">
                            최종 수정: ${displayData.updated_at_relative || '정보 없음'}
                        </div>
                        <div class="institute-card-actions">
                            <button class="institute-btn institute-btn-sm institute-btn-primary" 
                                    onclick="showInstituteDetails('${institute.id}')">
                                <i data-lucide="eye"></i>
                                상세보기
                            </button>
                            <button class="institute-btn institute-btn-sm institute-btn-secondary" 
                                    onclick="editInstitute('${institute.id}')">
                                <i data-lucide="edit"></i>
                                수정
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * 📋 학당 행 생성 (리스트 뷰)
         */
        function createInstituteRow(institute) {
            const completionStatus = getCompletionStatus(institute);
            const internCount = 0; // TODO: 문화인턴 수 계산
            
            return `
                <tr data-id="${institute.id}">
                    <td>
                        <div class="institute-table-name">${institute.name_ko}</div>
                        ${institute.name_en ? `<div class="institute-table-name-en">${institute.name_en}</div>` : ''}
                    </td>
                    <td>${institute.operating_organization || '-'}</td>
                    <td>${window.InstituteUtils.truncateText(institute.address || '-', 40)}</td>
                    <td>${institute.manager_name || '-'}</td>
                    <td>${internCount}명</td>
                    <td>
                        <span class="institute-status-badge ${completionStatus.class}">
                            ${completionStatus.label}
                        </span>
                    </td>
                    <td>
                        <div class="institute-table-actions">
                            <button class="institute-btn institute-btn-sm institute-btn-primary" 
                                    onclick="showInstituteDetails('${institute.id}')">
                                <i data-lucide="eye"></i>
                            </button>
                            <button class="institute-btn institute-btn-sm institute-btn-secondary" 
                                    onclick="editInstitute('${institute.id}')">
                                <i data-lucide="edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        /**
         * 📊 완성도 상태 확인
         */
        function getCompletionStatus(institute) {
            const requiredFields = ['name_ko', 'operating_organization', 'address', 'manager_name'];
            const completedFields = requiredFields.filter(field => 
                institute[field] && institute[field].toString().trim() !== ''
            );
            
            const completion = completedFields.length / requiredFields.length;
            
            if (completion >= 0.8) {
                return { class: 'complete', label: '완료' };
            } else if (completion >= 0.5) {
                return { class: 'pending', label: '진행중' };
            } else {
                return { class: 'incomplete', label: '미완성' };
            }
        }

        /**
         * 👥 문화인턴 섹션 생성
         */
        function getInternSection(institute) {
            // TODO: 실제 문화인턴 데이터 연동
            return `
                <div class="institute-interns-section">
                    <div class="institute-interns-title">
                        <i data-lucide="users"></i>
                        배정된 문화인턴 (0명)
                    </div>
                    <div class="institute-info-value placeholder">
                        배정된 문화인턴이 없습니다
                    </div>
                </div>
            `;
        }

        /**
         * 🔍 검색 처리
         */
        async function handleSearch() {
            const keyword = document.getElementById('institute-search')?.value?.trim();
            
            if (!keyword) {
                await renderInstitutes();
                return;
            }

            try {
                const results = await window.InstituteCore.searchInstitutes({ keyword });
                
                if (currentView === 'grid') {
                    renderGridView(results);
                } else {
                    renderListView(results);
                }

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
            } catch (error) {
                console.error('❌ 검색 실패:', error);
                showError('검색 중 오류가 발생했습니다.');
            }
        }

        /**
         * 🔄 뷰 전환
         */
        function switchView(view) {
            currentView = view;
            
            // 버튼 활성화 상태 업데이트
            document.querySelectorAll('.institute-view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`view-toggle-${view}`)?.classList.add('active');
            
            // 뷰 렌더링
            renderInstitutes();
        }

        /**
         * 👁️ 학당 상세 정보 표시
         */
        async function showInstituteDetails(instituteId) {
            try {
                showLoading(true);
                
                const institute = await window.InstituteCore.getInstituteDetails(instituteId);
                if (!institute) {
                    throw new Error('학당 정보를 찾을 수 없습니다');
                }

                renderDetailModal(institute);
                showModal('institute-detail-modal');
                
                // 수정 버튼 이벤트
                document.getElementById('edit-institute-btn').onclick = () => {
                    closeDetailModal();
                    editInstitute(instituteId);
                };
                
                showLoading(false);
                
            } catch (error) {
                console.error('❌ 상세 정보 로드 실패:', error);
                showError('학당 상세 정보를 불러오는데 실패했습니다.');
                showLoading(false);
            }
        }

        /**
         * 📝 상세 정보 모달 렌더링
         */
        function renderDetailModal(institute) {
            const content = document.getElementById('institute-detail-content');
            if (!content) return;

            const displayData = window.InstituteUtils.createDisplayData(institute);
            const groupedFields = displayData.grouped_fields;

            let modalHTML = '';

            // 학당 이미지
            if (institute.image_url) {
                modalHTML += `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <img src="${institute.image_url}" alt="${institute.name_ko}" 
                             style="max-width: 100%; max-height: 300px; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                    </div>
                `;
            }

            // 필드 그룹별로 렌더링
            Object.entries(groupedFields).forEach(([groupKey, groupData]) => {
                if (groupData.fields.length === 0) return;

                modalHTML += `
                    <div class="institute-field-group" style="margin-bottom: 2rem;">
                        <h3 class="institute-field-group-title">
                            <i data-lucide="${groupData.icon}"></i>
                            ${groupData.name}
                        </h3>
                `;

                groupData.fields.forEach(field => {
                    const value = field.value || '정보 없음';
                    const isLongText = typeof value === 'string' && value.length > 100;
                    
                    modalHTML += `
                        <div class="institute-info-row" style="margin-bottom: 1rem;">
                            <i data-lucide="${field.icon}" class="institute-info-icon"></i>
                            <div class="institute-info-content">
                                <div class="institute-info-label">${field.label}</div>
                                <div class="institute-info-value ${!field.value ? 'placeholder' : ''}" 
                                     ${isLongText ? 'style="white-space: pre-wrap; line-height: 1.6;"' : ''}>
                                    ${field.name === 'website_sns' && field.value ? 
                                        `<a href="${field.value}" target="_blank" rel="noopener">${field.value}</a>` : 
                                        value}
                                </div>
                            </div>
                        </div>
                    `;
                });

                modalHTML += '</div>';
            });

            content.innerHTML = modalHTML;

            // 아이콘 다시 생성
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        /**
         * ✏️ 학당 정보 수정
         */
        async function editInstitute(instituteId) {
            try {
                currentInstitute = await window.InstituteCore.getInstituteDetails(instituteId);
                if (!currentInstitute) {
                    throw new Error('학당 정보를 찾을 수 없습니다');
                }

                populateEditForm(currentInstitute);
                showModal('institute-edit-modal');
                
            } catch (error) {
                console.error('❌ 수정 모달 열기 실패:', error);
                showError('학당 정보를 불러오는데 실패했습니다.');
            }
        }

        /**
         * 📝 수정 폼 데이터 채우기
         */
        function populateEditForm(institute) {
            const formFields = window.InstituteUtils.getAllFields();
            
            formFields.forEach(fieldName => {
                const element = document.getElementById(`edit-${fieldName.replace(/_/g, '-')}`);
                if (element && institute[fieldName]) {
                    element.value = institute[fieldName];
                }
            });

            // 이미지 미리보기
            if (institute.image_url) {
                const preview = document.getElementById('image-preview');
                if (preview) {
                    preview.src = institute.image_url;
                    preview.style.display = 'block';
                }
            }
        }

        /**
         * 💾 학당 정보 저장
         */
        async function saveInstituteData() {
            if (!currentInstitute) return;

            try {
                const formData = new FormData(document.getElementById('institute-edit-form'));
                const updateData = {};
                
                for (const [key, value] of formData.entries()) {
                    if (value.trim()) {
                        updateData[key] = value.trim();
                    }
                }

                // 이미지 URL 추가
                const imageUrl = document.getElementById('edit-image-url')?.value;
                if (imageUrl) {
                    updateData.image_url = imageUrl;
                }

                // 유효성 검사
                const validation = window.InstituteValidation.validateInstituteData(updateData);
                if (!validation.isValid) {
                    showError('입력 데이터에 오류가 있습니다: ' + validation.errors.join(', '));
                    return;
                }

                showLoading(true);

                // 데이터 업데이트
                const success = await window.InstituteCore.updateInstituteInfo(currentInstitute.id, updateData);
                
                if (success) {
                    showSuccess('학당 정보가 성공적으로 업데이트되었습니다.');
                    closeEditModal();
                    await refreshData();
                } else {
                    throw new Error('업데이트 실패');
                }

                showLoading(false);
                
            } catch (error) {
                console.error('❌ 저장 실패:', error);
                showError('저장 중 오류가 발생했습니다: ' + error.message);
                showLoading(false);
            }
        }

        /**
         * 📸 이미지 업로드 설정
         */
        function setupImageUpload() {
            const uploadArea = document.getElementById('image-upload-area');
            const fileInput = document.getElementById('image-file-input');
            const preview = document.getElementById('image-preview');
            const hiddenInput = document.getElementById('edit-image-url');

            if (!uploadArea || !fileInput) return;

            // 클릭으로 파일 선택
            uploadArea.addEventListener('click', () => fileInput.click());

            // 파일 선택 처리
            fileInput.addEventListener('change', handleImageSelect);

            // 드래그 앤 드롭
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleImageFile(files[0]);
                }
            });

            async function handleImageSelect() {
                const file = fileInput.files[0];
                if (file) {
                    await handleImageFile(file);
                }
            }

            async function handleImageFile(file) {
                if (!currentInstitute) return;

                try {
                    // 파일 검증
                    if (!file.type.startsWith('image/')) {
                        throw new Error('이미지 파일만 업로드 가능합니다.');
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('파일 크기는 5MB 이하여야 합니다.');
                    }

                    showLoading(true);

                    // 이미지 업로드
                    const imageUrl = await window.InstituteAPI.uploadInstituteImage(file, currentInstitute.id);
                    
                    if (imageUrl) {
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                        hiddenInput.value = imageUrl;
                        showSuccess('이미지가 업로드되었습니다.');
                    } else {
                        throw new Error('이미지 업로드에 실패했습니다.');
                    }

                    showLoading(false);

                } catch (error) {
                    console.error('❌ 이미지 업로드 실패:', error);
                    showError(error.message);
                    showLoading(false);
                }
            }
        }

        /**
         * 📊 통계 업데이트
         */
        function updateStatistics() {
            const institutes = window.InstituteCore.getAllInstitutes();
            
            let assignedInterns = 0;
            let completeInstitutes = 0;
            let incompleteInstitutes = 0;

            institutes.forEach(institute => {
                // TODO: 실제 문화인턴 수 계산
                // assignedInterns += institute.interns ? institute.interns.length : 0;
                
                const status = getCompletionStatus(institute);
                if (status.class === 'complete') {
                    completeInstitutes++;
                } else {
                    incompleteInstitutes++;
                }
            });

            // 통계 업데이트
            document.getElementById('total-institutes').textContent = institutes.length;
            document.getElementById('assigned-interns').textContent = assignedInterns;
            document.getElementById('complete-institutes').textContent = completeInstitutes;
            document.getElementById('incomplete-institutes').textContent = incompleteInstitutes;
        }

        /**
         * 🔄 데이터 새로고침
         */
        async function refreshData() {
            console.log('🔄 데이터 새로고침...');
            
            try {
                // 캐시 클리어
                window.InstituteCore.clearCache();
                
                // 데이터 다시 로드
                await loadInstituteData();
                
                showSuccess('데이터가 새로고침되었습니다.');
                
            } catch (error) {
                console.error('❌ 새로고침 실패:', error);
                showError('데이터 새로고침에 실패했습니다.');
            }
        }

        /**
         * 🚪 모달 관리
         */
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeDetailModal() {
            document.getElementById('institute-detail-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeEditModal() {
            document.getElementById('institute-edit-modal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentInstitute = null;
        }

        function closeAllModals() {
            closeDetailModal();
            closeEditModal();
        }

        /**
         * 🎨 UI 상태 관리
         */
        function showLoading(show) {
            const spinner = document.getElementById('loading-spinner');
            const container = document.getElementById('institute-management-container');
            
            if (spinner) {
                spinner.style.display = show ? 'flex' : 'none';
            }
        }

        function showEmptyState() {
            document.getElementById('institute-grid').style.display = 'none';
            document.getElementById('institute-list').style.display = 'none';
            document.getElementById('empty-state').style.display = 'block';
        }

        function showError(message) {
            if (window.Utils && window.Utils.showToast) {
                window.Utils.showToast(message, 'error');
            } else {
                alert('오류: ' + message);
            }
        }

        function showSuccess(message) {
            if (window.Utils && window.Utils.showToast) {
                window.Utils.showToast(message, 'success');
            } else {
                console.log('✅ ' + message);
            }
        }

        /**
         * 🔙 대시보드로 돌아가기
         */
        function goBackToDashboard() {
            console.log('🔙 대시보드로 돌아가기');
            window.location.href = '../admin.html';
        }

        // 개발자 디버그 키보드 단축키
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                console.log('🛠️ C단계 디버그 정보');
                console.log('모듈 상태:', {
                    InstituteUtils: window.InstituteUtils?.getUtilsStatus(),
                    InstituteValidation: window.InstituteValidation?.getValidationStatus(),
                    InstituteAPI: window.InstituteAPI?.getAPIStatus(),
                    InstituteCore: window.InstituteCore?.getModuleStatus(),
                    InstituteUI: window.InstituteUI?.getUIStatus()
                });
                console.log('현재 뷰:', currentView);
                console.log('현재 편집 중인 학당:', currentInstitute);
            }
        });

        console.log('🏛️ 파견학당 정보 관리 시스템 v4.4.0 스크립트 로드 완료');
    </script>
</body>
</html>
