<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ (v4.7.1)</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="../css/main.css?v=4.7.1">
    <link rel="stylesheet" href="../css/institute.css?v=4.7.1">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="institute-management-container">
        <!-- í—¤ë” ì„¹ì…˜ -->
        <div class="institute-header">
            <div class="institute-header-content">
                <div class="institute-header-title">
                    <h1>íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ (v4.7.1)</h1>
                    <p>ì„¸ì¢…í•™ë‹¹ì˜ 17ê°œ í•„ë“œ ì •ë³´ë¥¼ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ê³  ë¬¸í™”ì¸í„´ ë°°ì • í˜„í™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <div class="alert alert-success">
                        <i data-lucide="check-circle"></i>
                        <strong>v4.7.1 UI ê°œì„ !</strong> í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì •ë³´ ì…ë ¥ì´ ë”ìš± ì§ê´€ì ìœ¼ë¡œ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.
                    </div>
                </div>
                <button class="institute-btn institute-btn-secondary" onclick="goBackToDashboard()">
                    <i data-lucide="arrow-left"></i>
                    ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>

        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="institute-stats-section">
            <div class="institute-stat-card total">
                <div class="institute-stat-icon">
                    <i data-lucide="building2"></i>
                </div>
                <div class="institute-stat-number" id="total-institutes">-</div>
                <p class="institute-stat-label">ì´ ì„¸ì¢…í•™ë‹¹ ìˆ˜</p>
            </div>
            <div class="institute-stat-card assigned">
                <div class="institute-stat-icon">
                    <i data-lucide="users"></i>
                </div>
                <div class="institute-stat-number" id="assigned-interns">-</div>
                <p class="institute-stat-label">ë°°ì •ëœ ë¬¸í™”ì¸í„´</p>
            </div>
            <div class="institute-stat-card active">
                <div class="institute-stat-icon">
                    <i data-lucide="check-circle"></i>
                </div>
                <div class="institute-stat-number" id="complete-institutes">-</div>
                <p class="institute-stat-label">ì •ë³´ ì™„ì„± í•™ë‹¹</p>
            </div>
            <div class="institute-stat-card pending">
                <div class="institute-stat-icon">
                    <i data-lucide="alert-circle"></i>
                </div>
                <div class="institute-stat-number" id="incomplete-institutes">-</div>
                <p class="institute-stat-label">ì •ë³´ ë¯¸ì™„ì„± í•™ë‹¹</p>
            </div>
        </div>

        <!-- í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ -->
        <div class="institute-filters-section">
            <div class="institute-filters-grid">
                <div class="institute-search-box">
                    <i data-lucide="search" class="institute-search-icon"></i>
                    <input type="text" class="institute-search-input" id="institute-search" 
                           placeholder="í•™ë‹¹ëª…, ë‹´ë‹¹ì ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰...">
                </div>
                <button class="institute-btn institute-btn-success" id="add-institute-btn">
                    <i data-lucide="plus"></i>
                    ìƒˆ í•™ë‹¹ ì¶”ê°€
                </button>
                <button class="institute-btn institute-btn-primary" id="refresh-button">
                    <i data-lucide="refresh-cw"></i>
                    ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
        <div id="institute-management-container">
            <!-- ë¡œë”© ìƒíƒœ -->
            <div class="institute-loading" id="loading-spinner">
                <div class="institute-loading-spinner"></div>
                <span>í•™ë‹¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
            </div>

            <!-- ì—ëŸ¬ ìƒíƒœ -->
            <div class="institute-error-state" id="error-state" style="display: none;">
                <i data-lucide="alert-triangle" class="institute-error-icon"></i>
                <h3>ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h3>
                <p id="error-message">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <button class="institute-btn institute-btn-primary" onclick="retryDataLoad()">
                    <i data-lucide="refresh-cw"></i>
                    ë‹¤ì‹œ ì‹œë„
                </button>
            </div>

            <!-- ë¦¬ìŠ¤íŠ¸ ë·° (ë‹¨ì¼ ë·°) -->
            <div class="institute-list" id="institute-list" style="display: none;">
                <table class="institute-table">
                    <thead>
                        <tr>
                            <th>í•™ë‹¹ëª…</th>
                            <th>ë‹´ë‹¹ì</th>
                            <th>ë‹´ë‹¹ì ì—°ë½ì²˜</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="institute-table-body">
                        <!-- í•™ë‹¹ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>

            <!-- ë¹ˆ ìƒíƒœ -->
            <div class="institute-empty-state" id="empty-state" style="display: none;">
                <i data-lucide="search" class="institute-empty-icon"></i>
                <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”.</p>
                <button class="institute-btn institute-btn-secondary" onclick="clearSearch()">
                    <i data-lucide="x"></i>
                    ê²€ìƒ‰ ì´ˆê¸°í™”
                </button>
            </div>
        </div>
    </div>

    <!-- í•™ë‹¹ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="institute-modal-overlay" id="institute-detail-modal" style="display: none;">
        <div class="institute-modal">
            <div class="institute-modal-header">
                <h2 class="institute-modal-title">
                    <i data-lucide="building2"></i>
                    í•™ë‹¹ ìƒì„¸ ì •ë³´
                </h2>
                <button class="institute-modal-close" onclick="InstituteManager.closeDetailModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="institute-modal-body" id="institute-detail-content">
                <!-- ìƒì„¸ ì •ë³´ê°€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            <div class="institute-modal-footer">
                <button class="institute-btn institute-btn-primary" id="edit-institute-btn">
                    <i data-lucide="edit"></i>
                    ì •ë³´ ìˆ˜ì •
                </button>
                <button class="institute-btn institute-btn-secondary" onclick="InstituteManager.closeDetailModal()">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ì™„ì „ ê°œì„ ëœ í•™ë‹¹ ì •ë³´ ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="institute-modal-overlay" id="institute-edit-modal" style="display: none;">
        <div class="institute-modal">
            <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
            <div class="institute-modal-loading" id="modal-loading" style="display: none;">
                <div class="institute-modal-loading-content">
                    <div class="institute-modal-loading-spinner"></div>
                    <div class="institute-modal-loading-text">ì²˜ë¦¬ ì¤‘...</div>
                </div>
            </div>

            <div class="institute-modal-header">
                <h2 class="institute-modal-title">
                    <i data-lucide="edit"></i>
                    í•™ë‹¹ ì •ë³´ ìˆ˜ì •
                </h2>
                <button class="institute-modal-close" onclick="InstituteManager.closeEditModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="institute-modal-body">
                <form id="institute-edit-form">
                    <div class="institute-field-groups">
                        <!-- ê¸°ë³¸ ì •ë³´ ê·¸ë£¹ -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="info"></i>
                                ê¸°ë³¸ ì •ë³´
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label required" for="edit-name-ko">í•™ë‹¹ëª…</label>
                                <input type="text" class="institute-form-input" id="edit-name-ko" name="name_ko" required>
                                <div class="institute-form-help">í•™ë‹¹ì˜ ê³µì‹ í•œêµ­ì–´ ëª…ì¹­</div>
                                <div class="institute-form-error" id="error-name-ko" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-name-en">í•™ë‹¹ ì˜ë¬¸ëª…</label>
                                <input type="text" class="institute-form-input" id="edit-name-en" name="name_en">
                                <div class="institute-form-help">í•™ë‹¹ì˜ ì˜ë¬¸ ëª…ì¹­</div>
                                <div class="institute-form-error" id="error-name-en" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-operating-organization">ìš´ì˜ ê¸°ê´€</label>
                                <input type="text" class="institute-form-input" id="edit-operating-organization" name="operator">
                                <div class="institute-form-help">í•™ë‹¹ì„ ìš´ì˜í•˜ëŠ” ê¸°ê´€ëª…</div>
                                <div class="institute-form-error" id="error-operating-organization" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-image-url">í•™ë‹¹ ì‚¬ì§„</label>
                                <div class="institute-image-upload" id="image-upload-area">
                                    <img id="image-preview" class="institute-image-preview" style="display: none;">
                                    <i data-lucide="upload" class="institute-image-upload-icon"></i>
                                    <div class="institute-image-upload-text">
                                        í´ë¦­í•˜ê±°ë‚˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ
                                    </div>
                                </div>
                                <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                                <input type="hidden" id="edit-image-url" name="image_url">
                                <div class="institute-form-error" id="error-image-url" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- ì—°ë½ì²˜ ì •ë³´ ê·¸ë£¹ -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="phone"></i>
                                ì—°ë½ì²˜ ì •ë³´
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-address">ì£¼ì†Œ</label>
                                <textarea class="institute-form-textarea" id="edit-address" name="address" rows="3"></textarea>
                                <div class="institute-form-help">í•™ë‹¹ì˜ ìƒì„¸ ì£¼ì†Œ</div>
                                <div class="institute-form-error" id="error-address" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-phone">ëŒ€í‘œ ì—°ë½ì²˜</label>
                                <input type="tel" class="institute-form-input" id="edit-phone" name="phone">
                                <div class="institute-form-help">í•™ë‹¹ì˜ ëŒ€í‘œ ì „í™”ë²ˆí˜¸</div>
                                <div class="institute-form-error" id="error-phone" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-website-sns">í™ˆí˜ì´ì§€ ë˜ëŠ” SNS</label>
                                <input type="url" class="institute-form-input" id="edit-website-sns" name="sns_url">
                                <div class="institute-form-help">í•™ë‹¹ì˜ ì›¹ì‚¬ì´íŠ¸ ë˜ëŠ” SNS ì£¼ì†Œ</div>
                                <div class="institute-form-error" id="error-website-sns" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-manager-name">ë‹´ë‹¹ì ì„±ëª…</label>
                                <input type="text" class="institute-form-input" id="edit-manager-name" name="contact_person">
                                <div class="institute-form-help">í•™ë‹¹ ë‹´ë‹¹ìì˜ ì„±ëª…</div>
                                <div class="institute-form-error" id="error-manager-name" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-manager-contact">ë‹´ë‹¹ì ì—°ë½ì²˜</label>
                                <input type="text" class="institute-form-input" id="edit-manager-contact" name="contact_phone">
                                <div class="institute-form-help">ë‹´ë‹¹ìì˜ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ì´ë©”ì¼</div>
                                <div class="institute-form-error" id="error-manager-contact" style="display: none;"></div>
                            </div>
                            
                            <!-- ê°œì„ ëœ í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì •ë³´ ì„¹ì…˜ -->
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-local-coordinator">í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥</label>
                                <div class="institute-form-checkbox-group">
                                    <label class="institute-form-checkbox">
                                        <input type="checkbox" id="coordinator-same-as-manager">
                                        ë‹´ë‹¹ìì™€ ë™ì¼
                                    </label>
                                </div>
                                <input type="text" class="institute-form-input" id="edit-local-coordinator" name="local_coordinator">
                                <div class="institute-form-help">í˜„ì§€ ì ì‘ì„ ë„ì™€ì£¼ëŠ” ì „ë‹´ ì¸ë ¥ ì„±ëª…</div>
                                <div class="institute-form-error" id="error-local-coordinator" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-local-coordinator-contact">í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì—°ë½ì²˜</label>
                                <input type="text" class="institute-form-input" id="edit-local-coordinator-contact" name="local_coordinator_phone">
                                <div class="institute-form-help">í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ì˜ ì „í™”ë²ˆí˜¸ ë˜ëŠ” ì´ë©”ì¼</div>
                                <div class="institute-form-error" id="error-local-coordinator-contact" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- í”„ë¡œê·¸ë¨ ì •ë³´ ê·¸ë£¹ -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="graduation-cap"></i>
                                í”„ë¡œê·¸ë¨ ì •ë³´
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-cultural-program-plan">ë¬¸í™”ìˆ˜ì—… ìš´ì˜ ê³„íš</label>
                                <textarea class="institute-form-textarea" id="edit-cultural-program-plan" name="lesson_plan" rows="4"></textarea>
                                <div class="institute-form-help">ë¬¸í™” ìˆ˜ì—… ìš´ì˜ ê³„íš ë° ë‚´ìš©</div>
                                <div class="institute-form-error" id="error-cultural-program-plan" style="display: none;"></div>
                            </div>
                            
                            <!-- í¬ë§ ê°œì„¤ ê°•ì¢Œ í…Œì´ë¸” -->
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-desired-courses">í¬ë§ ê°œì„¤ ê°•ì¢Œ</label>
                                <div class="institute-table-input" id="desired-courses-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ê°•ì¢Œëª…</th>
                                                <th>ë ˆë²¨</th>
                                                <th>ì‹œê°„</th>
                                                <th>ì˜ˆìƒ ì¸ì›</th>
                                                <th>ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="courses-table-body">
                                            <!-- ê°•ì¢Œ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                        </tbody>
                                    </table>
                                    <div class="institute-table-add-row">
                                        <button type="button" class="institute-table-add-btn" id="add-course-btn">
                                            <i data-lucide="plus"></i>
                                            ê°•ì¢Œ ì¶”ê°€
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-desired-courses" name="desired_courses">
                                <div class="institute-form-help">ê°œì„¤í•˜ê³ ì í•˜ëŠ” ê°•ì¢Œ ëª©ë¡ (ìµœëŒ€ 10ê°œ)</div>
                                <div class="institute-form-error" id="error-desired-courses" style="display: none;"></div>
                            </div>

                            <!-- êµìœ¡ í™˜ê²½ ì •ë³´ -->
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-education-environment">êµìœ¡ í™˜ê²½ ì •ë³´</label>
                                <div class="institute-table-input" id="education-environment-table">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>ê°•ì˜ ì£¼ì œ</th>
                                                <th>êµìœ¡ ì¥ì†Œ</th>
                                                <th>í•™ë‹¹ êµêµ¬ ë° ê¸°ìì¬</th>
                                                <th>ì‘ì—…</th>
                                            </tr>
                                        </thead>
                                        <tbody id="education-environment-table-body">
                                            <!-- êµìœ¡ í™˜ê²½ í–‰ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                                        </tbody>
                                    </table>
                                    <div class="institute-table-add-row">
                                        <button type="button" class="institute-table-add-btn" id="add-education-environment-btn">
                                            <i data-lucide="plus"></i>
                                            êµìœ¡ í™˜ê²½ ì¶”ê°€
                                        </button>
                                    </div>
                                </div>
                                <input type="hidden" id="edit-education-environment" name="education_environment">
                                <div class="institute-form-help">êµìœ¡ í™˜ê²½ ë° êµêµ¬ ê´€ë ¨ ì •ë³´ (ìµœëŒ€ 10ê°œ)</div>
                                <div class="institute-form-error" id="error-education-environment" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- ì§€ì› ì •ë³´ ê·¸ë£¹ -->
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="help-circle"></i>
                                ì§€ì› ì •ë³´
                            </h3>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-local-language-requirement">í˜„ì§€ì–´ êµ¬ì‚¬ í•„ìš” ìˆ˜ì¤€</label>
                                <textarea class="institute-form-textarea" id="edit-local-language-requirement" name="local_language_requirement" rows="4"></textarea>
                                <div class="institute-form-help">ë¬¸í™”ì¸í„´ì—ê²Œ ìš”êµ¬ë˜ëŠ” í˜„ì§€ì–´ ìˆ˜ì¤€</div>
                                <div class="institute-form-error" id="error-local-language-requirement" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-institute-support">í•™ë‹¹ ì§€ì› ì‚¬í•­</label>
                                <textarea class="institute-form-textarea" id="edit-institute-support" name="support_provided" rows="4"></textarea>
                                <div class="institute-form-help">í•™ë‹¹ì—ì„œ ì œê³µí•˜ëŠ” ì§€ì› ì‚¬í•­</div>
                                <div class="institute-form-error" id="error-institute-support" style="display: none;"></div>
                            </div>
                            <div class="institute-form-group">
                                <label class="institute-form-label" for="edit-country-safety-info">íŒŒê²¬ êµ­ê°€ ì•ˆì „ ì •ë³´</label>
                                <input type="url" class="institute-form-input" id="edit-country-safety-info" name="safety_info_url">
                                <div class="institute-form-help">íŒŒê²¬ êµ­ê°€ì˜ ì•ˆì „ ê´€ë ¨ ì •ë³´ URL</div>
                                <div class="institute-form-error" id="error-country-safety-info" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="institute-modal-footer">
                <button class="institute-btn institute-btn-success" id="save-institute-btn">
                    <i data-lucide="save"></i>
                    ì €ì¥í•˜ê¸°
                </button>
                <button class="institute-btn institute-btn-secondary" onclick="InstituteManager.closeEditModal()">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- ìƒˆ í•™ë‹¹ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="institute-modal-overlay" id="institute-add-modal" style="display: none;">
        <div class="institute-modal">
            <div class="institute-modal-header">
                <h2 class="institute-modal-title">
                    <i data-lucide="plus"></i>
                    ìƒˆ í•™ë‹¹ ì¶”ê°€
                </h2>
                <button class="institute-modal-close" onclick="InstituteManager.closeAddModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="institute-modal-body">
                <p>ìƒˆ í•™ë‹¹ì„ ì¶”ê°€í•˜ë ¤ë©´ í•™ë‹¹ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:</p>
                <form id="institute-add-form">
                    <div class="institute-form-group">
                        <label class="institute-form-label required" for="add-name-ko">í•™ë‹¹ëª…</label>
                        <input type="text" class="institute-form-input" id="add-name-ko" name="name_ko" required>
                        <div class="institute-form-help">í•™ë‹¹ì˜ ê³µì‹ í•œêµ­ì–´ ëª…ì¹­</div>
                    </div>
                </form>
            </div>
            <div class="institute-modal-footer">
                <button class="institute-btn institute-btn-success" id="create-institute-btn">
                    <i data-lucide="plus"></i>
                    í•™ë‹¹ ì¶”ê°€
                </button>
                <button class="institute-btn institute-btn-secondary" onclick="InstituteManager.closeAddModal()">
                    ì·¨ì†Œ
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <!-- 1. ê¸°ë³¸ ì„¤ì • ëª¨ë“ˆ (ì˜ì¡´ì„± ìˆœì„œ ì¤‘ìš”!) -->
    <script src="../js/config.js?v=4.7.1"></script>
    <script src="../js/auth.js?v=4.7.1"></script>
    <script src="../js/utils.js?v=4.7.1"></script>
    
    <!-- 2. Supabase ëª¨ë“ˆë“¤ -->
    <script src="../js/supabase/supabase-core.js?v=4.7.1"></script>
    <script src="../js/supabase/supabase-student.js?v=4.7.1"></script>
    <script src="../js/supabase/supabase-admin.js?v=4.7.1"></script>
    <script src="../js/supabase-client.js?v=4.7.1"></script>

    <!-- 3. Institute ì „ìš© ëª¨ë“ˆë“¤ -->
    <script src="../js/institute/institute-utils.js?v=4.7.1"></script>
    <script src="../js/institute/institute-validation.js?v=4.7.1"></script>
    <script src="../js/institute/institute-api.js?v=4.7.1"></script>
    <script src="../js/institute/institute-core.js?v=4.7.1"></script>
    <script src="../js/institute/institute-ui.js?v=4.7.1"></script>

    <script>
        // ğŸ›ï¸ íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ (v4.7.1) - UI ê°œì„ 
        console.log('ğŸ›ï¸ íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ v4.7.1 ì´ˆê¸°í™” - UI ê°œì„  ë²„ì „');

        /**
         * ğŸ”§ í†µí•© ë§¤ë‹ˆì € í´ë˜ìŠ¤ (v4.7.1)
         */
        class InstituteManagerD {
            constructor() {
                this.currentInstitute = null;
                this.currentView = 'list'; // ë‹¨ì¼ ë·°: listë§Œ ì§€ì›
                this.validationState = {};
                this.coursesData = [];
                this.educationEnvironmentData = []; // ìƒˆë¡œ ì¶”ê°€
                this.isInitialized = false;
                this.retryCount = 0;
                this.maxRetries = 3;
            }

            /**
             * ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
             */
            async initialize() {
                if (this.isInitialized) return;

                try {
                    console.log('ğŸ”„ v4.7.1 ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘ - UI ê°œì„  ë²„ì „');
                    
                    // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }

                    // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
                    this.checkAdminAuthentication();

                    // ëª¨ë“ˆ ì˜ì¡´ì„± í™•ì¸
                    await this.waitForModules();

                    // ëª¨ë“ˆ ì´ˆê¸°í™”
                    await this.initializeModules();

                    // UI ì´ë²¤íŠ¸ ì„¤ì •
                    this.setupEventListeners();

                    // ì‹¤ì‹œê°„ ê²€ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    this.initializeRealTimeValidation();

                    // ê°•ì¢Œ í…Œì´ë¸” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    this.initializeCourseTableSystem();

                    // êµìœ¡ í™˜ê²½ í…Œì´ë¸” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    this.initializeEducationEnvironmentTableSystem();

                    // ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                    this.setupImageUpload();

                    // í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ (ê°œì„ ë¨)
                    this.setupCoordinatorSameAsManagerCheckbox();

                    // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                    await this.loadInitialData();

                    this.isInitialized = true;
                    console.log('âœ… v4.7.1 ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ - UI ê°œì„  ì™„ë£Œ');

                } catch (error) {
                    console.error('âŒ v4.7.1 ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                    this.showError(`ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                    this.showErrorState(error.message);
                }
            }

            /**
             * ğŸ” ê´€ë¦¬ì ì¸ì¦ í™•ì¸
             */
            checkAdminAuthentication() {
                console.log('ğŸ” ê´€ë¦¬ì ì¸ì¦ í™•ì¸ ì¤‘...');
                
                const adminSession = localStorage.getItem('adminSession');
                if (!adminSession) {
                    console.warn('âš ï¸ ê´€ë¦¬ì ì„¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤');
                    alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '../admin.html';
                    return;
                }

                console.log('âœ… ê´€ë¦¬ì ì¸ì¦ í™•ì¸ë¨');
            }

            /**
             * â° ëª¨ë“ˆ ë¡œë“œ ëŒ€ê¸°
             */
            async waitForModules() {
                const requiredModules = [
                    'SupabaseCore', 'Utils', 'CONFIG',
                    'InstituteUtils', 'InstituteValidation', 
                    'InstituteAPI', 'InstituteCore'
                ];

                const timeout = 15000; // 15ì´ˆ
                const startTime = Date.now();
                
                while (Date.now() - startTime < timeout) {
                    const allLoaded = requiredModules.every(name => window[name]);
                    if (allLoaded) {
                        console.log('âœ… ëª¨ë“  í•„ìˆ˜ ëª¨ë“ˆ ë¡œë“œ ì™„ë£Œ (v4.7.1)');
                        return;
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const missingModules = requiredModules.filter(name => !window[name]);
                throw new Error(`ëª¨ë“ˆ ë¡œë“œ íƒ€ì„ì•„ì›ƒ: ${missingModules.join(', ')}`);
            }

            /**
             * ğŸ”§ ëª¨ë“ˆ ì´ˆê¸°í™”
             */
            async initializeModules() {
                console.log('ğŸ”„ ëª¨ë“ˆ ì´ˆê¸°í™” ì¤‘... (v4.7.1 UI ê°œì„  í¬í•¨)');

                const modules = [
                    'InstituteUtils',
                    'InstituteValidation', 
                    'InstituteAPI',
                    'InstituteCore'
                ];

                for (const moduleName of modules) {
                    const module = window[moduleName];
                    if (module && typeof module.initialize === 'function') {
                        const success = await module.initialize();
                        if (!success) {
                            throw new Error(`${moduleName} ì´ˆê¸°í™” ì‹¤íŒ¨`);
                        }
                        console.log(`âœ… ${moduleName} ì´ˆê¸°í™” ì™„ë£Œ`);
                    }
                }

                console.log('âœ… ëª¨ë“  ëª¨ë“ˆ ì´ˆê¸°í™” ì™„ë£Œ (v4.7.1)');
            }

            /**
             * ğŸ“¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (v4.7.1)
             */
            setupEventListeners() {
                // ê²€ìƒ‰ ê¸°ëŠ¥
                const searchInput = document.getElementById('institute-search');
                if (searchInput) {
                    searchInput.addEventListener('input', this.debounce(this.handleSearch.bind(this), 300));
                }

                // ì•¡ì…˜ ë²„íŠ¼
                document.getElementById('add-institute-btn')?.addEventListener('click', this.showAddModal.bind(this));
                document.getElementById('refresh-button')?.addEventListener('click', this.refreshData.bind(this));

                // ëª¨ë‹¬ ì €ì¥ ë²„íŠ¼
                document.getElementById('save-institute-btn')?.addEventListener('click', this.saveInstituteData.bind(this));
                document.getElementById('create-institute-btn')?.addEventListener('click', this.createNewInstitute.bind(this));

                // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }
                });

                // ë¦¬ìŠ¤íŠ¸ ì´ë²¤íŠ¸ ìœ„ì„
                document.getElementById('institute-table-body')?.addEventListener('click', this.handleTableClick.bind(this));

                console.log('ğŸ“¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ (v4.7.1)');
            }

            /**
             * ğŸ‘¥ í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ 'ë‹´ë‹¹ìì™€ ë™ì¼' ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ (v4.7.1 ê°œì„ )
             */
            setupCoordinatorSameAsManagerCheckbox() {
                const checkbox = document.getElementById('coordinator-same-as-manager');
                if (!checkbox) return;

                checkbox.addEventListener('change', (e) => {
                    const managerName = document.getElementById('edit-manager-name');
                    const managerContact = document.getElementById('edit-manager-contact');
                    const coordinatorName = document.getElementById('edit-local-coordinator');
                    const coordinatorContact = document.getElementById('edit-local-coordinator-contact');

                    if (e.target.checked) {
                        // ë‹´ë‹¹ì ì •ë³´ë¥¼ í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì •ë³´ë¡œ ë³µì‚¬
                        if (managerName && coordinatorName) {
                            coordinatorName.value = managerName.value;
                        }
                        if (managerContact && coordinatorContact) {
                            coordinatorContact.value = managerContact.value;
                        }
                        
                        // í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ í•„ë“œ ë¹„í™œì„±í™”
                        if (coordinatorName) coordinatorName.disabled = true;
                        if (coordinatorContact) coordinatorContact.disabled = true;
                    } else {
                        // í•„ë“œ í™œì„±í™”
                        if (coordinatorName) coordinatorName.disabled = false;
                        if (coordinatorContact) coordinatorContact.disabled = false;
                    }
                });

                // ë‹´ë‹¹ì í•„ë“œ ë³€ê²½ ì‹œ ìë™ ì—…ë°ì´íŠ¸
                const managerName = document.getElementById('edit-manager-name');
                const managerContact = document.getElementById('edit-manager-contact');
                
                if (managerName) {
                    managerName.addEventListener('input', () => {
                        if (checkbox.checked) {
                            const coordinatorName = document.getElementById('edit-local-coordinator');
                            if (coordinatorName) coordinatorName.value = managerName.value;
                        }
                    });
                }

                if (managerContact) {
                    managerContact.addEventListener('input', () => {
                        if (checkbox.checked) {
                            const coordinatorContact = document.getElementById('edit-local-coordinator-contact');
                            if (coordinatorContact) coordinatorContact.value = managerContact.value;
                        }
                    });
                }

                console.log('âœ… í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸ ì„¤ì • ì™„ë£Œ (v4.7.1 ê°œì„ )');
            }

            /**
             * ğŸ“Š ì´ˆê¸° ë°ì´í„° ë¡œë“œ (ê°„ì†Œí™”ëœ í•„ë“œë§Œ)
             */
            async loadInitialData() {
                try {
                    this.showLoading(true);
                    
                    console.log('ğŸ“Š ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹œì‘ (í•„ìˆ˜ ì •ë³´ë§Œ)...');
                    
                    // í•„ìš”í•œ ì •ë³´ë§Œ ë¡œë“œ
                    const institutes = await this.loadInstituteListSimplified();
                    console.log(`ğŸ“‹ ${institutes.length}ê°œ í•™ë‹¹ ë¡œë“œë¨`);
                    
                    if (institutes.length === 0) {
                        this.showEmptyState();
                        this.showInfo('ë°ì´í„°ë² ì´ìŠ¤ì— í•™ë‹¹ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. "ìƒˆ í•™ë‹¹ ì¶”ê°€" ë²„íŠ¼ì„ ì‚¬ìš©í•´ í•™ë‹¹ì„ ì¶”ê°€í•˜ì„¸ìš”.');
                    } else {
                        this.renderListView(institutes);
                    }
                    
                    // í†µê³„ ì—…ë°ì´íŠ¸
                    this.updateStatistics(institutes);
                    
                    this.showLoading(false);
                    console.log('âœ… ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ (v4.7.1)');
                    
                } catch (error) {
                    console.error('âŒ ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showLoading(false);
                    this.showErrorState(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
                }
            }

            /**
             * ğŸ“‹ ê°„ì†Œí™”ëœ í•™ë‹¹ ëª©ë¡ ë¡œë“œ (í•„ìš”í•œ í•„ë“œë§Œ)
             */
            async loadInstituteListSimplified() {
                try {
                    if (!window.InstituteAPI) {
                        throw new Error('InstituteAPI ëª¨ë“ˆì´ ì—†ìŠµë‹ˆë‹¤');
                    }

                    // í•„ìš”í•œ í•„ë“œë§Œ ì¡°íšŒí•˜ëŠ” ìƒˆë¡œìš´ API ì‚¬ìš©
                    const institutes = await window.InstituteAPI.getInstituteList();
                    
                    // ê° í•™ë‹¹ì˜ ë‹´ë‹¹ì ì •ë³´ ì¶”ê°€ ì¡°íšŒ
                    const enrichedInstitutes = [];
                    for (const institute of institutes) {
                        const details = await window.InstituteAPI.getInstituteById(institute.id);
                        enrichedInstitutes.push({
                            id: institute.id,
                            name_ko: institute.name_ko,
                            name_en: institute.name_en,
                            contact_person: details?.contact_person || '',
                            contact_phone: details?.contact_phone || '',
                            completion_percentage: details?.completion_percentage || 0,
                            info_completed: details?.info_completed || false,
                            updated_at: institute.updated_at
                        });
                    }
                    
                    return enrichedInstitutes;
                    
                } catch (error) {
                    console.error('âŒ ê°„ì†Œí™”ëœ í•™ë‹¹ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                    return [];
                }
            }

            /**
             * ğŸ“„ ë¦¬ìŠ¤íŠ¸ ë·° ë Œë”ë§ (ë‹¨ìˆœí™”)
             */
            renderListView(institutes) {
                const list = document.getElementById('institute-list');
                const tableBody = document.getElementById('institute-table-body');
                
                if (!tableBody) return;

                tableBody.innerHTML = institutes.map(institute => this.createInstituteRowSimplified(institute)).join('');
                if (list) list.style.display = 'block';
                
                this.hideEmptyAndError();
            }

            /**
             * ğŸ“‹ í•™ë‹¹ í–‰ ìƒì„± (ë‹¨ìˆœí™”ëœ ë²„ì „)
             */
            createInstituteRowSimplified(institute) {
                const completionStatus = this.getCompletionStatus(institute);
                
                return `
                    <tr data-id="${institute.id}">
                        <td>
                            <div class="institute-table-name">${institute.name_ko}</div>
                            ${institute.name_en ? `<div class="institute-table-name-en">${institute.name_en}</div>` : ''}
                        </td>
                        <td>${institute.contact_person || '-'}</td>
                        <td>${institute.contact_phone || '-'}</td>
                        <td>
                            <span class="institute-status-badge ${completionStatus.class}">
                                ${completionStatus.label}
                            </span>
                        </td>
                        <td>
                            <div class="institute-table-actions">
                                <button class="institute-btn institute-btn-sm institute-btn-primary" 
                                        data-action="view" data-id="${institute.id}">
                                    <i data-lucide="eye"></i>
                                </button>
                                <button class="institute-btn institute-btn-sm institute-btn-secondary" 
                                        data-action="edit" data-id="${institute.id}">
                                    <i data-lucide="edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }

            /**
             * ğŸ–±ï¸ í…Œì´ë¸” í´ë¦­ ì²˜ë¦¬
             */
            handleTableClick(event) {
                const button = event.target.closest('[data-action]');
                if (!button) return;

                const action = button.dataset.action;
                const instituteId = button.dataset.id;
                
                this.handleInstituteAction(action, instituteId);
            }

            /**
             * âš¡ í•™ë‹¹ ì•¡ì…˜ ì²˜ë¦¬
             */
            async handleInstituteAction(action, instituteId) {
                switch (action) {
                    case 'view':
                        await this.showInstituteDetails(instituteId);
                        break;
                    case 'edit':
                        await this.editInstitute(instituteId);
                        break;
                }
            }

            /**
             * ğŸ‘ï¸ í•™ë‹¹ ìƒì„¸ ì •ë³´ í‘œì‹œ
             */
            async showInstituteDetails(instituteId) {
                try {
                    this.showLoading(true);
                    
                    const institute = await window.InstituteCore.getInstituteDetails(instituteId);
                    if (!institute) {
                        this.showError('í•™ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    this.renderDetailModal(institute);
                    this.showModal('institute-detail-modal');
                    
                    // ìˆ˜ì • ë²„íŠ¼ ì´ë²¤íŠ¸
                    document.getElementById('edit-institute-btn').onclick = () => {
                        this.closeDetailModal();
                        this.editInstitute(instituteId);
                    };
                    
                    this.showLoading(false);
                    
                } catch (error) {
                    console.error('âŒ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showError('í•™ë‹¹ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    this.showLoading(false);
                }
            }

            /**
             * âœï¸ í•™ë‹¹ ì •ë³´ ìˆ˜ì •
             */
            async editInstitute(instituteId) {
                try {
                    this.currentInstitute = await window.InstituteCore.getInstituteDetails(instituteId);
                    if (!this.currentInstitute) {
                        this.showError('í•™ë‹¹ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }

                    this.populateEditForm(this.currentInstitute);
                    this.showModal('institute-edit-modal');
                    
                } catch (error) {
                    console.error('âŒ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° ì‹¤íŒ¨:', error);
                    this.showError('í•™ë‹¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }

            /**
             * ğŸ“ ìˆ˜ì • í¼ ë°ì´í„° ì±„ìš°ê¸° (v4.7.1 - ê°œì„ ëœ í•„ë“œ ë§¤í•‘)
             */
            populateEditForm(institute) {
                // í‘œì¤€ í•„ë“œ ë§¤í•‘ (ê°œì„ ë¨)
                const fieldMappings = {
                    'name_ko': 'edit-name-ko',
                    'name_en': 'edit-name-en', 
                    'operator': 'edit-operating-organization',
                    'address': 'edit-address',
                    'phone': 'edit-phone',
                    'sns_url': 'edit-website-sns',
                    'contact_person': 'edit-manager-name',
                    'contact_phone': 'edit-manager-contact',
                    'local_coordinator': 'edit-local-coordinator',
                    'local_coordinator_phone': 'edit-local-coordinator-contact', // ì¶”ê°€ë¨!
                    'lesson_plan': 'edit-cultural-program-plan',
                    'local_language_requirement': 'edit-local-language-requirement',
                    'support_provided': 'edit-institute-support',
                    'safety_info_url': 'edit-country-safety-info'
                };
                
                // í•„ë“œ ë°ì´í„° ì±„ìš°ê¸°
                for (const [dbField, elementId] of Object.entries(fieldMappings)) {
                    const element = document.getElementById(elementId);
                    if (element && institute[dbField]) {
                        element.value = institute[dbField];
                        console.log(`âœ… í•„ë“œ ë¡œë“œ: ${dbField} â†’ ${elementId} = "${institute[dbField]}"`);
                    }
                }

                // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°
                if (institute.image_url) {
                    const preview = document.getElementById('image-preview');
                    if (preview) {
                        preview.src = institute.image_url;
                        preview.style.display = 'block';
                    }
                    document.getElementById('edit-image-url').value = institute.image_url;
                }

                // ê°•ì¢Œ ë°ì´í„° ë¡œë“œ
                this.loadCoursesData(institute.desired_courses);

                // êµìœ¡ í™˜ê²½ ë°ì´í„° ë¡œë“œ
                this.loadEducationEnvironmentData(institute.education_environment);

                // ë‹´ë‹¹ìì™€ ë™ì¼ ì²´í¬ë°•ìŠ¤ ìƒíƒœ í™•ì¸ (ê°œì„ ë¨)
                this.checkCoordinatorSameAsManager();
                
                console.log('âœ… ìˆ˜ì • í¼ ë°ì´í„° ì±„ìš°ê¸° ì™„ë£Œ (v4.7.1 ê°œì„ )');
            }

            /**
             * ğŸ‘¥ ë‹´ë‹¹ìì™€ í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì •ë³´ê°€ ë™ì¼í•œì§€ í™•ì¸ (v4.7.1 ê°œì„ )
             */
            checkCoordinatorSameAsManager() {
                const managerName = document.getElementById('edit-manager-name')?.value || '';
                const managerContact = document.getElementById('edit-manager-contact')?.value || '';
                const coordinatorName = document.getElementById('edit-local-coordinator')?.value || '';
                const coordinatorContact = document.getElementById('edit-local-coordinator-contact')?.value || '';
                
                const checkbox = document.getElementById('coordinator-same-as-manager');
                if (checkbox && managerName && managerContact && 
                    managerName === coordinatorName && managerContact === coordinatorContact) {
                    checkbox.checked = true;
                    // í•„ë“œ ë¹„í™œì„±í™”
                    document.getElementById('edit-local-coordinator').disabled = true;
                    document.getElementById('edit-local-coordinator-contact').disabled = true;
                    console.log('âœ… "ë‹´ë‹¹ìì™€ ë™ì¼" ìƒíƒœë¡œ ì„¤ì •ë¨');
                }
            }

            /**
             * ğŸ’¾ í•™ë‹¹ ì •ë³´ ì €ì¥ (v4.7.1 - ìƒˆë¡œìš´ í•„ë“œ í¬í•¨)
             */
            async saveInstituteData() {
                if (!this.currentInstitute) return;

                try {
                    // ì „ì²´ í•„ë“œ ê²€ì¦
                    if (!this.validateAllFields()) {
                        this.showError('ì…ë ¥ ë°ì´í„°ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. ë¹¨ê°„ìƒ‰ìœ¼ë¡œ í‘œì‹œëœ í•„ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    this.showModalLoading(true, 'ì €ì¥ ì¤‘...');

                    const formData = new FormData(document.getElementById('institute-edit-form'));
                    const updateData = {};
                    
                    for (const [key, value] of formData.entries()) {
                        if (value.trim()) {
                            updateData[key] = value.trim();
                        }
                    }

                    // ì´ë¯¸ì§€ URL ì¶”ê°€
                    const imageUrl = document.getElementById('edit-image-url')?.value;
                    if (imageUrl) {
                        updateData.image_url = imageUrl;
                    }

                    // ê°•ì¢Œ ë°ì´í„° ì¶”ê°€
                    const coursesData = this.getCoursesJsonData();
                    if (coursesData) {
                        updateData.desired_courses = coursesData;
                    }

                    // êµìœ¡ í™˜ê²½ ë°ì´í„° ì¶”ê°€
                    const educationEnvironmentData = this.getEducationEnvironmentJsonData();
                    if (educationEnvironmentData) {
                        updateData.education_environment = educationEnvironmentData;
                    }

                    console.log('ğŸ’¾ ì €ì¥í•  ë°ì´í„°:', updateData);

                    // ë°ì´í„° ì—…ë°ì´íŠ¸
                    const success = await window.InstituteCore.updateInstituteInfo(this.currentInstitute.id, updateData);
                    
                    if (success) {
                        this.showSuccess('í•™ë‹¹ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        this.showModalLoading(false);
                        this.closeEditModal();
                        await this.refreshData();
                    } else {
                        throw new Error('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    }
                    
                } catch (error) {
                    console.error('âŒ ì €ì¥ ì‹¤íŒ¨:', error);
                    this.showError('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    this.showModalLoading(false);
                }
            }

            /**
             * â• ìƒˆ í•™ë‹¹ ìƒì„±
             */
            async createNewInstitute() {
                try {
                    const nameInput = document.getElementById('add-name-ko');
                    const name = nameInput?.value?.trim();
                    
                    if (!name) {
                        this.showError('í•™ë‹¹ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    this.showModalLoading(true, 'í•™ë‹¹ ìƒì„± ì¤‘...');

                    const instituteData = { name_ko: name };
                    const newInstitute = await window.InstituteAPI.createInstitute(instituteData);
                    
                    if (newInstitute) {
                        this.showSuccess(`ìƒˆ í•™ë‹¹ "${name}"ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        this.closeAddModal();
                        await this.refreshData();
                        
                        // ìƒì„±ëœ í•™ë‹¹ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
                        setTimeout(() => {
                            this.editInstitute(newInstitute.id);
                        }, 500);
                    } else {
                        throw new Error('í•™ë‹¹ ìƒì„± ì‹¤íŒ¨');
                    }
                    
                } catch (error) {
                    console.error('âŒ í•™ë‹¹ ìƒì„± ì‹¤íŒ¨:', error);
                    this.showError('í•™ë‹¹ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                } finally {
                    this.showModalLoading(false);
                }
            }

            /**
             * ğŸ” ê²€ìƒ‰ ì²˜ë¦¬ (ê°„ì†Œí™”)
             */
            async handleSearch() {
                const keyword = document.getElementById('institute-search')?.value?.trim();
                
                try {
                    this.showLoading(true);
                    let results;
                    
                    if (!keyword) {
                        results = await this.loadInstituteListSimplified();
                    } else {
                        // ê°„ë‹¨í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§
                        const allInstitutes = await this.loadInstituteListSimplified();
                        results = allInstitutes.filter(institute => 
                            institute.name_ko.toLowerCase().includes(keyword.toLowerCase()) ||
                            (institute.contact_person && institute.contact_person.toLowerCase().includes(keyword.toLowerCase()))
                        );
                    }
                    
                    this.renderListView(results);
                    this.updateStatistics(results);
                    this.showLoading(false);
                    
                } catch (error) {
                    console.error('âŒ ê²€ìƒ‰ ì‹¤íŒ¨:', error);
                    this.showError('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    this.showLoading(false);
                }
            }

            /**
             * ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
             */
            async refreshData() {
                console.log('ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨...');
                
                try {
                    this.showLoading(true);
                    
                    if (window.InstituteCore && window.InstituteCore.clearCache) {
                        window.InstituteCore.clearCache();
                    }
                    
                    await this.loadInitialData();
                    this.showSuccess('ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                } catch (error) {
                    console.error('âŒ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
                    this.showError('ë°ì´í„° ìƒˆë¡œê³ ì¹¨ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    this.showLoading(false);
                }
            }

            // === êµìœ¡ í™˜ê²½ í…Œì´ë¸” ì‹œìŠ¤í…œ ===
            initializeEducationEnvironmentTableSystem() {
                const addBtn = document.getElementById('add-education-environment-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', this.addEducationEnvironmentRow.bind(this));
                }

                this.addEducationEnvironmentRow();
                console.log('âœ… êµìœ¡ í™˜ê²½ í…Œì´ë¸” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
            }

            addEducationEnvironmentRow() {
                const tableBody = document.getElementById('education-environment-table-body');
                if (!tableBody) return;

                const rowIndex = this.educationEnvironmentData.length;
                if (rowIndex >= 10) {
                    this.showError('ìµœëŒ€ 10ê°œì˜ êµìœ¡ í™˜ê²½ ì •ë³´ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const environmentData = { topic: '', location: '', equipment: '' };
                this.educationEnvironmentData.push(environmentData);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" placeholder="ê°•ì˜ ì£¼ì œ" value="${environmentData.topic}" 
                               oninput="InstituteManager.updateEducationEnvironmentData(${rowIndex}, 'topic', this.value)">
                    </td>
                    <td>
                        <input type="text" placeholder="êµìœ¡ ì¥ì†Œ" value="${environmentData.location}" 
                               oninput="InstituteManager.updateEducationEnvironmentData(${rowIndex}, 'location', this.value)">
                    </td>
                    <td>
                        <input type="text" placeholder="í•™ë‹¹ êµêµ¬ ë° ê¸°ìì¬" value="${environmentData.equipment}" 
                               oninput="InstituteManager.updateEducationEnvironmentData(${rowIndex}, 'equipment', this.value)">
                    </td>
                    <td>
                        <button type="button" class="institute-table-remove-btn" onclick="InstituteManager.removeEducationEnvironmentRow(${rowIndex})">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                this.updateEducationEnvironmentHiddenInput();
            }

            updateEducationEnvironmentData(index, field, value) {
                if (this.educationEnvironmentData[index]) {
                    this.educationEnvironmentData[index][field] = value;
                    this.updateEducationEnvironmentHiddenInput();
                }
            }

            removeEducationEnvironmentRow(index) {
                this.educationEnvironmentData.splice(index, 1);
                this.renderEducationEnvironmentTable();
                this.updateEducationEnvironmentHiddenInput();
            }

            renderEducationEnvironmentTable() {
                const tableBody = document.getElementById('education-environment-table-body');
                if (!tableBody) return;

                tableBody.innerHTML = '';
                this.educationEnvironmentData.forEach((environment, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="text" placeholder="ê°•ì˜ ì£¼ì œ" value="${environment.topic}" 
                                   oninput="InstituteManager.updateEducationEnvironmentData(${index}, 'topic', this.value)">
                        </td>
                        <td>
                            <input type="text" placeholder="êµìœ¡ ì¥ì†Œ" value="${environment.location}" 
                                   oninput="InstituteManager.updateEducationEnvironmentData(${index}, 'location', this.value)">
                        </td>
                        <td>
                            <input type="text" placeholder="í•™ë‹¹ êµêµ¬ ë° ê¸°ìì¬" value="${environment.equipment}" 
                                   oninput="InstituteManager.updateEducationEnvironmentData(${index}, 'equipment', this.value)">
                        </td>
                        <td>
                            <button type="button" class="institute-table-remove-btn" onclick="InstituteManager.removeEducationEnvironmentRow(${index})">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            updateEducationEnvironmentHiddenInput() {
                const hiddenInput = document.getElementById('edit-education-environment');
                if (hiddenInput) {
                    const validEnvironments = this.educationEnvironmentData.filter(env => 
                        env.topic.trim() || env.location.trim() || env.equipment.trim()
                    );
                    hiddenInput.value = JSON.stringify(validEnvironments);
                }
            }

            loadEducationEnvironmentData(environmentJson) {
                this.educationEnvironmentData = [];
                
                if (environmentJson) {
                    try {
                        const environments = JSON.parse(environmentJson);
                        if (Array.isArray(environments)) {
                            this.educationEnvironmentData = environments;
                        }
                    } catch (error) {
                        console.warn('êµìœ¡ í™˜ê²½ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
                    }
                }

                if (this.educationEnvironmentData.length === 0) {
                    this.educationEnvironmentData.push({ topic: '', location: '', equipment: '' });
                }

                this.renderEducationEnvironmentTable();
                this.updateEducationEnvironmentHiddenInput();
            }

            getEducationEnvironmentJsonData() {
                const validEnvironments = this.educationEnvironmentData.filter(env => 
                    env.topic.trim() || env.location.trim() || env.equipment.trim()
                );
                return validEnvironments.length > 0 ? JSON.stringify(validEnvironments) : null;
            }

            // === ì‹¤ì‹œê°„ ê²€ì¦ ì‹œìŠ¤í…œ ===
            initializeRealTimeValidation() {
                const form = document.getElementById('institute-edit-form');
                if (!form) return;

                const inputFields = form.querySelectorAll('input, textarea');
                inputFields.forEach(field => {
                    field.addEventListener('input', this.debounce((e) => {
                        this.validateField(e.target);
                    }, 300));

                    field.addEventListener('blur', (e) => {
                        this.validateField(e.target);
                    });
                });
            }

            validateField(field) {
                const fieldName = field.name || field.id.replace('edit-', '');
                const value = field.value.trim();
                const errorElement = document.getElementById(`error-${fieldName.replace(/_/g, '-')}`);
                
                if (!errorElement) return;

                let isValid = true;
                let errorMessage = '';

                // í•„ìˆ˜ í•„ë“œ ê²€ì¦
                if (field.hasAttribute('required') && !value) {
                    isValid = false;
                    errorMessage = 'ì´ í•„ë“œëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.';
                }

                // íŠ¹ì • í•„ë“œë³„ ê²€ì¦
                switch (fieldName) {
                    case 'name_ko':
                        if (value && value.length < 2) {
                            isValid = false;
                            errorMessage = 'í•™ë‹¹ëª…ì€ ìµœì†Œ 2ê¸€ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                        }
                        break;
                    
                    case 'phone':
                    case 'contact_phone':
                    case 'local_coordinator_phone':
                        if (value && !/^[\d\s\-\+\(\)]+$/.test(value)) {
                            isValid = false;
                            errorMessage = 'ì˜¬ë°”ë¥¸ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.';
                        }
                        break;
                    
                    case 'sns_url':
                    case 'safety_info_url':
                        if (value && !this.isValidURL(value)) {
                            isValid = false;
                            errorMessage = 'ì˜¬ë°”ë¥¸ URL í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. (http:// ë˜ëŠ” https://ë¡œ ì‹œì‘)';
                        }
                        break;
                }

                // UI ì—…ë°ì´íŠ¸
                this.updateFieldValidationUI(field, errorElement, isValid, errorMessage);
                this.validationState[fieldName] = isValid;
            }

            updateFieldValidationUI(field, errorElement, isValid, errorMessage) {
                field.classList.remove('error', 'success');
                
                if (isValid) {
                    if (field.value.trim()) {
                        field.classList.add('success');
                    }
                    errorElement.style.display = 'none';
                } else {
                    field.classList.add('error');
                    errorElement.innerHTML = `<i data-lucide="alert-circle"></i> ${errorMessage}`;
                    errorElement.style.display = 'flex';
                    
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            }

            validateAllFields() {
                const form = document.getElementById('institute-edit-form');
                const inputFields = form.querySelectorAll('input, textarea');
                
                let isAllValid = true;
                inputFields.forEach(field => {
                    this.validateField(field);
                    const fieldName = field.name || field.id.replace('edit-', '');
                    if (this.validationState[fieldName] === false) {
                        isAllValid = false;
                    }
                });

                return isAllValid;
            }

            // === ê°•ì¢Œ í…Œì´ë¸” ì‹œìŠ¤í…œ ===
            initializeCourseTableSystem() {
                const addBtn = document.getElementById('add-course-btn');
                if (addBtn) {
                    addBtn.addEventListener('click', this.addCourseRow.bind(this));
                }

                this.addCourseRow();
            }

            addCourseRow() {
                const tableBody = document.getElementById('courses-table-body');
                if (!tableBody) return;

                const rowIndex = this.coursesData.length;
                if (rowIndex >= 10) {
                    this.showError('ìµœëŒ€ 10ê°œì˜ ê°•ì¢Œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                const courseData = { name: '', level: '', time: '', participants: '' };
                this.coursesData.push(courseData);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <input type="text" placeholder="ê°•ì¢Œëª…" value="${courseData.name}" 
                               oninput="InstituteManager.updateCourseData(${rowIndex}, 'name', this.value)">
                    </td>
                    <td>
                        <input type="text" placeholder="ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰" value="${courseData.level}" 
                               oninput="InstituteManager.updateCourseData(${rowIndex}, 'level', this.value)">
                    </td>
                    <td>
                        <input type="text" placeholder="ì£¼ 2íšŒ 90ë¶„" value="${courseData.time}" 
                               oninput="InstituteManager.updateCourseData(${rowIndex}, 'time', this.value)">
                    </td>
                    <td>
                        <input type="number" placeholder="15" min="1" max="50" value="${courseData.participants}" 
                               oninput="InstituteManager.updateCourseData(${rowIndex}, 'participants', this.value)">
                    </td>
                    <td>
                        <button type="button" class="institute-table-remove-btn" onclick="InstituteManager.removeCourseRow(${rowIndex})">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                this.updateCoursesHiddenInput();
            }

            updateCourseData(index, field, value) {
                if (this.coursesData[index]) {
                    this.coursesData[index][field] = value;
                    this.updateCoursesHiddenInput();
                }
            }

            removeCourseRow(index) {
                this.coursesData.splice(index, 1);
                this.renderCourseTable();
                this.updateCoursesHiddenInput();
            }

            renderCourseTable() {
                const tableBody = document.getElementById('courses-table-body');
                if (!tableBody) return;

                tableBody.innerHTML = '';
                this.coursesData.forEach((course, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <input type="text" placeholder="ê°•ì¢Œëª…" value="${course.name}" 
                                   oninput="InstituteManager.updateCourseData(${index}, 'name', this.value)">
                        </td>
                        <td>
                            <input type="text" placeholder="ì´ˆê¸‰/ì¤‘ê¸‰/ê³ ê¸‰" value="${course.level}" 
                                   oninput="InstituteManager.updateCourseData(${index}, 'level', this.value)">
                        </td>
                        <td>
                            <input type="text" placeholder="ì£¼ 2íšŒ 90ë¶„" value="${course.time}" 
                                   oninput="InstituteManager.updateCourseData(${index}, 'time', this.value)">
                        </td>
                        <td>
                            <input type="number" placeholder="15" min="1" max="50" value="${course.participants}" 
                                   oninput="InstituteManager.updateCourseData(${index}, 'participants', this.value)">
                        </td>
                        <td>
                            <button type="button" class="institute-table-remove-btn" onclick="InstituteManager.removeCourseRow(${index})">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            updateCoursesHiddenInput() {
                const hiddenInput = document.getElementById('edit-desired-courses');
                if (hiddenInput) {
                    const validCourses = this.coursesData.filter(course => 
                        course.name.trim() || course.level.trim() || course.time.trim() || course.participants.trim()
                    );
                    hiddenInput.value = JSON.stringify(validCourses);
                }
            }

            loadCoursesData(coursesJson) {
                this.coursesData = [];
                
                if (coursesJson) {
                    try {
                        const courses = JSON.parse(coursesJson);
                        if (Array.isArray(courses)) {
                            this.coursesData = courses;
                        }
                    } catch (error) {
                        console.warn('ê°•ì¢Œ ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨:', error);
                    }
                }

                if (this.coursesData.length === 0) {
                    this.coursesData.push({ name: '', level: '', time: '', participants: '' });
                }

                this.renderCourseTable();
                this.updateCoursesHiddenInput();
            }

            getCoursesJsonData() {
                const validCourses = this.coursesData.filter(course => 
                    course.name.trim() || course.level.trim() || course.time.trim() || course.participants.trim()
                );
                return validCourses.length > 0 ? JSON.stringify(validCourses) : null;
            }

            // === ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹œìŠ¤í…œ ===
            setupImageUpload() {
                const uploadArea = document.getElementById('image-upload-area');
                const fileInput = document.getElementById('image-file-input');
                const preview = document.getElementById('image-preview');
                const hiddenInput = document.getElementById('edit-image-url');

                if (!uploadArea || !fileInput) return;

                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', this.handleImageSelect.bind(this));

                // ë“œë˜ê·¸ ì•¤ ë“œë¡­
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.handleImageFile(files[0]);
                    }
                });
            }

            async handleImageSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    await this.handleImageFile(file);
                }
            }

            async handleImageFile(file) {
                if (!this.currentInstitute) return;

                try {
                    if (!file.type.startsWith('image/')) {
                        throw new Error('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    }

                    if (file.size > 5 * 1024 * 1024) {
                        throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 5MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                    }

                    this.showModalLoading(true, 'ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...');

                    const imageUrl = await window.InstituteAPI.uploadInstituteImage(file, this.currentInstitute.id);
                    
                    if (imageUrl) {
                        const preview = document.getElementById('image-preview');
                        const hiddenInput = document.getElementById('edit-image-url');
                        
                        preview.src = imageUrl;
                        preview.style.display = 'block';
                        hiddenInput.value = imageUrl;
                        
                        this.showSuccess('ì´ë¯¸ì§€ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        throw new Error('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    this.showModalLoading(false);

                } catch (error) {
                    console.error('âŒ ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                    this.showError(error.message);
                    this.showModalLoading(false);
                }
            }

            // === ëª¨ë‹¬ ê´€ë¦¬ ===
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    modal.classList.add('institute-fade-in');
                }
            }

            closeDetailModal() {
                document.getElementById('institute-detail-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            closeEditModal() {
                document.getElementById('institute-edit-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
                this.currentInstitute = null;
                this.validationState = {};
                this.coursesData = [];
                this.educationEnvironmentData = [];
            }

            showAddModal() {
                document.getElementById('add-name-ko').value = '';
                this.showModal('institute-add-modal');
            }

            closeAddModal() {
                document.getElementById('institute-add-modal').style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            closeAllModals() {
                this.closeDetailModal();
                this.closeEditModal();
                this.closeAddModal();
            }

            showModalLoading(show, message = 'ì²˜ë¦¬ ì¤‘...') {
                const loading = document.getElementById('modal-loading');
                const loadingText = document.querySelector('.institute-modal-loading-text');
                
                if (loading) {
                    loading.style.display = show ? 'flex' : 'none';
                    if (loadingText && message) {
                        loadingText.textContent = message;
                    }
                }
            }

            // === ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ë Œë”ë§ (v4.7.1) ===
            renderDetailModal(institute) {
                const content = document.getElementById('institute-detail-content');
                if (!content) return;

                let modalHTML = '';

                // í•™ë‹¹ ì´ë¯¸ì§€
                if (institute.image_url) {
                    modalHTML += `
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <img src="${institute.image_url}" alt="${institute.name_ko}" 
                                 style="max-width: 100%; max-height: 300px; border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        </div>
                    `;
                }

                // ê¸°ë³¸ ì •ë³´
                modalHTML += `
                    <div class="institute-field-group" style="margin-bottom: 2rem;">
                        <h3 class="institute-field-group-title">
                            <i data-lucide="info"></i>
                            ê¸°ë³¸ ì •ë³´
                        </h3>
                        ${this.renderDetailField('í•™ë‹¹ëª…', institute.name_ko)}
                        ${this.renderDetailField('ì˜ë¬¸ëª…', institute.name_en)}
                        ${this.renderDetailField('ìš´ì˜ê¸°ê´€', institute.operator)}
                    </div>
                `;

                // ì—°ë½ì²˜ ì •ë³´
                modalHTML += `
                    <div class="institute-field-group" style="margin-bottom: 2rem;">
                        <h3 class="institute-field-group-title">
                            <i data-lucide="phone"></i>
                            ì—°ë½ì²˜ ì •ë³´
                        </h3>
                        ${this.renderDetailField('ì£¼ì†Œ', institute.address)}
                        ${this.renderDetailField('ëŒ€í‘œì—°ë½ì²˜', institute.phone)}
                        ${this.renderDetailField('í™ˆí˜ì´ì§€/SNS', institute.sns_url, 'link')}
                        ${this.renderDetailField('ë‹´ë‹¹ìì„±ëª…', institute.contact_person)}
                        ${this.renderDetailField('ë‹´ë‹¹ìì—°ë½ì²˜', institute.contact_phone)}
                        ${this.renderDetailField('í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥', institute.local_coordinator)}
                        ${this.renderDetailField('í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì—°ë½ì²˜', institute.local_coordinator_phone)}
                    </div>
                `;

                // í”„ë¡œê·¸ë¨ ì •ë³´
                if (institute.lesson_plan || institute.desired_courses || institute.education_environment) {
                    modalHTML += `
                        <div class="institute-field-group" style="margin-bottom: 2rem;">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="graduation-cap"></i>
                                í”„ë¡œê·¸ë¨ ì •ë³´
                            </h3>
                            ${this.renderDetailField('ë¬¸í™”ìˆ˜ì—…ìš´ì˜ê³„íš', institute.lesson_plan, 'textarea')}
                            ${this.renderDetailField('í¬ë§ê°œì„¤ê°•ì¢Œ', institute.desired_courses, 'textarea')}
                            ${this.renderDetailField('êµìœ¡í™˜ê²½ì •ë³´', institute.education_environment, 'json')}
                        </div>
                    `;
                }

                // ì§€ì› ì •ë³´
                if (institute.local_language_requirement || institute.support_provided || institute.safety_info_url) {
                    modalHTML += `
                        <div class="institute-field-group">
                            <h3 class="institute-field-group-title">
                                <i data-lucide="help-circle"></i>
                                ì§€ì› ì •ë³´
                            </h3>
                            ${this.renderDetailField('í˜„ì§€ì–´êµ¬ì‚¬í•„ìš”ìˆ˜ì¤€', institute.local_language_requirement, 'textarea')}
                            ${this.renderDetailField('í•™ë‹¹ì§€ì›ì‚¬í•­', institute.support_provided, 'textarea')}
                            ${this.renderDetailField('íŒŒê²¬êµ­ê°€ì•ˆì „ì •ë³´', institute.safety_info_url, 'link')}
                        </div>
                    `;
                }

                content.innerHTML = modalHTML;

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            renderDetailField(label, value, type = 'text') {
                if (!value) return '';
                
                let displayValue = value;
                
                if (type === 'link' && value.startsWith('http')) {
                    displayValue = `<a href="${value}" target="_blank" rel="noopener">${value}</a>`;
                } else if (type === 'textarea') {
                    displayValue = value.replace(/\n/g, '<br>');
                } else if (type === 'json') {
                    try {
                        const parsed = JSON.parse(value);
                        if (Array.isArray(parsed)) {
                            displayValue = parsed.map(item => 
                                `â€¢ ${Object.values(item).filter(v => v).join(' / ')}`
                            ).join('<br>');
                        }
                    } catch (e) {
                        displayValue = value;
                    }
                }
                
                return `
                    <div class="institute-info-row" style="margin-bottom: 1rem;">
                        <div class="institute-info-content">
                            <div class="institute-info-label">${label}</div>
                            <div class="institute-info-value" style="white-space: pre-wrap; line-height: 1.6;">
                                ${displayValue}
                            </div>
                        </div>
                    </div>
                `;
            }

            // === UI ìƒíƒœ ê´€ë¦¬ ===
            showLoading(show) {
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = show ? 'flex' : 'none';
                }
            }

            showEmptyState() {
                document.getElementById('institute-list').style.display = 'none';
                document.getElementById('empty-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
            }

            showErrorState(message) {
                const errorMessage = document.getElementById('error-message');
                if (errorMessage) {
                    errorMessage.textContent = message;
                }
                
                document.getElementById('institute-list').style.display = 'none';
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
            }

            hideEmptyAndError() {
                document.getElementById('empty-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'none';
            }

            // === í†µê³„ ì—…ë°ì´íŠ¸ ===
            updateStatistics(institutes) {
                let assignedInterns = 0;
                let completeInstitutes = 0;
                let incompleteInstitutes = 0;

                institutes.forEach(institute => {
                    const status = this.getCompletionStatus(institute);
                    if (status.class === 'complete') {
                        completeInstitutes++;
                    } else {
                        incompleteInstitutes++;
                    }
                });

                document.getElementById('total-institutes').textContent = institutes.length;
                document.getElementById('assigned-interns').textContent = assignedInterns;
                document.getElementById('complete-institutes').textContent = completeInstitutes;
                document.getElementById('incomplete-institutes').textContent = incompleteInstitutes;
            }

            getCompletionStatus(institute) {
                const requiredFields = ['name_ko', 'contact_person'];
                const completedFields = requiredFields.filter(field => 
                    institute[field] && institute[field].toString().trim() !== ''
                );
                
                const completion = completedFields.length / requiredFields.length;
                
                if (completion >= 0.8) {
                    return { class: 'complete', label: 'ì™„ë£Œ' };
                } else if (completion >= 0.5) {
                    return { class: 'pending', label: 'ì§„í–‰ì¤‘' };
                } else {
                    return { class: 'incomplete', label: 'ë¯¸ì™„ì„±' };
                }
            }

            // === ë©”ì‹œì§€ í‘œì‹œ ===
            showError(message) {
                if (window.Utils && window.Utils.showToast) {
                    window.Utils.showToast(message, 'error');
                } else {
                    alert('ì˜¤ë¥˜: ' + message);
                }
            }

            showSuccess(message) {
                if (window.Utils && window.Utils.showToast) {
                    window.Utils.showToast(message, 'success');
                } else {
                    console.log('âœ… ' + message);
                }
            }

            showInfo(message) {
                if (window.Utils && window.Utils.showToast) {
                    window.Utils.showToast(message, 'info');
                } else {
                    console.log('â„¹ï¸ ' + message);
                }
            }

            // === ìœ í‹¸ë¦¬í‹° ===
            truncateText(text, maxLength) {
                if (!text || text.length <= maxLength) return text;
                return text.substring(0, maxLength) + '...';
            }

            formatDate(dateString) {
                if (!dateString) return 'ì •ë³´ ì—†ìŒ';
                
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ko-KR');
                } catch {
                    return 'ì •ë³´ ì—†ìŒ';
                }
            }

            isValidURL(string) {
                try {
                    const url = new URL(string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch {
                    return false;
                }
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // === ì „ì—­ í•¨ìˆ˜ë“¤ ===
        function goBackToDashboard() {
            console.log('ğŸ”™ ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°');
            window.location.href = '../admin.html';
        }

        function clearSearch() {
            const searchInput = document.getElementById('institute-search');
            if (searchInput) {
                searchInput.value = '';
                InstituteManager.handleSearch();
            }
        }

        function retryDataLoad() {
            InstituteManager.retryCount++;
            if (InstituteManager.retryCount <= InstituteManager.maxRetries) {
                InstituteManager.loadInitialData();
            } else {
                InstituteManager.showError('ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        // === ì „ì—­ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤ ===
        const InstituteManager = new InstituteManagerD();

        // === DOMContentLoaded ì´ë²¤íŠ¸ ===
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ›ï¸ íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ v4.7.1 ì‹œì‘ - UI ê°œì„  ì™„ë£Œ');
            
            try {
                await InstituteManager.initialize();
                console.log('ğŸ‰ v4.7.1 ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ! UI ê°œì„ ìœ¼ë¡œ ë”ìš± ì§ê´€ì ì¸ ì‚¬ìš©ì ê²½í—˜ ì œê³µ.');
                
            } catch (error) {
                console.error('ğŸ’¥ v4.7.1 ì´ˆê¸°í™” ìµœì¢… ì‹¤íŒ¨:', error);
                alert('ì‹œìŠ¤í…œ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê±°ë‚˜ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
            }
        });

        // === ê°œë°œì ë””ë²„ê·¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ===
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                e.preventDefault();
                console.log('ğŸ› ï¸ v4.7.1 ë””ë²„ê·¸ ì •ë³´');
                console.log('í†µí•© ë§¤ë‹ˆì € ìƒíƒœ:', {
                    initialized: InstituteManager.isInitialized,
                    currentView: InstituteManager.currentView,
                    currentInstitute: InstituteManager.currentInstitute,
                    validationState: InstituteManager.validationState,
                    coursesData: InstituteManager.coursesData,
                    educationEnvironmentData: InstituteManager.educationEnvironmentData,
                    retryCount: InstituteManager.retryCount
                });
                
                console.log('ëª¨ë“ˆ ìƒíƒœ:', {
                    InstituteUtils: window.InstituteUtils?.getUtilsStatus?.(),
                    InstituteValidation: window.InstituteValidation?.getValidationStatus?.(),
                    InstituteAPI: window.InstituteAPI?.getAPIStatus?.(),
                    InstituteCore: window.InstituteCore?.getModuleStatus?.()
                });
            }
        });

        console.log('ğŸ›ï¸ íŒŒê²¬í•™ë‹¹ ì •ë³´ ê´€ë¦¬ ì‹œìŠ¤í…œ v4.7.1 ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ - UI ê°œì„  ì™„ë£Œ');
    </script>
</body>
</html>