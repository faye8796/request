<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“Š ì‚¬ì—… ë§Œì¡±ë„ ì¡°ì‚¬ ê´€ë¦¬ - ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ“Š%3C/text%3E%3C/svg%3E">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: #5855eb;
            transform: translateY(-2px);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #047857;
            transform: translateY(-2px);
        }

        /* Tab Navigation */
        .tab-navigation {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: transparent;
            color: #6b7280;
        }

        .tab-button:hover {
            background: #f3f4f6;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);
        }

        .tab-button .tab-icon {
            font-size: 20px;
        }

        /* Statistics */
        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .stat-icon {
            font-size: 32px;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
            font-size: 13px;
        }

        .stat-card.total .stat-icon { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .stat-card.submitted .stat-icon { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card.draft .stat-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.none .stat-icon { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.rate .stat-icon { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); }
        .stat-card.average .stat-icon { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== ì „ì²´ ê²°ê³¼ íƒ­ ìŠ¤íƒ€ì¼ ===== */
        .overall-stats-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .stats-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-stats-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .question-stats-card:last-child {
            margin-bottom: 0;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .question-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }

        .question-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .positive-rate-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .question-content {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .question-content {
                grid-template-columns: 1fr;
            }
        }

        /* Stats Table */
        .stats-table {
            width: 100%;
            border-collapse: collapse;
        }

        .stats-table th,
        .stats-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .stats-table th:first-child {
            border-radius: 8px 0 0 0;
        }

        .stats-table th:last-child {
            border-radius: 0 8px 0 0;
        }

        .stats-table td {
            font-size: 14px;
            color: #374151;
        }

        .stats-table tr:last-child td {
            border-bottom: none;
            font-weight: 700;
            background: #f3f4f6;
        }

        .stats-table tr:last-child td:first-child {
            border-radius: 0 0 0 8px;
        }

        .stats-table tr:last-child td:last-child {
            border-radius: 0 0 8px 0;
        }

        .stats-table td:nth-child(2),
        .stats-table td:nth-child(3),
        .stats-table th:nth-child(2),
        .stats-table th:nth-child(3) {
            text-align: center;
        }

        /* Donut Chart */
        .donut-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .donut-chart {
            position: relative;
            width: 140px;
            height: 140px;
        }

        .donut-chart svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }

        .donut-chart circle {
            fill: none;
            stroke-width: 20;
        }

        .donut-chart .bg {
            stroke: #e5e7eb;
        }

        .donut-chart .progress {
            stroke: #4a8f3c;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.8s ease;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .donut-total {
            font-size: 12px;
            color: #6b7280;
        }

        .donut-number {
            font-size: 20px;
            font-weight: 700;
            color: #4a8f3c;
        }

        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-color.positive {
            background: #4a8f3c;
        }

        .legend-color.negative {
            background: #e5e7eb;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .summary-card .label {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
        }

        .summary-card .sub-value {
            font-size: 14px;
            color: #10b981;
            margin-top: 4px;
        }

        /* ===== í•™ìƒë³„ ê²°ê³¼ íƒ­ ìŠ¤íƒ€ì¼ ===== */
        .filter-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .filter-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 180px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .filter-input, .filter-select {
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #6366f1;
        }

        .clear-filters-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            height: 42px;
        }

        .clear-filters-btn:hover {
            background: #dc2626;
        }

        /* Table Container */
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-x: auto;
            margin-bottom: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .data-table th,
        .data-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }

        .data-table tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.submitted {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.draft {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.none {
            background: #fee2e2;
            color: #991b1b;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 14px;
        }

        .score-badge.excellent { background: #d1fae5; color: #065f46; }
        .score-badge.good { background: #dbeafe; color: #1e40af; }
        .score-badge.average { background: #fef3c7; color: #92400e; }
        .score-badge.low { background: #fee2e2; color: #991b1b; }

        .btn-view {
            background: #6366f1;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .btn-view:hover {
            background: #5855eb;
            transform: translateY(-1px);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 20px;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
        }

        .modal-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin-top: 4px;
        }

        .modal-close {
            background: #f3f4f6;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .modal-body {
            padding: 24px;
        }

        .response-section {
            margin-bottom: 28px;
        }

        .response-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .response-item {
            margin-bottom: 16px;
            padding: 14px;
            background: #f9fafb;
            border-radius: 10px;
        }

        .response-question {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .response-answer-likert {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .likert-score {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            min-width: 50px;
        }

        .likert-bar-container {
            flex: 1;
            height: 12px;
            background: #e5e7eb;
            border-radius: 6px;
            overflow: hidden;
        }

        .likert-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 6px;
            transition: width 0.6s ease;
        }

        .likert-label {
            font-size: 13px;
            color: #6b7280;
            min-width: 80px;
            text-align: right;
        }

        .response-answer-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.7;
            white-space: pre-wrap;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .no-answer {
            color: #9ca3af;
            font-style: italic;
        }

        /* Loading */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e5e7eb;
            border-top: 5px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 24px;
            right: 24px;
            background: #1f2937;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-left {
                flex-direction: column;
                align-items: stretch;
            }

            .header-title h1 {
                font-size: 20px;
            }

            .statistics {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-group {
                min-width: 100%;
            }

            .tab-button {
                padding: 12px 16px;
                font-size: 14px;
            }

            .tab-button .tab-icon {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="../admin.html" class="back-button">
                    <span>â†</span>
                    ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ
                </a>
                <div class="header-title">
                    <span>ğŸ“Š</span>
                    <h1>ì‚¬ì—… ë§Œì¡±ë„ ì¡°ì‚¬ ê´€ë¦¬</h1>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-success" id="exportExcelBtn">
                    <span>ğŸ“¥</span>
                    ì „ì²´ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                </button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="overall">
                <span class="tab-icon">ğŸ“ˆ</span>
                ì „ì²´ ê²°ê³¼
            </button>
            <button class="tab-button" data-tab="individual">
                <span class="tab-icon">ğŸ‘¤</span>
                í•™ìƒë³„ ê²°ê³¼
            </button>
        </div>

        <!-- Statistics -->
        <div class="statistics">
            <div class="stat-card total">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-number" id="statTotal">0</div>
                    <div class="stat-label">ì „ì²´ ëŒ€ìƒì</div>
                </div>
            </div>
            <div class="stat-card submitted">
                <div class="stat-icon">âœ…</div>
                <div class="stat-content">
                    <div class="stat-number" id="statSubmitted">0</div>
                    <div class="stat-label">ì œì¶œ ì™„ë£Œ</div>
                </div>
            </div>
            <div class="stat-card draft">
                <div class="stat-icon">â³</div>
                <div class="stat-content">
                    <div class="stat-number" id="statDraft">0</div>
                    <div class="stat-label">ì„ì‹œ ì €ì¥</div>
                </div>
            </div>
            <div class="stat-card none">
                <div class="stat-icon">âŒ</div>
                <div class="stat-content">
                    <div class="stat-number" id="statNone">0</div>
                    <div class="stat-label">ë¯¸ì‘ë‹µ</div>
                </div>
            </div>
            <div class="stat-card rate">
                <div class="stat-icon">ğŸ“ˆ</div>
                <div class="stat-content">
                    <div class="stat-number" id="statRate">0%</div>
                    <div class="stat-label">ì œì¶œë¥ </div>
                </div>
            </div>
            <div class="stat-card average">
                <div class="stat-icon">â­</div>
                <div class="stat-content">
                    <div class="stat-number" id="statAverage">0.0</div>
                    <div class="stat-label">í‰ê·  ë§Œì¡±ë„</div>
                </div>
            </div>
        </div>

        <!-- Tab Content: ì „ì²´ ê²°ê³¼ -->
        <div class="tab-content active" id="overallTab">
            <!-- Loading State -->
            <div class="loading-container" id="overallLoadingContainer">
                <div class="loading-spinner"></div>
            </div>

            <!-- Overall Stats Container -->
            <div class="overall-stats-container" id="overallStatsContainer" style="display: none;">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Tab Content: í•™ìƒë³„ ê²°ê³¼ -->
        <div class="tab-content" id="individualTab">
            <!-- Filter Controls -->
            <div class="filter-controls">
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="searchInput">ì´ë¦„ ê²€ìƒ‰</label>
                        <input type="text" id="searchInput" class="filter-input" placeholder="í•™ìƒ ì´ë¦„ ê²€ìƒ‰">
                    </div>
                    <div class="filter-group">
                        <label for="instituteFilter">íŒŒê²¬ í•™ë‹¹</label>
                        <select id="instituteFilter" class="filter-select">
                            <option value="">ì „ì²´ í•™ë‹¹</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="statusFilter">ìƒíƒœ</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="">ì „ì²´</option>
                            <option value="submitted">ì œì¶œ ì™„ë£Œ</option>
                            <option value="draft">ì„ì‹œ ì €ì¥</option>
                            <option value="none">ë¯¸ì‘ë‹µ</option>
                        </select>
                    </div>
                    <button class="clear-filters-btn" id="clearFiltersBtn">
                        âœ– ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading-container" id="loadingContainer">
                <div class="loading-spinner"></div>
            </div>

            <!-- Table Container -->
            <div class="table-container" id="tableContainer" style="display: none;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ì´ë¦„</th>
                            <th>íŒŒê²¬ í•™ë‹¹</th>
                            <th>ìƒíƒœ</th>
                            <th>ì œì¶œì¼</th>
                            <th>í‰ê·  ì ìˆ˜</th>
                            <th>ì•¡ì…˜</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="empty-state-icon">ğŸ“­</div>
                <h3>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <div class="modal-title" id="modalTitle">ì‘ë‹µ ìƒì„¸</div>
                    <div class="modal-subtitle" id="modalSubtitle"></div>
                </div>
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Main Script -->
    <script type="module">
        // ğŸ” ê´€ë¦¬ì ì¸ì¦ ì²´í¬
        function checkAdminAuth() {
            const adminSession = localStorage.getItem('adminSession');
            if (!adminSession || adminSession !== 'true') {
                alert('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '../admin.html';
                return false;
            }
            return true;
        }

        // Supabase ì„¤ì •
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.0';
        
        const supabaseUrl = 'https://aazvopacnbbkvusihqva.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFhenZvcGFjbmJia3Z1c2locXZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3OTQyMjQsImV4cCI6MjA2NTM3MDIyNH0.0NXI_tohwFCOl3xY4b1jIlxQR_zGTS9tWDM2OFxTq4s';
        const supabase = createClient(supabaseUrl, supabaseAnonKey);

        // ì§ˆë¬¸ ì •ì˜ (ë³´ê³ ì„œìš© ë¼ë²¨ í¬í•¨)
        const QUESTIONS = {
            section1: {
                title: '1. ì „ë°˜ì ì¸ ë§Œì¡±ë„',
                questions: [
                    { key: 'q1_1_overall_satisfaction', label: 'ì‚¬ì—… ì°¸ì—¬ ë§Œì¡±ë„', labels: ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'] },
                    { key: 'q1_2_foundation_support', label: 'ì¬ë‹¨/ìš´ì˜ì‚¬ë¬´êµ­ í™œë™ ì§€ì› ë§Œì¡±ë„', labels: ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'] },
                    { key: 'q1_3_institute_support', label: 'íŒŒê²¬í•™ë‹¹ í™œë™ ì§€ì› ë§Œì¡±ë„', labels: ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'] },
                    { key: 'q1_4_recommendation', label: 'ì£¼ë³€ ì¶”ì²œ ì˜í–¥', labels: ['ì ê·¹ ì¶”ì²œí•¨', 'ì¶”ì²œí•¨', 'ë³´í†µ', 'ì¶”ì²œí•˜ì§€ ì•ŠìŒ', 'ì „í˜€ ì¶”ì²œí•˜ì§€ ì•ŠìŒ'] }
                ]
            },
            section2: {
                title: '2. ìˆ˜ì—… ì§€ì› ê´€ë ¨',
                questions: [
                    { key: 'q2_1_domestic_education', label: 'êµ­ë‚´ êµìœ¡ í”„ë¡œê·¸ë¨ ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q2_2_equipment_support', label: 'ë¬¸í™” êµêµ¬ ì§€ì› ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q2_3_local_coordinator', label: 'ë‹´ë‹¹ì ì†Œí†µ ë° ì§€ì› ì¶©ë¶„ì„±', labels: ['ë§¤ìš° ì¶©ë¶„í•¨', 'ì¶©ë¶„í•¨', 'ë³´í†µ', 'ì¶©ë¶„í•˜ì§€ ì•ŠìŒ', 'ë§¤ìš° ë¶€ì¡±í•¨'] },
                    { key: 'q2_4_workspace_support', label: 'ì‚¬ë¬´/ìˆ˜ì—… ê³µê°„, ê¸°ìì¬ ì§€ì› ì¶©ë¶„ì„±', labels: ['ë§¤ìš° ì¶©ë¶„í•¨', 'ì¶©ë¶„í•¨', 'ë³´í†µ', 'ì¶©ë¶„í•˜ì§€ ì•ŠìŒ', 'ë§¤ìš° ë¶€ì¡±í•¨'] }
                ]
            },
            section3: {
                title: '3. í˜„ì§€ ì •ì°© ì§€ì› ê´€ë ¨',
                questions: [
                    { key: 'q3_1_visa_support', label: 'ë¹„ì ë°œê¸‰ ì•ˆë‚´/ì§€ì›', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q3_2_accommodation_support', label: 'ìˆ™ì†Œ ì•ˆë‚´/ì§€ì›', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q3_3_coordinator_help', label: 'í˜„ì§€ ì ì‘ ì „ë‹´ ì¸ë ¥ ì§€ì› ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q3_4_safety_support', label: 'ì•ˆì „ ê´€ë ¨ ì„œë¹„ìŠ¤ ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] },
                    { key: 'q3_5_expense_support', label: 'í™œë™ë¹„ ë° ì²´ì¬ë¹„ ì§€ì› ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] }
                ]
            },
            section4: {
                title: '4. ì‚¬ì—… ê´€ë ¨',
                questions: [
                    { key: 'q4_1_competency_improvement', label: 'ì—­ëŸ‰ í–¥ìƒì— ë„ì›€ ì •ë„', labels: ['ë§¤ìš° ë„ì›€ì´ ë¨', 'ë„ì›€ì´ ë¨', 'ë³´í†µ', 'ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ', 'ì „í˜€ ë„ì›€ì´ ë˜ì§€ ì•ŠìŒ'] }
                ],
                textQuestions: [
                    { key: 'q4_2_best_benefit', label: 'ê°€ì¥ ë„ì›€ì´ ë˜ì—ˆë˜ ì  (í•„ìˆ˜)', required: true },
                    { key: 'q4_3_difficulties', label: 'í™œë™ ì¤‘ ì–´ë ¤ì› ë˜ ì  (ì„ íƒ)' },
                    { key: 'q4_4_additional_training', label: 'ì¶”ê°€ ì•ˆë‚´/êµìœ¡ í•„ìš” ì‚¬í•­ (ì„ íƒ)' },
                    { key: 'q4_5_suggestions', label: 'ê±´ì˜ ì‚¬í•­ (ì„ íƒ)' }
                ]
            }
        };

        // ë¦¬ì»¤íŠ¸ ì²™ë„ ë¼ë²¨
        const LIKERT_LABELS = {
            1: 'ë§¤ìš° ë¶ˆë§Œì¡±',
            2: 'ë¶ˆë§Œì¡±',
            3: 'ë³´í†µ',
            4: 'ë§Œì¡±',
            5: 'ë§¤ìš° ë§Œì¡±'
        };

        // ì „ì—­ ë³€ìˆ˜
        let allData = [];
        let filteredData = [];
        let overallStats = null;
        let isLoading = false;
        let currentTab = 'overall';

        // DOM ìš”ì†Œ
        const loadingContainer = document.getElementById('loadingContainer');
        const overallLoadingContainer = document.getElementById('overallLoadingContainer');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const overallStatsContainer = document.getElementById('overallStatsContainer');
        const emptyState = document.getElementById('emptyState');
        const searchInput = document.getElementById('searchInput');
        const instituteFilter = document.getElementById('instituteFilter');
        const statusFilter = document.getElementById('statusFilter');
        const clearFiltersBtn = document.getElementById('clearFiltersBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');
        const detailModal = document.getElementById('detailModal');

        // Toast ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // íƒ­ ì „í™˜
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabName = button.dataset.tab;
                currentTab = tabName;
                
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // ===== í¼ì„¼í…Œì´ì§€ 100% ì¡°ì • (Largest Remainder Method) =====
        function adjustPercentages(counts, total) {
            if (total === 0) return counts.map(() => 0);
            
            const exactPercentages = counts.map(count => (count / total) * 100);
            const flooredPercentages = exactPercentages.map(p => Math.floor(p * 10) / 10);
            
            const remainders = exactPercentages.map((exact, i) => ({
                index: i,
                remainder: exact - flooredPercentages[i],
                count: counts[i]
            }));
            
            const currentSum = flooredPercentages.reduce((a, b) => a + b, 0);
            let difference = Math.round((100 - currentSum) * 10);
            
            remainders.sort((a, b) => {
                if (b.remainder !== a.remainder) return b.remainder - a.remainder;
                return b.count - a.count;
            });
            
            const result = [...flooredPercentages];
            for (let i = 0; i < difference && i < remainders.length; i++) {
                result[remainders[i].index] = Math.round((result[remainders[i].index] + 0.1) * 10) / 10;
            }
            
            return result;
        }

        // ë°ì´í„° ë¡œë”©
        async function loadData() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading();
            
            try {
                // 1. ëª¨ë“  í•™ìƒ ì¡°íšŒ
                const { data: students, error: studentsError } = await supabase
                    .from('user_profiles')
                    .select('id, name, sejong_institute')
                    .eq('user_type', 'student')
                    .order('name');
                
                if (studentsError) throw studentsError;
                
                // 2. ëª¨ë“  ë§Œì¡±ë„ ì„¤ë¬¸ ì‘ë‹µ ì¡°íšŒ
                const { data: surveys, error: surveysError } = await supabase
                    .from('satisfaction_surveys')
                    .select('*');
                
                if (surveysError) throw surveysError;
                
                // 3. ë°ì´í„° ë³‘í•©
                allData = students.map(student => {
                    const survey = surveys.find(s => s.user_id === student.id);
                    return {
                        student,
                        survey,
                        status: survey ? survey.status : 'none',
                        averageScore: survey && survey.status === 'submitted' ? calculateAverageScore(survey) : null
                    };
                });
                
                filteredData = [...allData];
                
                // ì „ì²´ í†µê³„ ê³„ì‚°
                const submittedSurveys = surveys.filter(s => s.status === 'submitted');
                overallStats = calculateOverallStats(submittedSurveys);
                
                populateFilters();
                updateStatistics();
                renderOverallStats();
                renderTable();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                showToast('ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                showEmptyState();
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        // ===== ì „ì²´ í†µê³„ ê³„ì‚° =====
        function calculateOverallStats(surveys) {
            const total = surveys.length;
            if (total === 0) return null;
            
            // ëª¨ë“  ë¦¬ì»¤íŠ¸ ì§ˆë¬¸ì— ëŒ€í•œ í†µê³„ ê³„ì‚°
            const allQuestions = [];
            
            Object.entries(QUESTIONS).forEach(([sectionKey, section]) => {
                if (section.questions) {
                    section.questions.forEach(q => {
                        const distribution = [0, 0, 0, 0, 0]; // 5ì , 4ì , 3ì , 2ì , 1ì 
                        let sum = 0;
                        let count = 0;
                        
                        surveys.forEach(s => {
                            const score = s[q.key];
                            if (score >= 1 && score <= 5) {
                                distribution[5 - score]++;
                                sum += score;
                                count++;
                            }
                        });
                        
                        const avg = count > 0 ? (sum / count).toFixed(2) : '0.00';
                        const positiveCount = distribution[0] + distribution[1];
                        const positiveRate = count > 0 ? ((positiveCount / count) * 100).toFixed(1) : '0.0';
                        const adjustedPercentages = adjustPercentages(distribution, count);
                        
                        allQuestions.push({
                            ...q,
                            sectionTitle: section.title,
                            distribution,
                            adjustedPercentages,
                            average: avg,
                            positiveCount,
                            positiveRate,
                            totalResponses: count
                        });
                    });
                }
            });
            
            // ì „ì²´ í‰ê·  ê³„ì‚°
            const likertKeys = allQuestions.map(q => q.key);
            let totalSum = 0;
            let totalCount = 0;
            
            surveys.forEach(s => {
                likertKeys.forEach(key => {
                    if (s[key] !== null && s[key] !== undefined) {
                        totalSum += s[key];
                        totalCount++;
                    }
                });
            });
            
            const overallAverage = totalCount > 0 ? (totalSum / totalCount).toFixed(2) : '0.00';
            
            return {
                total,
                questions: allQuestions,
                overallAverage
            };
        }

        // ===== ì „ì²´ ê²°ê³¼ ë Œë”ë§ =====
        function renderOverallStats() {
            if (!overallStats) {
                overallStatsContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><h3>ì œì¶œëœ ì„¤ë¬¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3></div>';
                overallStatsContainer.style.display = 'block';
                overallLoadingContainer.style.display = 'none';
                return;
            }
            
            const stats = overallStats;
            
            let html = `
                <!-- ìš”ì•½ ì¹´ë“œ -->
                <div class="stats-section">
                    <div class="section-title">ğŸ“‹ ì‘ë‹µ ìš”ì•½</div>
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="label">ì œì¶œ ì™„ë£Œ ì‘ë‹µ</div>
                            <div class="value">${stats.total}ëª…</div>
                        </div>
                        <div class="summary-card">
                            <div class="label">ì „ì²´ í‰ê·  ë§Œì¡±ë„</div>
                            <div class="value">${stats.overallAverage}ì </div>
                            <div class="sub-value">5ì  ë§Œì </div>
                        </div>
                        <div class="summary-card">
                            <div class="label">ì „ì²´ ê¸ì • ì‘ë‹µë¥ </div>
                            <div class="value">${calculateOverallPositiveRate(stats)}%</div>
                            <div class="sub-value">4ì  ì´ìƒ ì‘ë‹µ</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ì„¹ì…˜ë³„ ë¬¸í•­ í†µê³„
            let currentSection = '';
            let questionNumber = 0;
            
            stats.questions.forEach(q => {
                if (currentSection !== q.sectionTitle) {
                    if (currentSection !== '') {
                        html += `</div>`; // ì´ì „ ì„¹ì…˜ ë‹«ê¸°
                    }
                    currentSection = q.sectionTitle;
                    html += `
                        <div class="stats-section">
                            <div class="section-title">ğŸ“Š ${currentSection}</div>
                    `;
                }
                
                questionNumber++;
                html += renderQuestionStats(q, questionNumber);
            });
            
            if (currentSection !== '') {
                html += `</div>`; // ë§ˆì§€ë§‰ ì„¹ì…˜ ë‹«ê¸°
            }
            
            // ì¢…í•© ìš”ì•½ í…Œì´ë¸”
            html += `
                <div class="stats-section">
                    <div class="section-title">ğŸ“‹ ì¢…í•© ìš”ì•½</div>
                    <div class="question-stats-card">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>ë¬¸í•­</th>
                                    <th>í‰ê·  ì ìˆ˜ (5ì  ë§Œì )</th>
                                    <th>ê¸ì • ì‘ë‹µë¥ </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.questions.map(q => `
                                    <tr>
                                        <td>${q.label}</td>
                                        <td>${q.average}</td>
                                        <td>${q.positiveRate}%</td>
                                    </tr>
                                `).join('')}
                                <tr>
                                    <td><strong>ì „ì²´ í‰ê· </strong></td>
                                    <td><strong>${stats.overallAverage}</strong></td>
                                    <td><strong>${calculateOverallPositiveRate(stats)}%</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            overallStatsContainer.innerHTML = html;
            overallStatsContainer.style.display = 'flex';
            overallLoadingContainer.style.display = 'none';
        }

        // ë¬¸í•­ë³„ í†µê³„ ë Œë”ë§
        function renderQuestionStats(question, number) {
            const dist = question.distribution;
            const pct = question.adjustedPercentages;
            const total = question.totalResponses;
            const labels = question.labels || ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'];
            
            return `
                <div class="question-stats-card">
                    <div class="question-header">
                        <div>
                            <div class="question-title">${number}) ${question.label}</div>
                            <div class="question-subtitle">í‰ê· : ${question.average}ì </div>
                        </div>
                        <div class="positive-rate-badge">ê¸ì • ì‘ë‹µë¥  ${question.positiveRate}%</div>
                    </div>
                    <div class="question-content">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>êµ¬ë¶„</th>
                                    <th>ì‘ë‹µ ìˆ˜</th>
                                    <th>ë¹„ìœ¨ (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${labels.map((label, i) => `
                                    <tr>
                                        <td>${label}</td>
                                        <td>${dist[i]}ëª…</td>
                                        <td>${pct[i].toFixed(1)}%</td>
                                    </tr>
                                `).join('')}
                                <tr>
                                    <td><strong>ê³„</strong></td>
                                    <td><strong>${total}ëª…</strong></td>
                                    <td><strong>100.0%</strong></td>
                                </tr>
                            </tbody>
                        </table>
                        ${renderDonutChart(question.positiveCount, total, 'ê¸ì • ì‘ë‹µ')}
                    </div>
                </div>
            `;
        }

        // ë„ë„› ì°¨íŠ¸ ë Œë”ë§
        function renderDonutChart(positiveCount, total, label) {
            const percentage = total > 0 ? (positiveCount / total * 100) : 0;
            const circumference = 2 * Math.PI * 50;
            const offset = circumference * (1 - percentage / 100);
            
            return `
                <div class="donut-chart-container">
                    <div class="donut-chart">
                        <svg viewBox="0 0 120 120">
                            <circle class="bg" cx="60" cy="60" r="50"></circle>
                            <circle class="progress" cx="60" cy="60" r="50" 
                                stroke-dasharray="${circumference}" 
                                stroke-dashoffset="${offset}"></circle>
                        </svg>
                        <div class="donut-center">
                            <div class="donut-total">ì´ ${total}ëª…</div>
                            <div class="donut-number">${percentage.toFixed(1)}%</div>
                        </div>
                    </div>
                    <div class="donut-legend">
                        <div class="legend-item">
                            <div class="legend-color positive"></div>
                            <span>${label}: ${positiveCount}ëª…</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color negative"></div>
                            <span>ê¸°íƒ€: ${total - positiveCount}ëª…</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ì „ì²´ ê¸ì • ì‘ë‹µë¥  ê³„ì‚°
        function calculateOverallPositiveRate(stats) {
            let totalPositive = 0;
            let totalResponses = 0;
            
            stats.questions.forEach(q => {
                totalPositive += q.positiveCount;
                totalResponses += q.totalResponses;
            });
            
            return totalResponses > 0 ? ((totalPositive / totalResponses) * 100).toFixed(1) : '0.0';
        }

        // í‰ê·  ì ìˆ˜ ê³„ì‚°
        function calculateAverageScore(survey) {
            const likertKeys = [
                'q1_1_overall_satisfaction', 'q1_2_foundation_support', 'q1_3_institute_support', 'q1_4_recommendation',
                'q2_1_domestic_education', 'q2_2_equipment_support', 'q2_3_local_coordinator', 'q2_4_workspace_support',
                'q3_1_visa_support', 'q3_2_accommodation_support', 'q3_3_coordinator_help', 'q3_4_safety_support', 'q3_5_expense_support',
                'q4_1_competency_improvement'
            ];
            
            let sum = 0;
            let count = 0;
            
            likertKeys.forEach(key => {
                if (survey[key] !== null && survey[key] !== undefined) {
                    sum += survey[key];
                    count++;
                }
            });
            
            return count > 0 ? (sum / count).toFixed(2) : 0;
        }

        // ë¡œë”© ìƒíƒœ
        function showLoading() {
            loadingContainer.style.display = 'flex';
            overallLoadingContainer.style.display = 'flex';
            tableContainer.style.display = 'none';
            overallStatsContainer.style.display = 'none';
            emptyState.style.display = 'none';
        }

        function hideLoading() {
            loadingContainer.style.display = 'none';
            overallLoadingContainer.style.display = 'none';
        }

        function showEmptyState() {
            emptyState.style.display = 'block';
            tableContainer.style.display = 'none';
        }

        // í•„í„° ì±„ìš°ê¸°
        function populateFilters() {
            const institutes = [...new Set(allData.map(d => d.student.sejong_institute).filter(Boolean))].sort();
            
            instituteFilter.innerHTML = '<option value="">ì „ì²´ í•™ë‹¹</option>';
            institutes.forEach(inst => {
                const option = document.createElement('option');
                option.value = inst;
                option.textContent = inst;
                instituteFilter.appendChild(option);
            });
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatistics() {
            const total = filteredData.length;
            const submitted = filteredData.filter(d => d.status === 'submitted').length;
            const draft = filteredData.filter(d => d.status === 'draft').length;
            const none = filteredData.filter(d => d.status === 'none').length;
            const rate = total > 0 ? Math.round((submitted / total) * 100) : 0;
            
            const submittedData = filteredData.filter(d => d.status === 'submitted' && d.averageScore);
            const avgScore = submittedData.length > 0 
                ? (submittedData.reduce((sum, d) => sum + parseFloat(d.averageScore), 0) / submittedData.length).toFixed(2)
                : '0.0';
            
            document.getElementById('statTotal').textContent = total;
            document.getElementById('statSubmitted').textContent = submitted;
            document.getElementById('statDraft').textContent = draft;
            document.getElementById('statNone').textContent = none;
            document.getElementById('statRate').textContent = `${rate}%`;
            document.getElementById('statAverage').textContent = avgScore;
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable() {
            if (filteredData.length === 0) {
                showEmptyState();
                return;
            }
            
            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';
            
            tableBody.innerHTML = filteredData.map(data => {
                const statusBadge = getStatusBadge(data.status);
                const scoreBadge = data.averageScore ? getScoreBadge(parseFloat(data.averageScore)) : '-';
                const submittedDate = data.survey?.submitted_at 
                    ? new Date(data.survey.submitted_at).toLocaleDateString('ko-KR')
                    : '-';
                
                return `
                    <tr>
                        <td><strong>${data.student.name}</strong></td>
                        <td>${data.student.sejong_institute || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${submittedDate}</td>
                        <td>${scoreBadge}</td>
                        <td>
                            ${data.survey ? `<button class="btn-view" onclick="openDetailModal('${data.student.id}')">ìƒì„¸ë³´ê¸°</button>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ìƒíƒœ ë°°ì§€
        function getStatusBadge(status) {
            const badges = {
                submitted: '<span class="status-badge submitted">âœ… ì œì¶œ ì™„ë£Œ</span>',
                draft: '<span class="status-badge draft">â³ ì„ì‹œ ì €ì¥</span>',
                none: '<span class="status-badge none">âŒ ë¯¸ì‘ë‹µ</span>'
            };
            return badges[status] || badges.none;
        }

        // ì ìˆ˜ ë°°ì§€
        function getScoreBadge(score) {
            let className = 'average';
            if (score >= 4.5) className = 'excellent';
            else if (score >= 4.0) className = 'good';
            else if (score < 3.0) className = 'low';
            
            return `<span class="score-badge ${className}">${score}</span>`;
        }

        // í•„í„°ë§
        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedInstitute = instituteFilter.value;
            const selectedStatus = statusFilter.value;
            
            filteredData = allData.filter(data => {
                const matchesSearch = !searchTerm || data.student.name.toLowerCase().includes(searchTerm);
                const matchesInstitute = !selectedInstitute || data.student.sejong_institute === selectedInstitute;
                const matchesStatus = !selectedStatus || data.status === selectedStatus;
                
                return matchesSearch && matchesInstitute && matchesStatus;
            });
            
            updateStatistics();
            renderTable();
        }

        // ìƒì„¸ ëª¨ë‹¬ ì—´ê¸°
        window.openDetailModal = function(studentId) {
            const data = allData.find(d => d.student.id === studentId);
            if (!data || !data.survey) return;
            
            document.getElementById('modalTitle').textContent = `${data.student.name}ë‹˜ì˜ ì‘ë‹µ`;
            document.getElementById('modalSubtitle').textContent = `${data.student.sejong_institute || 'í•™ë‹¹ ì •ë³´ ì—†ìŒ'} | ${data.status === 'submitted' ? 'ì œì¶œ ì™„ë£Œ' : 'ì„ì‹œ ì €ì¥'}`;
            
            let bodyHtml = '';
            
            Object.entries(QUESTIONS).forEach(([sectionKey, section]) => {
                bodyHtml += `
                    <div class="response-section">
                        <div class="response-section-title">
                            <span>ğŸ“</span>
                            ${section.title}
                        </div>
                `;
                
                if (section.questions) {
                    section.questions.forEach(q => {
                        const value = data.survey[q.key];
                        const percentage = value ? (value / 5 * 100) : 0;
                        const label = value ? LIKERT_LABELS[value] : 'ì‘ë‹µ ì—†ìŒ';
                        
                        bodyHtml += `
                            <div class="response-item">
                                <div class="response-question">${q.label}</div>
                                <div class="response-answer-likert">
                                    <div class="likert-score">${value || '-'}</div>
                                    <div class="likert-bar-container">
                                        <div class="likert-bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="likert-label">${label}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (section.textQuestions) {
                    section.textQuestions.forEach(q => {
                        const value = data.survey[q.key];
                        
                        bodyHtml += `
                            <div class="response-item">
                                <div class="response-question">${q.label}</div>
                                <div class="response-answer-text ${!value ? 'no-answer' : ''}">
                                    ${value || 'ì‘ë‹µ ì—†ìŒ'}
                                </div>
                            </div>
                        `;
                    });
                }
                
                bodyHtml += '</div>';
            });
            
            document.getElementById('modalBody').innerHTML = bodyHtml;
            detailModal.classList.add('active');
        };

        // ëª¨ë‹¬ ë‹«ê¸°
        window.closeModal = function() {
            detailModal.classList.remove('active');
        };

        detailModal.addEventListener('click', (e) => {
            if (e.target === detailModal) {
                closeModal();
            }
        });

        // ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        async function exportToExcel() {
            try {
                exportExcelBtn.disabled = true;
                exportExcelBtn.innerHTML = 'â³ ë‚´ë³´ë‚´ëŠ” ì¤‘...';
                
                if (currentTab === 'overall' && overallStats) {
                    // ì „ì²´ ê²°ê³¼ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                    const workbook = XLSX.utils.book_new();
                    
                    // ìš”ì•½ ì‹œíŠ¸
                    const summaryData = [
                        ['ì‚¬ì—… ë§Œì¡±ë„ ì¡°ì‚¬ ì „ì²´ ê²°ê³¼'],
                        [''],
                        ['ì œì¶œ ì™„ë£Œ ì‘ë‹µ', overallStats.total],
                        ['ì „ì²´ í‰ê·  ë§Œì¡±ë„', overallStats.overallAverage],
                        ['ì „ì²´ ê¸ì • ì‘ë‹µë¥ ', calculateOverallPositiveRate(overallStats) + '%']
                    ];
                    const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(workbook, summarySheet, 'ìš”ì•½');
                    
                    // ë¬¸í•­ë³„ ìƒì„¸ ì‹œíŠ¸
                    let currentSection = '';
                    let sectionNumber = 0;
                    let sectionData = [];
                    
                    overallStats.questions.forEach((q, index) => {
                        if (currentSection !== q.sectionTitle) {
                            if (currentSection !== '' && sectionData.length > 0) {
                                const sheet = XLSX.utils.aoa_to_sheet(sectionData);
                                XLSX.utils.book_append_sheet(workbook, sheet, `ì„¹ì…˜${sectionNumber}`);
                            }
                            currentSection = q.sectionTitle;
                            sectionNumber++;
                            sectionData = [[currentSection], ['']];
                        }
                        
                        const labels = q.labels || ['ë§¤ìš° ë§Œì¡±', 'ë§Œì¡±', 'ë³´í†µ', 'ë¶ˆë§Œì¡±', 'ë§¤ìš° ë¶ˆë§Œì¡±'];
                        sectionData.push(
                            [`${q.label}`],
                            ['í‰ê·  ì ìˆ˜', q.average],
                            ['ê¸ì • ì‘ë‹µë¥ ', q.positiveRate + '%'],
                            [''],
                            ['êµ¬ë¶„', 'ì‘ë‹µ ìˆ˜', 'ë¹„ìœ¨(%)'],
                            ...labels.map((label, i) => [label, q.distribution[i], q.adjustedPercentages[i].toFixed(1)]),
                            ['ê³„', q.totalResponses, '100.0'],
                            ['']
                        );
                    });
                    
                    if (sectionData.length > 0) {
                        const sheet = XLSX.utils.aoa_to_sheet(sectionData);
                        XLSX.utils.book_append_sheet(workbook, sheet, `ì„¹ì…˜${sectionNumber}`);
                    }
                    
                    // ì¢…í•© ìš”ì•½ ì‹œíŠ¸
                    const comprehensiveData = [
                        ['ì¢…í•© ìš”ì•½'],
                        [''],
                        ['ë¬¸í•­', 'í‰ê·  ì ìˆ˜', 'ê¸ì • ì‘ë‹µë¥ '],
                        ...overallStats.questions.map(q => [q.label, q.average, q.positiveRate + '%']),
                        ['ì „ì²´ í‰ê· ', overallStats.overallAverage, calculateOverallPositiveRate(overallStats) + '%']
                    ];
                    const comprehensiveSheet = XLSX.utils.aoa_to_sheet(comprehensiveData);
                    XLSX.utils.book_append_sheet(workbook, comprehensiveSheet, 'ì¢…í•©ìš”ì•½');
                    
                    const today = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(workbook, `ì‚¬ì—…ë§Œì¡±ë„ì¡°ì‚¬_ì „ì²´ê²°ê³¼_${today}.xlsx`);
                    
                } else {
                    // í•™ìƒë³„ ê²°ê³¼ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
                    const submittedData = allData.filter(d => d.status === 'submitted' && d.survey);
                    
                    if (submittedData.length === 0) {
                        showToast('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
                        return;
                    }
                    
                    const exportData = submittedData.map(d => {
                        const row = {
                            'ì´ë¦„': d.student.name,
                            'íŒŒê²¬ í•™ë‹¹': d.student.sejong_institute || '',
                            'ìƒíƒœ': 'ì œì¶œ ì™„ë£Œ',
                            'ì œì¶œì¼': d.survey.submitted_at ? new Date(d.survey.submitted_at).toLocaleDateString('ko-KR') : '',
                            'í‰ê·  ì ìˆ˜': d.averageScore
                        };
                        
                        Object.values(QUESTIONS).forEach(section => {
                            if (section.questions) {
                                section.questions.forEach(q => {
                                    row[q.label] = d.survey[q.key] || '';
                                });
                            }
                            if (section.textQuestions) {
                                section.textQuestions.forEach(q => {
                                    row[q.label] = d.survey[q.key] || '';
                                });
                            }
                        });
                        
                        return row;
                    });
                    
                    const worksheet = XLSX.utils.json_to_sheet(exportData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'í•™ìƒë³„ê²°ê³¼');
                    
                    const today = new Date().toISOString().split('T')[0];
                    XLSX.writeFile(workbook, `ì‚¬ì—…ë§Œì¡±ë„ì¡°ì‚¬_í•™ìƒë³„ê²°ê³¼_${today}.xlsx`);
                }
                
                showToast('ì—‘ì…€ íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ì—‘ì…€ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', error);
                showToast('ì—‘ì…€ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                exportExcelBtn.disabled = false;
                exportExcelBtn.innerHTML = '<span>ğŸ“¥</span> ì „ì²´ ì—‘ì…€ ë‚´ë³´ë‚´ê¸°';
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        searchInput.addEventListener('input', applyFilters);
        instituteFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
        
        clearFiltersBtn.addEventListener('click', () => {
            searchInput.value = '';
            instituteFilter.value = '';
            statusFilter.value = '';
            applyFilters();
        });
        
        exportExcelBtn.addEventListener('click', exportToExcel);

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && detailModal.classList.contains('active')) {
                closeModal();
            }
        });

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAdminAuth()) return;
            loadData();
        });
    </script>
</body>
</html>
