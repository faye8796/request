<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</title>
    
    <!-- CSS Files - Cache Busting Added -->
    <link rel="stylesheet" href="css/main.css?v=1.3.0">
    <link rel="stylesheet" href="css/login.css?v=1.3.0">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        <!-- í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ -->
        <div id="loginPage" class="page active">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <h1>ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</h1>
                        <p>King Sejong Institute Cultural Intern Support System</p>
                    </div>

                    <!-- í•™ìƒ ë¡œê·¸ì¸ í¼ -->
                    <div id="studentLogin" class="login-form active">
                        <div class="form-group">
                            <label>ì´ë¦„</label>
                            <input type="text" id="studentName" placeholder="ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="form-group">
                            <label>ìƒë…„ì›”ì¼</label>
                            <input type="date" id="studentBirth">
                        </div>
                        <button id="studentLoginBtn" class="login-btn primary">
                            <i data-lucide="user"></i>
                            í•™ìƒ ë¡œê·¸ì¸
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files - Cache Busting Added -->
    <!-- ì„¤ì • íŒŒì¼ì„ ê°€ì¥ ë¨¼ì € ë¡œë“œ -->
    <script src="js/config.js?v=1.3.0"></script>
    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ -->
    <script src="js/supabase-client.js?v=1.3.0"></script>
    <script src="js/utils.js?v=1.3.0"></script>
    <script src="js/auth.js?v=1.3.0"></script>
    
    <!-- í•™ìƒ ë¡œê·¸ì¸ ì „ìš© ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                    console.log('Lucide icons initialized successfully');
                } else {
                    console.error('Lucide library not loaded');
                }

                // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
                checkExistingSession();
                
                // í•™ìƒ ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ì„¤ì •
                setupStudentLoginEvents();
                
            } catch (error) {
                console.error('í˜ì´ì§€ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        });

        // ê¸°ì¡´ ì„¸ì…˜ í™•ì¸
        function checkExistingSession() {
            const studentSession = localStorage.getItem('currentStudent');
            if (studentSession) {
                try {
                    const studentData = JSON.parse(studentSession);
                    console.log('ê¸°ì¡´ ì„¸ì…˜ ë°œê²¬:', studentData.name);
                    
                    // ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = 'student/dashboard.html';
                } catch (error) {
                    console.error('ì„¸ì…˜ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', error);
                    localStorage.removeItem('currentStudent');
                }
            }
        }

        // í•™ìƒ ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ì„¤ì •
        function setupStudentLoginEvents() {
            const studentLoginBtn = document.getElementById('studentLoginBtn');
            const studentNameInput = document.getElementById('studentName');
            const studentBirthInput = document.getElementById('studentBirth');

            if (studentLoginBtn) {
                studentLoginBtn.addEventListener('click', handleStudentLogin);
            }

            // Enter í‚¤ ì²˜ë¦¬
            [studentNameInput, studentBirthInput].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            handleStudentLogin();
                        }
                    });
                }
            });
        }

        // í•™ìƒ ë¡œê·¸ì¸ ì²˜ë¦¬ - ìˆ˜ì •ëœ ë²„ì „ (ì‹¤ì œ DB ì¸ì¦ ì‚¬ìš©)
        async function handleStudentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const birth = document.getElementById('studentBirth').value;
            
            if (!name || !birth) {
                alert('ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // ë¡œë”© ìƒíƒœ í‘œì‹œ
                const loginBtn = document.getElementById('studentLoginBtn');
                const originalText = loginBtn.innerHTML;
                loginBtn.innerHTML = '<i data-lucide="loader-2"></i> ë¡œê·¸ì¸ ì¤‘...';
                loginBtn.disabled = true;

                console.log('ğŸ” í•™ìƒ ì¸ì¦ ì‹œë„:', { name, birth });

                // SupabaseAPI ë¡œë“œ ëŒ€ê¸°
                let waitCount = 0;
                while (typeof SupabaseAPI === 'undefined' && waitCount < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitCount++;
                }

                if (typeof SupabaseAPI === 'undefined') {
                    throw new Error('ì¸ì¦ ì„œë¹„ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                }

                // ì‹¤ì œ DB ì¸ì¦ ì‹œë„
                const result = await SupabaseAPI.authenticateStudent(name, birth);
                
                console.log('ğŸ¯ ì¸ì¦ ê²°ê³¼:', result);

                if (result && result.success && result.data) {
                    // ì‹¤ì œ DB ë°ì´í„° ì‚¬ìš©
                    const studentData = {
                        // ì‹¤ì œ DB í•„ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                        id: result.data.id,
                        name: result.data.name,
                        birth_date: result.data.birth_date,
                        sejong_institute: result.data.sejong_institute,
                        field: result.data.field,
                        user_type: result.data.user_type || 'student',
                        
                        // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
                        created_at: result.data.created_at,
                        updated_at: result.data.updated_at,
                        loginTime: new Date().toISOString()
                    };
                    
                    console.log('âœ… ì‹¤ì œ DB ë°ì´í„° ì‚¬ìš©:', {
                        name: studentData.name,
                        sejong_institute: studentData.sejong_institute,
                        field: studentData.field,
                        id: studentData.id
                    });
                    
                    // ì„¸ì…˜ ì €ì¥
                    localStorage.setItem('currentStudent', JSON.stringify(studentData));
                    localStorage.setItem('studentSession', 'true');
                    
                    // sessionStorageì—ë„ ë™ê¸°í™” (equipment-request.htmlì—ì„œ ì‚¬ìš©)
                    const sessionData = {
                        user: studentData,
                        userType: 'student',
                        loginTime: studentData.loginTime
                    };
                    sessionStorage.setItem('userSession', JSON.stringify(sessionData));
                    
                    console.log('âœ… ì„¸ì…˜ ì €ì¥ ì™„ë£Œ');
                    
                    // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    window.location.href = 'student/dashboard.html';
                    
                } else {
                    // ì¸ì¦ ì‹¤íŒ¨ ì‹œ êµ¬ì²´ì ì¸ ë©”ì‹œì§€ í‘œì‹œ
                    console.warn('âŒ ì¸ì¦ ì‹¤íŒ¨:', result);
                    
                    let errorMessage = 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    if (result && result.message) {
                        if (result.message.includes('ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤')) {
                            errorMessage = 'ì…ë ¥í•˜ì‹  ì •ë³´ì™€ ì¼ì¹˜í•˜ëŠ” í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\nì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        } else if (result.message.includes('ë„¤íŠ¸ì›Œí¬')) {
                            errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        } else if (result.message.includes('ì„œë²„')) {
                            errorMessage = 'ì„œë²„ì— ì¼ì‹œì ì¸ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                        } else {
                            errorMessage = result.message;
                        }
                    }
                    
                    alert(errorMessage);
                }
                
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                
                let errorMessage = 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.message) {
                    if (error.message.includes('ë„¤íŠ¸ì›Œí¬') || error.message.includes('fetch')) {
                        errorMessage = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    } else if (error.message.includes('ì„œë¹„ìŠ¤') || error.message.includes('ì¸ì¦')) {
                        errorMessage = error.message;
                    } else {
                        errorMessage = 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    }
                }
                
                alert(errorMessage);
                
            } finally {
                // ë²„íŠ¼ ìƒíƒœ ë³µêµ¬
                const loginBtn = document.getElementById('studentLoginBtn');
                const originalText = '<i data-lucide="user"></i> í•™ìƒ ë¡œê·¸ì¸';
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                
                // ì•„ì´ì½˜ ì¬ì´ˆê¸°í™”
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }

        // ë””ë²„ê·¸ ì •ë³´ (ê°œë°œììš©)
        function showDebugInfo() {
            console.log('=== í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ ë””ë²„ê·¸ ì •ë³´ ===');
            console.log('í˜„ì¬ ì„¸ì…˜:', localStorage.getItem('currentStudent'));
            console.log('SupabaseAPI ìƒíƒœ:', typeof SupabaseAPI !== 'undefined');
            console.log('ë„¤íŠ¸ì›Œí¬ ìƒíƒœ:', navigator.onLine);
            
            if (typeof SupabaseAPI !== 'undefined') {
                console.log('SupabaseAPI í´ë¼ì´ì–¸íŠ¸:', !!SupabaseAPI.client);
                console.log('í˜„ì¬ ì‚¬ìš©ì:', SupabaseAPI.currentUser);
            }
        }

        // ê°œë°œì ë‹¨ì¶•í‚¤ (Ctrl + D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                showDebugInfo();
            }
        });
    </script>
    
    <!-- Lucide ì•„ì´ì½˜ ì´ˆê¸°í™” -->
    <script>
        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ì•„ì´ì½˜ ë‹¤ì‹œ ì—…ë°ì´íŠ¸
        setTimeout(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }, 100);
    </script>
</body>
</html>