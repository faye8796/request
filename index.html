<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css?v=4.2.1">
    <link rel="stylesheet" href="css/login.css?v=4.2.1">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        <!-- í•™ìƒ ë¡œê·¸ì¸ í˜ì´ì§€ -->
        <div id="loginPage" class="page active">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <h1>ì„¸ì¢…í•™ë‹¹ ë¬¸í™”ì¸í„´ ì§€ì› ì‹œìŠ¤í…œ</h1>
                        <p>King Sejong Institute Cultural Intern Support System</p>
                    </div>

                    <!-- í•™ìƒ ë¡œê·¸ì¸ í¼ - ğŸ†• 2ë‹¨ê³„ ë¡œê·¸ì¸ í”Œë¡œìš° -->
                    <div id="studentLogin" class="login-form active">
                        <div class="form-group">
                            <label>ì´ë¦„</label>
                            <input type="text" id="studentName" placeholder="ì„±ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <div class="form-group">
                            <label>ìƒë…„ì›”ì¼</label>
                            <input type="date" id="studentBirth" required>
                        </div>
                        
                        <!-- ğŸ†• ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ (ì²˜ìŒì—” ìˆ¨ê¹€) -->
                        <div class="form-group" id="passwordGroup" style="display: none;">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                            <small class="password-hint">ì´ ê³„ì •ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</small>
                        </div>
                        
                        <!-- ğŸ†• 2ë‹¨ê³„ ë²„íŠ¼ ì‹œìŠ¤í…œ -->
                        <button id="checkPasswordBtn" class="login-btn secondary">
                            <i data-lucide="search"></i>
                            ë¡œê·¸ì¸ í™•ì¸
                        </button>
                        
                        <button id="studentLoginBtn" class="login-btn primary" style="display: none;">
                            <i data-lucide="user"></i>
                            í•™ìƒ ë¡œê·¸ì¸
                        </button>
                        
                        <!-- ğŸ†• ë¡œë”© ìƒíƒœ í‘œì‹œ -->
                        <div id="loginLoading" class="login-loading" style="display: none;">
                            <i data-lucide="loader-2" class="spin"></i>
                            <span>í™•ì¸ ì¤‘...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files - ëª¨ë“ˆí™” ì‹œìŠ¤í…œ -->
    
    <!-- í•µì‹¬ ì„¤ì • -->
    <script src="js/config.js?v=4.2.1"></script>
    <script src="js/utils.js?v=4.2.1"></script>
    <script src="js/auth.js?v=4.2.1"></script>

    <!-- Supabase ëª¨ë“ˆë“¤ -->
    <script src="js/supabase/supabase-core.js?v=4.2.1"></script>
    <script src="js/supabase/supabase-student.js?v=4.2.1"></script>
    <script src="js/supabase/supabase-admin.js?v=4.2.1"></script>
    <script src="js/supabase-client.js?v=4.2.1"></script>
    
    <!-- í˜ì´ì§€ ì´ˆê¸°í™” ìŠ¤í¬ë¦½íŠ¸ -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Lucide ì•„ì´ì½˜ ì´ˆê¸°í™”
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // ëª¨ë“ˆ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                initializeSystem();
                
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        });

        // ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        async function initializeSystem() {
            try {
                // ëª¨ë“ˆ ë¡œë”© ëŒ€ê¸°
                const modulesLoaded = await waitForModules();
                
                if (!modulesLoaded) {
                    console.warn('ì¼ë¶€ ëª¨ë“ˆ ë¡œë”© ì‹¤íŒ¨ - ê¸°ë³¸ ê¸°ëŠ¥ë§Œ ì‚¬ìš©');
                }

                // AuthManager ì´ˆê¸°í™”
                if (window.AuthManager && typeof window.AuthManager.init === 'function') {
                    window.AuthManager.init();
                }

                // SupabaseAPI ì´ˆê¸°í™”
                if (window.SupabaseAPI) {
                    if (!window.SupabaseAPI._moduleStatus?.initialized) {
                        try {
                            await window.SupabaseAPI.init();
                        } catch (apiError) {
                            console.error('API ì´ˆê¸°í™” ì‹¤íŒ¨:', apiError);
                        }
                    }
                }
                
                // ğŸ†• 2ë‹¨ê³„ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
                initializePasswordLogin();
                
            } catch (error) {
                console.error('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // ğŸ†• ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        function initializePasswordLogin() {
            try {
                console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”...');
                
                const checkPasswordBtn = document.getElementById('checkPasswordBtn');
                const studentLoginBtn = document.getElementById('studentLoginBtn');
                
                if (checkPasswordBtn) {
                    checkPasswordBtn.addEventListener('click', handlePasswordCheck);
                }
                
                if (studentLoginBtn) {
                    studentLoginBtn.addEventListener('click', handleFinalLogin);
                }
                
                // Enter í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
                const loginPassword = document.getElementById('loginPassword');
                if (loginPassword) {
                    loginPassword.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter' && !studentLoginBtn.style.display.includes('none')) {
                            handleFinalLogin();
                        }
                    });
                }
                
                console.log('âœ… ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ');
                
            } catch (error) {
                console.error('âŒ ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // ğŸ” 1ë‹¨ê³„: ë¹„ë°€ë²ˆí˜¸ í•„ìš” ì—¬ë¶€ í™•ì¸
        async function handlePasswordCheck() {
            const nameInput = document.getElementById('studentName');
            const birthInput = document.getElementById('studentBirth');
            const checkBtn = document.getElementById('checkPasswordBtn');
            const loading = document.getElementById('loginLoading');
            
            if (!nameInput || !birthInput || !checkBtn || !loading) return;
            
            const name = nameInput.value.trim();
            const birthDate = birthInput.value;
            
            // ì…ë ¥ ê²€ì¦
            if (!name || !birthDate) {
                showLoginMessage('ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ë¡œë”© ì‹œì‘
            checkBtn.style.display = 'none';
            loading.style.display = 'flex';
            
            try {
                console.log('ğŸ” ë¹„ë°€ë²ˆí˜¸ í•„ìš” ì—¬ë¶€ í™•ì¸ ì¤‘...', { name, birthDate });
                
                // ì‚¬ìš©ì ì¡°íšŒ ë° ë¹„ë°€ë²ˆí˜¸ ì„¤ì • ì—¬ë¶€ í™•ì¸
                const result = await checkPasswordRequired(name, birthDate);
                
                if (!result.found) {
                    showLoginMessage('ë“±ë¡ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì…ë‹ˆë‹¤.', 'error');
                    resetLoginForm();
                    return;
                }
                
                if (result.requirePassword) {
                    // ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ëœ ì‚¬ìš©ì - ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
                    showPasswordInput();
                    showLoginMessage('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'info');
                } else {
                    // ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ì‚¬ìš©ì - ì¦‰ì‹œ ë¡œê·¸ì¸
                    await performDirectLogin(name, birthDate);
                }
                
            } catch (error) {
                console.error('âŒ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                showLoginMessage('ì‚¬ìš©ì í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetLoginForm();
            }
        }

        // ğŸ”‘ 2ë‹¨ê³„: ìµœì¢… ë¡œê·¸ì¸ (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
        async function handleFinalLogin() {
            const nameInput = document.getElementById('studentName');
            const birthInput = document.getElementById('studentBirth');
            const passwordInput = document.getElementById('loginPassword');
            const loginBtn = document.getElementById('studentLoginBtn');
            const loading = document.getElementById('loginLoading');
            
            if (!nameInput || !birthInput || !passwordInput || !loginBtn || !loading) return;
            
            const name = nameInput.value.trim();
            const birthDate = birthInput.value;
            const password = passwordInput.value;
            
            if (!password) {
                showLoginMessage('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                passwordInput.focus();
                return;
            }
            
            // ë¡œë”© ì‹œì‘
            loginBtn.style.display = 'none';
            loading.style.display = 'flex';
            
            try {
                console.log('ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ ë¡œê·¸ì¸ ì‹œë„...', { name, birthDate });
                
                // ë¹„ë°€ë²ˆí˜¸ í¬í•¨ ì¸ì¦
                const result = await authenticateUserWithPassword(name, birthDate, password);
                
                if (result.success) {
                    showLoginMessage('ë¡œê·¸ì¸ ì„±ê³µ! ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
                    
                    // ì‚¬ìš©ì ì •ë³´ ì €ì¥
                    const userData = {
                        ...result.user,
                        hasPassword: result.hasPassword
                    };
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = 'student/dashboard.html';
                    }, 1000);
                } else {
                    showLoginMessage(result.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    resetLoginForm();
                }
                
            } catch (error) {
                console.error('âŒ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                showLoginMessage('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetLoginForm();
            }
        }

        // ğŸš€ ì§ì ‘ ë¡œê·¸ì¸ (ë¹„ë°€ë²ˆí˜¸ ì—†ëŠ” ì‚¬ìš©ì)
        async function performDirectLogin(name, birthDate) {
            try {
                console.log('ğŸš€ ì§ì ‘ ë¡œê·¸ì¸ ì²˜ë¦¬...', { name, birthDate });
                
                const result = await authenticateUserWithPassword(name, birthDate, null);
                
                if (result.success) {
                    showLoginMessage('ë¡œê·¸ì¸ ì„±ê³µ! ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
                    
                    // ì‚¬ìš©ì ì •ë³´ ì €ì¥  
                    const userData = {
                        ...result.user,
                        hasPassword: result.hasPassword
                    };
                    localStorage.setItem('userData', JSON.stringify(userData));
                    
                    // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = 'student/dashboard.html';
                    }, 1000);
                } else {
                    showLoginMessage(result.message || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    resetLoginForm();
                }
                
            } catch (error) {
                console.error('âŒ ì§ì ‘ ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                showLoginMessage('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                resetLoginForm();
            }
        }

        // ğŸ” ë¹„ë°€ë²ˆí˜¸ í•„ìš” ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜ (ìˆ˜ì •)
        async function checkPasswordRequired(name, birthDate) {
            try {
                if (!window.SupabaseStudent) {
                    throw new Error('SupabaseStudentê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                return await window.SupabaseStudent.checkPasswordRequired(name, birthDate);

            } catch (error) {
                console.error('âŒ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
                throw error;
            }
        }

        // ğŸ” ë¹„ë°€ë²ˆí˜¸ í¬í•¨ ì¸ì¦ í•¨ìˆ˜ (ìˆ˜ì •)
        async function authenticateUserWithPassword(name, birthDate, password) {
            try {
                if (!window.SupabaseStudent) {
                    throw new Error('SupabaseStudentê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                const result = await window.SupabaseStudent.authenticateStudentWithPassword(name, birthDate, password);

                if (result.success && result.data) {
                    return {
                        success: true,
                        user: result.data,
                        hasPassword: result.data.hasPassword
                    };
                } else {
                    return {
                        success: false,
                        message: result.error?.message || 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                        requirePassword: result.error?.requirePassword || false
                    };
                }

            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì¸ì¦ ì¤‘ ì˜¤ë¥˜:', error);
                return {
                    success: false,
                    message: 'ì¸ì¦ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                };
            }
        }

        // ğŸ¨ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
        function showPasswordInput() {
            const passwordGroup = document.getElementById('passwordGroup');
            const studentLoginBtn = document.getElementById('studentLoginBtn');
            const loading = document.getElementById('loginLoading');
            const passwordInput = document.getElementById('loginPassword');
            
            if (passwordGroup) {
                passwordGroup.style.display = 'block';
            }
            
            if (studentLoginBtn) {
                studentLoginBtn.style.display = 'block';
            }
            
            if (loading) {
                loading.style.display = 'none';
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                if (passwordInput) {
                    passwordInput.focus();
                }
            }, 100);
        }

        // ğŸ”„ ë¡œê·¸ì¸ í¼ ì´ˆê¸°í™”
        function resetLoginForm() {
            const checkBtn = document.getElementById('checkPasswordBtn');
            const loginBtn = document.getElementById('studentLoginBtn');
            const passwordGroup = document.getElementById('passwordGroup');
            const loading = document.getElementById('loginLoading');
            const passwordInput = document.getElementById('loginPassword');
            
            if (checkBtn) {
                checkBtn.style.display = 'block';
            }
            
            if (loginBtn) {
                loginBtn.style.display = 'none';
            }
            
            if (passwordGroup) {
                passwordGroup.style.display = 'none';
            }
            
            if (loading) {
                loading.style.display = 'none';
            }
            
            if (passwordInput) {
                passwordInput.value = '';
            }
        }

        // ğŸ“¢ ë¡œê·¸ì¸ ë©”ì‹œì§€ í‘œì‹œ
        function showLoginMessage(message, type = 'info') {
            // ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°
            const existingMessage = document.querySelector('.login-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageHTML = `
                <div class="login-message message-${type}">
                    <i data-lucide="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const loginForm = document.getElementById('studentLogin');
            if (loginForm) {
                loginForm.insertAdjacentHTML('beforeend', messageHTML);
                
                // ì•„ì´ì½˜ ì´ˆê¸°í™”
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
                
                // 3ì´ˆ í›„ ìë™ ì œê±° (ì„±ê³µ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš°)
                if (type !== 'success') {
                    setTimeout(() => {
                        const message = document.querySelector('.login-message');
                        if (message) {
                            message.style.opacity = '0';
                            message.style.transform = 'translateY(-10px)';
                            setTimeout(() => message.remove(), 300);
                        }
                    }, 3000);
                }
            }
        }

        // ëª¨ë“ˆ ë¡œë”© ëŒ€ê¸°
        function waitForModules() {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 100;
                
                const checkModules = () => {
                    attempts++;
                    
                    const coreLoaded = !!window.SupabaseCore;
                    const apiLoaded = !!window.SupabaseAPI;
                    const configLoaded = !!window.CONFIG;
                    
                    // í•„ìˆ˜ ëª¨ë“ˆ í™•ì¸
                    if (configLoaded && coreLoaded && apiLoaded) {
                        resolve(true);
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        resolve(false);
                        return;
                    }
                    
                    setTimeout(checkModules, 100);
                };
                
                checkModules();
            });
        }
    </script>

    <!-- ğŸ¨ ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ ì‹œìŠ¤í…œ CSS -->
    <style>
        /* ğŸ” ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #passwordGroup {
            animation: slideDown 0.3s ease;
        }
        
        .password-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
            color: #6366f1;
            font-weight: 500;
        }
        
        /* ğŸ¯ 2ë‹¨ê³„ ë²„íŠ¼ ì‹œìŠ¤í…œ */
        .login-btn.secondary {
            background: linear-gradient(135deg, #64748b, #475569);
            color: white;
        }
        
        .login-btn.secondary:hover {
            background: linear-gradient(135deg, #475569, #334155);
            transform: translateY(-2px);
        }
        
        /* ğŸ”„ ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .login-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            color: #6366f1;
            font-weight: 500;
        }
        
        .login-loading i.spin {
            animation: spin 1s infinite linear;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ğŸ“¢ ë¡œê·¸ì¸ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .login-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .login-message.message-success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #047857;
            border-left: 4px solid #10b981;
        }
        
        .login-message.message-error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border-left: 4px solid #ef4444;
        }
        
        .login-message.message-info {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1d4ed8;
            border-left: 4px solid #3b82f6;
        }
        
        /* ğŸ“± ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .login-loading {
                padding: 0.75rem;
                font-size: 0.875rem;
            }
            
            .login-message {
                padding: 0.625rem 0.875rem;
                font-size: 0.8125rem;
            }
        }
    </style>
</body>
</html>