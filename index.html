<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>세종학당 문화인턴 지원 시스템</title>
    
    <!-- CSS Files - Cache Busting Added -->
    <link rel="stylesheet" href="css/main.css?v=1.3.0">
    <link rel="stylesheet" href="css/login.css?v=1.3.0">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Supabase JavaScript Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Main App Container -->
    <div id="app">
        <!-- 학생 로그인 페이지 -->
        <div id="loginPage" class="page active">
            <div class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <h1>세종학당 문화인턴 지원 시스템</h1>
                        <p>King Sejong Institute Cultural Intern Support System</p>
                        <div class="student-badge">
                            <i data-lucide="graduation-cap"></i>
                            학생 전용
                        </div>
                    </div>

                    <!-- 학생 로그인 폼 -->
                    <div id="studentLogin" class="login-form active">
                        <div class="form-group">
                            <label>이름</label>
                            <input type="text" id="studentName" placeholder="성명을 입력하세요">
                        </div>
                        <div class="form-group">
                            <label>생년월일</label>
                            <input type="date" id="studentBirth">
                        </div>
                        <button id="studentLoginBtn" class="login-btn primary">
                            <i data-lucide="user"></i>
                            학생 로그인
                        </button>
                        
                        <div class="login-help">
                            <p><i data-lucide="info"></i> 관리자는 <a href="admin.html">여기</a>에서 로그인하세요.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files - Cache Busting Added -->
    <!-- 설정 파일을 가장 먼저 로드 -->
    <script src="js/config.js?v=1.3.0"></script>
    <!-- Supabase 클라이언트 로드 -->
    <script src="js/supabase-client.js?v=1.3.0"></script>
    <script src="js/utils.js?v=1.3.0"></script>
    <script src="js/auth.js?v=1.3.0"></script>
    
    <!-- 학생 로그인 전용 스크립트 -->
    <script>
        // 페이지 로드 완료 후 초기화
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Lucide 아이콘 초기화
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                    console.log('Lucide icons initialized successfully');
                } else {
                    console.error('Lucide library not loaded');
                }

                // 기존 세션 확인
                checkExistingSession();
                
                // 학생 로그인 이벤트 설정
                setupStudentLoginEvents();
                
            } catch (error) {
                console.error('페이지 초기화 오류:', error);
            }
        });

        // 기존 세션 확인
        function checkExistingSession() {
            const studentSession = localStorage.getItem('currentStudent');
            if (studentSession) {
                try {
                    const studentData = JSON.parse(studentSession);
                    console.log('기존 세션 발견:', studentData.name);
                    
                    // 대시보드로 리다이렉트
                    window.location.href = 'student/dashboard.html';
                } catch (error) {
                    console.error('세션 데이터 파싱 오류:', error);
                    localStorage.removeItem('currentStudent');
                }
            }
        }

        // 학생 로그인 이벤트 설정
        function setupStudentLoginEvents() {
            const studentLoginBtn = document.getElementById('studentLoginBtn');
            const studentNameInput = document.getElementById('studentName');
            const studentBirthInput = document.getElementById('studentBirth');

            if (studentLoginBtn) {
                studentLoginBtn.addEventListener('click', handleStudentLogin);
            }

            // Enter 키 처리
            [studentNameInput, studentBirthInput].forEach(input => {
                if (input) {
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            handleStudentLogin();
                        }
                    });
                }
            });
        }

        // 학생 로그인 처리
        async function handleStudentLogin() {
            const name = document.getElementById('studentName').value.trim();
            const birth = document.getElementById('studentBirth').value;
            
            if (!name || !birth) {
                alert('이름과 생년월일을 모두 입력해주세요.');
                return;
            }

            try {
                // 로딩 상태 표시
                const loginBtn = document.getElementById('studentLoginBtn');
                const originalText = loginBtn.innerHTML;
                loginBtn.innerHTML = '<i data-lucide="loader-2"></i> 로그인 중...';
                loginBtn.disabled = true;

                // 기존 인증 함수 사용
                if (typeof authenticateStudent === 'function') {
                    const studentData = await authenticateStudent(name, birth);
                    
                    if (studentData) {
                        // 로그인 성공
                        console.log('학생 로그인 성공:', studentData);
                        
                        // 세션 저장
                        localStorage.setItem('currentStudent', JSON.stringify(studentData));
                        localStorage.setItem('studentSession', 'true');
                        
                        // 대시보드로 이동
                        window.location.href = 'student/dashboard.html';
                    } else {
                        throw new Error('인증 실패');
                    }
                } else {
                    // 인증 함수가 없는 경우 임시 처리
                    console.warn('authenticateStudent 함수를 찾을 수 없습니다. 임시 인증을 사용합니다.');
                    
                    const tempStudentData = {
                        name: name,
                        birth: birth,
                        institute: '세종학당',
                        field: '문화 분야',
                        loginTime: new Date().toISOString()
                    };
                    
                    localStorage.setItem('currentStudent', JSON.stringify(tempStudentData));
                    localStorage.setItem('studentSession', 'true');
                    
                    window.location.href = 'student/dashboard.html';
                }
                
            } catch (error) {
                console.error('학생 로그인 오류:', error);
                alert('로그인에 실패했습니다. 이름과 생년월일을 확인해주세요.');
                
                // 버튼 상태 복구
                const loginBtn = document.getElementById('studentLoginBtn');
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
                
                // 아이콘 재초기화
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
        }

        // 디버그 정보 (개발자용)
        function showDebugInfo() {
            console.log('=== 학생 로그인 페이지 디버그 정보 ===');
            console.log('현재 세션:', localStorage.getItem('currentStudent'));
            console.log('Supabase 연결 상태:', typeof supabase !== 'undefined');
            console.log('인증 함수 사용 가능:', typeof authenticateStudent === 'function');
        }

        // 개발자 단축키 (Ctrl + D)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                showDebugInfo();
            }
        });
    </script>
    
    <!-- Lucide 아이콘 초기화 -->
    <script>
        // 페이지 로드 완료 후 아이콘 다시 업데이트
        setTimeout(() => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }, 100);
    </script>
</body>
</html>