/**
 * üõ†Ô∏è Institute Utils Module (v4.4.0)
 * ÏÑ∏Ï¢ÖÌïôÎãπ ÌååÍ≤¨ÌïôÎãπ Ï†ïÎ≥¥ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú - Ïú†Ìã∏Î¶¨Ìã∞ Î™®Îìà
 * 
 * üìã Îã¥Îãπ Í∏∞Îä•:
 * - ÌïôÎãπ Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò Î∞è Ìè¨Îß∑ÌåÖ
 * - Ìó¨Ìçº Ìï®ÏàòÎì§
 * - ÌïôÎãπ Í¥ÄÎ†® Í≥ÑÏÇ∞ Î∞è Ï≤òÎ¶¨
 * - ÌååÏùº Ï≤òÎ¶¨ Î∞è ÎÇ¥Î≥¥ÎÇ¥Í∏∞
 * - Í∏∞ÌÉÄ Í≥µÌÜµ Í∏∞Îä•Îì§
 * 
 * üîó ÏùòÏ°¥ÏÑ±: ÏóÜÏùå (ÏôÑÏ†Ñ ÎèÖÎ¶ΩÏ†Å)
 * üö´ ÎèÖÎ¶ΩÏÑ±: ÏàúÏàò Ïú†Ìã∏Î¶¨Ìã∞ Î™®Îìà
 */

class InstituteUtils {
    constructor() {
        this.initialized = false;
        
        // üìã 15Í∞ú ÌïÑÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
        this.FIELD_METADATA = {
            name_ko: { group: 'basic', label: 'ÌïôÎãπÎ™Ö', icon: 'building2', exportable: true },
            name_en: { group: 'basic', label: 'ÏòÅÎ¨∏Î™Ö', icon: 'type', exportable: true },
            operating_organization: { group: 'basic', label: 'Ïö¥ÏòÅÍ∏∞Í¥Ä', icon: 'building', exportable: true },
            image_url: { group: 'basic', label: 'ÌïôÎãπÏÇ¨ÏßÑ', icon: 'image', exportable: false },
            address: { group: 'contact', label: 'Ï£ºÏÜå', icon: 'map-pin', exportable: true },
            phone: { group: 'contact', label: 'ÎåÄÌëúÏó∞ÎùΩÏ≤ò', icon: 'phone', exportable: true },
            website_sns: { group: 'contact', label: 'ÌôàÌéòÏù¥ÏßÄ/SNS', icon: 'globe', exportable: true },
            manager_name: { group: 'contact', label: 'Îã¥ÎãπÏûêÏÑ±Î™Ö', icon: 'user', exportable: true },
            manager_contact: { group: 'contact', label: 'Îã¥ÎãπÏûêÏó∞ÎùΩÏ≤ò', icon: 'mail', exportable: true },
            local_adaptation_staff: { group: 'program', label: 'ÌòÑÏßÄÏ†ÅÏùëÏ†ÑÎã¥Ïù∏Î†•', icon: 'users', exportable: true },
            cultural_program_plan: { group: 'program', label: 'Î¨∏ÌôîÏàòÏóÖÏö¥ÏòÅÍ≥ÑÌöç', icon: 'calendar', exportable: true },
            desired_courses: { group: 'program', label: 'Ìù¨ÎßùÍ∞úÏÑ§Í∞ïÏ¢å', icon: 'book', exportable: true },
            local_language_requirement: { group: 'support', label: 'ÌòÑÏßÄÏñ¥Íµ¨ÏÇ¨ÌïÑÏöîÏàòÏ§Ä', icon: 'message-circle', exportable: true },
            institute_support: { group: 'support', label: 'ÌïôÎãπÏßÄÏõêÏÇ¨Ìï≠', icon: 'heart-handshake', exportable: true },
            country_safety_info: { group: 'support', label: 'ÌååÍ≤¨Íµ≠Í∞ÄÏïàÏ†ÑÏ†ïÎ≥¥', icon: 'shield', exportable: true }
        };
        
        // üåç Íµ≠Í∞Ä/ÏßÄÏó≠ Ï†ïÎ≥¥
        this.COUNTRY_INFO = {
            'KR': { name: 'ÎåÄÌïúÎØºÍµ≠', code: 'KR', timezone: 'Asia/Seoul' },
            'CN': { name: 'Ï§ëÍµ≠', code: 'CN', timezone: 'Asia/Shanghai' },
            'JP': { name: 'ÏùºÎ≥∏', code: 'JP', timezone: 'Asia/Tokyo' },
            'US': { name: 'ÎØ∏Íµ≠', code: 'US', timezone: 'America/New_York' },
            'GB': { name: 'ÏòÅÍµ≠', code: 'GB', timezone: 'Europe/London' },
            'DE': { name: 'ÎèÖÏùº', code: 'DE', timezone: 'Europe/Berlin' },
            'FR': { name: 'ÌîÑÎûëÏä§', code: 'FR', timezone: 'Europe/Paris' },
            'AU': { name: 'Ìò∏Ï£º', code: 'AU', timezone: 'Australia/Sydney' },
            'CA': { name: 'Ï∫êÎÇòÎã§', code: 'CA', timezone: 'America/Toronto' },
            'IN': { name: 'Ïù∏ÎèÑ', code: 'IN', timezone: 'Asia/Kolkata' }
        };
        
        // üìä ÌïÑÎìú Í∑∏Î£π Ï†ïÏùò
        this.FIELD_GROUPS = {
            basic: { name: 'Í∏∞Î≥∏ Ï†ïÎ≥¥', icon: 'info', priority: 1 },
            contact: { name: 'Ïó∞ÎùΩÏ≤ò Ï†ïÎ≥¥', icon: 'phone', priority: 2 },
            program: { name: 'ÌîÑÎ°úÍ∑∏Îû® Ï†ïÎ≥¥', icon: 'graduation-cap', priority: 3 },
            support: { name: 'ÏßÄÏõê Ï†ïÎ≥¥', icon: 'help-circle', priority: 4 }
        };
        
        // üé® ÏÉÅÌÉú ÏÉâÏÉÅ Îß§Ìïë
        this.STATUS_COLORS = {
            active: '#22c55e',      // ÌôúÏÑ±
            inactive: '#ef4444',    // ÎπÑÌôúÏÑ±
            pending: '#f59e0b',     // ÎåÄÍ∏∞
            maintenance: '#6b7280'  // Ï†êÍ≤Ä
        };
        
        console.log('üõ†Ô∏è InstituteUtils Î™®Îìà Ï¥àÍ∏∞ÌôîÎê®');
    }

    /**
     * üöÄ Ïú†Ìã∏Î¶¨Ìã∞ Î™®Îìà Ï¥àÍ∏∞Ìôî
     * @returns {boolean}
     */
    initialize() {
        if (this.initialized) return true;
        
        try {
            console.log('üîÑ InstituteUtils Ï¥àÍ∏∞Ìôî ÏãúÏûë...');
            
            // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò Î¨¥Í≤∞ÏÑ± Ï≤¥ÌÅ¨
            this.validateUtilities();
            
            this.initialized = true;
            console.log('‚úÖ InstituteUtils Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
            return true;
            
        } catch (error) {
            console.error('‚ùå InstituteUtils Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
            return false;
        }
    }

    /**
     * üîç Ïú†Ìã∏Î¶¨Ìã∞ Î¨¥Í≤∞ÏÑ± Ï≤¥ÌÅ¨
     */
    validateUtilities() {
        const expectedFieldCount = 15;
        const actualFieldCount = Object.keys(this.FIELD_METADATA).length;
        
        if (actualFieldCount !== expectedFieldCount) {
            console.warn(`‚ö†Ô∏è ÌïÑÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Î∂àÏùºÏπò: ÏòàÏÉÅ ${expectedFieldCount}Í∞ú, Ïã§Ï†ú ${actualFieldCount}Í∞ú`);
        }
        
        console.log(`‚úÖ ${actualFieldCount}Í∞ú ÌïÑÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ ÌôïÏù∏ ÏôÑÎ£å`);
    }

    /**
     * üé® Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ
     */

    /**
     * üì± Ï†ÑÌôîÎ≤àÌò∏ Ìè¨Îß∑ÌåÖ
     * @param {string} phone - ÏõêÎ≥∏ Ï†ÑÌôîÎ≤àÌò∏
     * @param {string} format - Ìè¨Îß∑ ÌÉÄÏûÖ ('display', 'international', 'national')
     * @returns {string}
     */
    formatPhone(phone, format = 'display') {
        if (!phone || typeof phone !== 'string') return '';
        
        // Ïà´ÏûêÎßå Ï∂îÏ∂ú
        const digits = phone.replace(/[^\d]/g, '');
        
        switch (format) {
            case 'international':
                if (digits.startsWith('82')) {
                    return `+82-${digits.slice(2, 4)}-${digits.slice(4, 8)}-${digits.slice(8)}`;
                }
                return `+${digits}`;
                
            case 'national':
                if (digits.startsWith('82')) {
                    return `0${digits.slice(2, 4)}-${digits.slice(4, 8)}-${digits.slice(8)}`;
                }
                return digits;
                
            case 'display':
            default:
                if (digits.length === 11 && digits.startsWith('010')) {
                    return `${digits.slice(0, 3)}-${digits.slice(3, 7)}-${digits.slice(7)}`;
                } else if (digits.length === 10) {
                    return `${digits.slice(0, 3)}-${digits.slice(3, 6)}-${digits.slice(6)}`;
                }
                return phone;
        }
    }

    /**
     * üåê URL Ìè¨Îß∑ÌåÖ Î∞è Í≤ÄÏ¶ù
     * @param {string} url - ÏõêÎ≥∏ URL
     * @param {string} type - URL ÌÉÄÏûÖ ('website', 'social')
     * @returns {Object}
     */
    formatURL(url, type = 'website') {
        if (!url || typeof url !== 'string') {
            return { formatted: '', isValid: false, type: 'unknown' };
        }
        
        let formatted = url.trim();
        
        // ÌîÑÎ°úÌÜ†ÏΩú Ï∂îÍ∞Ä
        if (!formatted.startsWith('http://') && !formatted.startsWith('https://')) {
            formatted = 'https://' + formatted;
        }
        
        try {
            const urlObj = new URL(formatted);
            const hostname = urlObj.hostname.toLowerCase();
            
            // ÏÜåÏÖúÎØ∏ÎîîÏñ¥ ÌîåÎû´Ìèº Í∞êÏßÄ
            const socialPlatforms = {
                'facebook.com': 'Facebook',
                'twitter.com': 'Twitter',
                'instagram.com': 'Instagram',
                'youtube.com': 'YouTube',
                'linkedin.com': 'LinkedIn',
                'weibo.com': 'Weibo',
                'wechat.com': 'WeChat'
            };
            
            const platform = Object.keys(socialPlatforms).find(domain => 
                hostname.includes(domain)) || 'website';
            
            return {
                formatted: formatted,
                isValid: true,
                type: socialPlatforms[platform] || 'website',
                hostname: hostname,
                display: urlObj.hostname
            };
            
        } catch (error) {
            return { formatted: url, isValid: false, type: 'invalid' };
        }
    }

    /**
     * üìÖ ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
     * @param {string|Date} date - ÎÇ†Ïßú
     * @param {string} format - Ìè¨Îß∑ ('short', 'long', 'relative')
     * @param {string} locale - Î°úÏºÄÏùº
     * @returns {string}
     */
    formatDate(date, format = 'short', locale = 'ko-KR') {
        if (!date) return '';
        
        const dateObj = new Date(date);
        if (isNaN(dateObj.getTime())) return '';
        
        switch (format) {
            case 'short':
                return dateObj.toLocaleDateString(locale);
                
            case 'long':
                return dateObj.toLocaleDateString(locale, {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
            case 'relative':
                return this.getRelativeTime(dateObj, locale);
                
            case 'iso':
                return dateObj.toISOString();
                
            default:
                return dateObj.toLocaleDateString(locale);
        }
    }

    /**
     * ‚è∞ ÏÉÅÎåÄ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
     * @param {Date} date - Í∏∞Ï§Ä ÎÇ†Ïßú
     * @param {string} locale - Î°úÏºÄÏùº
     * @returns {string}
     */
    getRelativeTime(date, locale = 'ko-KR') {
        const now = new Date();
        const diffMs = now.getTime() - date.getTime();
        const diffMinutes = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMinutes / 60);
        const diffDays = Math.floor(diffHours / 24);
        
        if (diffMinutes < 1) return 'Î∞©Í∏à Ï†Ñ';
        if (diffMinutes < 60) return `${diffMinutes}Î∂Ñ Ï†Ñ`;
        if (diffHours < 24) return `${diffHours}ÏãúÍ∞Ñ Ï†Ñ`;
        if (diffDays < 7) return `${diffDays}Ïùº Ï†Ñ`;
        if (diffDays < 30) return `${Math.floor(diffDays / 7)}Ï£º Ï†Ñ`;
        if (diffDays < 365) return `${Math.floor(diffDays / 30)}Í∞úÏõî Ï†Ñ`;
        return `${Math.floor(diffDays / 365)}ÎÖÑ Ï†Ñ`;
    }

    /**
     * üè∑Ô∏è ÌÖçÏä§Ìä∏ Ï≤òÎ¶¨
     */

    /**
     * ‚úÇÔ∏è ÌÖçÏä§Ìä∏ ÏûêÎ•¥Í∏∞
     * @param {string} text - ÏõêÎ≥∏ ÌÖçÏä§Ìä∏
     * @param {number} maxLength - ÏµúÎåÄ Í∏∏Ïù¥
     * @param {string} suffix - Ï†ëÎØ∏ÏÇ¨
     * @returns {string}
     */
    truncateText(text, maxLength = 100, suffix = '...') {
        if (!text || typeof text !== 'string') return '';
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength).trim() + suffix;
    }

    /**
     * üî§ ÌÖçÏä§Ìä∏ ÏºÄÏù¥Ïä§ Î≥ÄÌôò
     * @param {string} text - ÏõêÎ≥∏ ÌÖçÏä§Ìä∏
     * @param {string} type - Î≥ÄÌôò ÌÉÄÏûÖ
     * @returns {string}
     */
    transformCase(text, type) {
        if (!text || typeof text !== 'string') return '';
        
        switch (type) {
            case 'title':
                return text.replace(/\w\S*/g, (txt) =>
                    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
            case 'sentence':
                return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
            case 'upper':
                return text.toUpperCase();
            case 'lower':
                return text.toLowerCase();
            default:
                return text;
        }
    }

    /**
     * üîç ÌÇ§ÏõåÎìú ÌïòÏù¥ÎùºÏù¥Ìä∏
     * @param {string} text - ÏõêÎ≥∏ ÌÖçÏä§Ìä∏
     * @param {string} keyword - ÌïòÏù¥ÎùºÏù¥Ìä∏Ìï† ÌÇ§ÏõåÎìú
     * @param {string} className - CSS ÌÅ¥ÎûòÏä§Î™Ö
     * @returns {string}
     */
    highlightKeyword(text, keyword, className = 'highlight') {
        if (!text || !keyword) return text;
        
        const regex = new RegExp(`(${this.escapeRegex(keyword)})`, 'gi');
        return text.replace(regex, `<span class="${className}">$1</span>`);
    }

    /**
     * üõ°Ô∏è Ï†ïÍ∑úÏãù Ïù¥Ïä§ÏºÄÏù¥ÌîÑ
     * @param {string} string - Ïù¥Ïä§ÏºÄÏù¥ÌîÑÌï† Î¨∏ÏûêÏó¥
     * @returns {string}
     */
    escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    /**
     * üìä Îç∞Ïù¥ÌÑ∞ Î≥ÄÌôò
     */

    /**
     * üîÑ ÌïôÎãπ Îç∞Ïù¥ÌÑ∞ Ï†ïÍ∑úÌôî
     * @param {Object} rawData - ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞
     * @returns {Object}
     */
    normalizeInstituteData(rawData) {
        if (!rawData || typeof rawData !== 'object') return {};
        
        const normalized = {};
        
        for (const [key, value] of Object.entries(rawData)) {
            if (this.FIELD_METADATA[key]) {
                normalized[key] = this.normalizeFieldValue(key, value);
            }
        }
        
        return normalized;
    }

    /**
     * üéØ ÌïÑÎìúÍ∞í Ï†ïÍ∑úÌôî
     * @param {string} fieldName - ÌïÑÎìúÎ™Ö
     * @param {*} value - ÏõêÎ≥∏ Í∞í
     * @returns {*}
     */
    normalizeFieldValue(fieldName, value) {
        if (value === null || value === undefined) return null;
        
        const metadata = this.FIELD_METADATA[fieldName];
        if (!metadata) return value;
        
        switch (fieldName) {
            case 'phone':
            case 'manager_contact':
                return typeof value === 'string' ? value.trim() : value;
                
            case 'website_sns':
            case 'image_url':
                const urlResult = this.formatURL(value);
                return urlResult.isValid ? urlResult.formatted : value;
                
            case 'name_ko':
            case 'name_en':
            case 'operating_organization':
            case 'manager_name':
                return typeof value === 'string' ? this.transformCase(value.trim(), 'title') : value;
                
            default:
                return typeof value === 'string' ? value.trim() : value;
        }
    }

    /**
     * üèóÔ∏è ÌëúÏãúÏö© Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
     * @param {Object} instituteData - ÌïôÎãπ Îç∞Ïù¥ÌÑ∞
     * @returns {Object}
     */
    createDisplayData(instituteData) {
        if (!instituteData) return {};
        
        const display = { ...instituteData };
        
        // Ï†ÑÌôîÎ≤àÌò∏ Ìè¨Îß∑ÌåÖ
        if (display.phone) {
            display.phone_formatted = this.formatPhone(display.phone);
        }
        
        if (display.manager_contact) {
            display.manager_contact_formatted = this.formatPhone(display.manager_contact);
        }
        
        // URL Ìè¨Îß∑ÌåÖ
        if (display.website_sns) {
            const urlInfo = this.formatURL(display.website_sns);
            display.website_info = urlInfo;
        }
        
        // ÎÇ†Ïßú Ìè¨Îß∑ÌåÖ
        if (display.created_at) {
            display.created_at_formatted = this.formatDate(display.created_at, 'long');
            display.created_at_relative = this.formatDate(display.created_at, 'relative');
        }
        
        if (display.updated_at) {
            display.updated_at_formatted = this.formatDate(display.updated_at, 'long');
            display.updated_at_relative = this.formatDate(display.updated_at, 'relative');
        }
        
        // ÌïÑÎìú Í∑∏Î£πÎ≥Ñ Î∂ÑÎ•ò
        display.grouped_fields = this.groupFieldsByCategory(display);
        
        return display;
    }

    /**
     * üìÅ ÌïÑÎìú Í∑∏Î£πÎ≥Ñ Î∂ÑÎ•ò
     * @param {Object} data - ÌïôÎãπ Îç∞Ïù¥ÌÑ∞
     * @returns {Object}
     */
    groupFieldsByCategory(data) {
        const grouped = {};
        
        for (const groupKey of Object.keys(this.FIELD_GROUPS)) {
            grouped[groupKey] = {
                ...this.FIELD_GROUPS[groupKey],
                fields: []
            };
        }
        
        for (const [fieldName, value] of Object.entries(data)) {
            const metadata = this.FIELD_METADATA[fieldName];
            if (metadata && value) {
                grouped[metadata.group].fields.push({
                    name: fieldName,
                    label: metadata.label,
                    icon: metadata.icon,
                    value: value
                });
            }
        }
        
        return grouped;
    }

    /**
     * üì§ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞
     */

    /**
     * üìä Excel Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
     * @param {Array} institutes - ÌïôÎãπ Î™©Î°ù
     * @param {Array} includeFields - Ìè¨Ìï®Ìï† ÌïÑÎìú Î™©Î°ù
     * @returns {Array}
     */
    createExcelData(institutes, includeFields = null) {
        if (!Array.isArray(institutes)) return [];
        
        const fields = includeFields || Object.keys(this.FIELD_METADATA).filter(
            field => this.FIELD_METADATA[field].exportable
        );
        
        // Ìó§Îçî Ìñâ
        const headers = fields.map(field => this.FIELD_METADATA[field]?.label || field);
        
        // Îç∞Ïù¥ÌÑ∞ ÌñâÎì§
        const rows = institutes.map(institute => {
            return fields.map(field => {
                const value = institute[field];
                
                // ÌäπÎ≥Ñ Ï≤òÎ¶¨Í∞Ä ÌïÑÏöîÌïú ÌïÑÎìúÎì§
                switch (field) {
                    case 'phone':
                    case 'manager_contact':
                        return this.formatPhone(value, 'display');
                    case 'website_sns':
                        const urlInfo = this.formatURL(value);
                        return urlInfo.isValid ? urlInfo.formatted : value || '';
                    case 'created_at':
                    case 'updated_at':
                        return this.formatDate(value, 'short');
                    default:
                        return value || '';
                }
            });
        });
        
        return [headers, ...rows];
    }

    /**
     * üìÑ CSV Î¨∏ÏûêÏó¥ ÏÉùÏÑ±
     * @param {Array} institutes - ÌïôÎãπ Î™©Î°ù
     * @param {Array} includeFields - Ìè¨Ìï®Ìï† ÌïÑÎìú Î™©Î°ù
     * @returns {string}
     */
    createCSVString(institutes, includeFields = null) {
        const data = this.createExcelData(institutes, includeFields);
        
        return data.map(row => 
            row.map(cell => `"${String(cell).replace(/"/g, '""')}"`)
               .join(',')
        ).join('\n');
    }

    /**
     * üìã JSON Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± (Íµ¨Ï°∞Ìôî)
     * @param {Array} institutes - ÌïôÎãπ Î™©Î°ù
     * @param {Object} options - ÏòµÏÖò
     * @returns {Object}
     */
    createStructuredJSON(institutes, options = {}) {
        const {
            includeMetadata = true,
            groupByCategory = false,
            includeStats = true
        } = options;
        
        const result = {
            data: institutes.map(institute => this.createDisplayData(institute))
        };
        
        if (includeMetadata) {
            result.metadata = {
                export_date: new Date().toISOString(),
                total_count: institutes.length,
                field_definitions: this.FIELD_METADATA,
                field_groups: this.FIELD_GROUPS
            };
        }
        
        if (includeStats) {
            result.statistics = this.generateInstituteStats(institutes);
        }
        
        if (groupByCategory) {
            result.grouped_data = this.groupInstitutesByCategory(institutes);
        }
        
        return result;
    }

    /**
     * üìä ÌïôÎãπ ÌÜµÍ≥Ñ ÏÉùÏÑ±
     * @param {Array} institutes - ÌïôÎãπ Î™©Î°ù
     * @returns {Object}
     */
    generateInstituteStats(institutes) {
        if (!Array.isArray(institutes)) return {};
        
        const stats = {
            total_count: institutes.length,
            field_completion: {},
            country_distribution: {},
            organization_distribution: {}
        };
        
        // ÌïÑÎìú ÏôÑÏÑ±ÎèÑ
        Object.keys(this.FIELD_METADATA).forEach(field => {
            const completed = institutes.filter(inst => 
                inst[field] && inst[field].toString().trim() !== ''
            ).length;
            stats.field_completion[field] = {
                completed: completed,
                total: institutes.length,
                percentage: institutes.length > 0 ? (completed / institutes.length * 100).toFixed(1) : 0
            };
        });
        
        // Ïö¥ÏòÅÍ∏∞Í¥ÄÎ≥Ñ Î∂ÑÌè¨
        institutes.forEach(institute => {
            const org = institute.operating_organization || 'ÎØ∏ÏßÄÏ†ï';
            stats.organization_distribution[org] = (stats.organization_distribution[org] || 0) + 1;
        });
        
        return stats;
    }

    /**
     * üîß Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
     */

    /**
     * üé® ÏÉÅÌÉú ÏÉâÏÉÅ Í∞ÄÏ†∏Ïò§Í∏∞
     * @param {string} status - ÏÉÅÌÉú
     * @returns {string}
     */
    getStatusColor(status) {
        return this.STATUS_COLORS[status] || '#6b7280';
    }

    /**
     * üåç Íµ≠Í∞Ä Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     * @param {string} countryCode - Íµ≠Í∞Ä ÏΩîÎìú
     * @returns {Object|null}
     */
    getCountryInfo(countryCode) {
        return this.COUNTRY_INFO[countryCode] || null;
    }

    /**
     * üè∑Ô∏è ÌïÑÎìú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
     * @param {string} fieldName - ÌïÑÎìúÎ™Ö
     * @returns {Object|null}
     */
    getFieldMetadata(fieldName) {
        return this.FIELD_METADATA[fieldName] || null;
    }

    /**
     * üìÅ ÌïÑÎìú Í∑∏Î£π Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
     * @param {string} groupKey - Í∑∏Î£π ÌÇ§
     * @returns {Object|null}
     */
    getFieldGroup(groupKey) {
        return this.FIELD_GROUPS[groupKey] || null;
    }

    /**
     * üî¢ ÏïàÏ†ÑÌïú Ïà´Ïûê Î≥ÄÌôò
     * @param {*} value - Î≥ÄÌôòÌï† Í∞í
     * @param {number} defaultValue - Í∏∞Î≥∏Í∞í
     * @returns {number}
     */
    safeNumber(value, defaultValue = 0) {
        const num = Number(value);
        return isNaN(num) ? defaultValue : num;
    }

    /**
     * üî§ ÏïàÏ†ÑÌïú Î¨∏ÏûêÏó¥ Î≥ÄÌôò
     * @param {*} value - Î≥ÄÌôòÌï† Í∞í
     * @param {string} defaultValue - Í∏∞Î≥∏Í∞í
     * @returns {string}
     */
    safeString(value, defaultValue = '') {
        if (value === null || value === undefined) return defaultValue;
        return String(value);
    }

    /**
     * üéØ ÍπäÏùÄ Î≥µÏÇ¨
     * @param {*} obj - Î≥µÏÇ¨Ìï† Í∞ùÏ≤¥
     * @returns {*}
     */
    deepClone(obj) {
        if (obj === null || typeof obj !== 'object') return obj;
        if (obj instanceof Date) return new Date(obj);
        if (obj instanceof Array) return obj.map(item => this.deepClone(item));
        if (typeof obj === 'object') {
            const cloned = {};
            for (const key in obj) {
                if (obj.hasOwnProperty(key)) {
                    cloned[key] = this.deepClone(obj[key]);
                }
            }
            return cloned;
        }
        return obj;
    }

    /**
     * üîç Í∞ùÏ≤¥ ÎπÑÍµê
     * @param {Object} obj1 - Ï≤´ Î≤àÏß∏ Í∞ùÏ≤¥
     * @param {Object} obj2 - Îëê Î≤àÏß∏ Í∞ùÏ≤¥
     * @returns {boolean}
     */
    deepEqual(obj1, obj2) {
        if (obj1 === obj2) return true;
        if (obj1 == null || obj2 == null) return false;
        if (typeof obj1 !== typeof obj2) return false;
        
        if (typeof obj1 === 'object') {
            const keys1 = Object.keys(obj1);
            const keys2 = Object.keys(obj2);
            
            if (keys1.length !== keys2.length) return false;
            
            for (const key of keys1) {
                if (!keys2.includes(key) || !this.deepEqual(obj1[key], obj2[key])) {
                    return false;
                }
            }
            return true;
        }
        
        return false;
    }

    /**
     * üìä Ïú†Ìã∏Î¶¨Ìã∞ Î™®Îìà ÏÉÅÌÉú
     */
    getUtilsStatus() {
        return {
            initialized: this.initialized,
            supported_fields: Object.keys(this.FIELD_METADATA).length,
            field_groups: Object.keys(this.FIELD_GROUPS).length,
            supported_countries: Object.keys(this.COUNTRY_INFO).length,
            module_version: '4.4.0'
        };
    }

    /**
     * üéØ ÏßÄÏõêÎêòÎäî ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÌòïÏãù
     */
    getSupportedExportFormats() {
        return ['excel', 'csv', 'json', 'structured_json'];
    }

    /**
     * üìã Ï†ÑÏ≤¥ ÌïÑÎìú Î™©Î°ù
     */
    getAllFields() {
        return Object.keys(this.FIELD_METADATA);
    }

    /**
     * üì§ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Í∞ÄÎä•Ìïú ÌïÑÎìú Î™©Î°ù
     */
    getExportableFields() {
        return Object.keys(this.FIELD_METADATA).filter(
            field => this.FIELD_METADATA[field].exportable
        );
    }
}

// üåê Ï†ÑÏó≠ Ïù∏Ïä§ÌÑ¥Ïä§ ÏÉùÏÑ±
window.InstituteUtils = new InstituteUtils();

console.log('üõ†Ô∏è InstituteUtils Î™®Îìà Î°úÎìú ÏôÑÎ£å (v4.4.0) - 15Í∞ú ÌïÑÎìú ÏßÄÏõê');
